
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Scala と Java で学ぶ関数型プログラミング">
      
      
        <meta name="author" content="Project Team">
      
      
      
        <link rel="prev" href="../part-4/">
      
      
        <link rel="next" href="../part-6/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Part V - 並行処理 - Grokking Functional Programming</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#part-v" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Grokking Functional Programming" class="md-header__button md-logo" aria-label="Grokking Functional Programming" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Grokking Functional Programming
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Part V - 並行処理
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/grokkingfp-excersice" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    grokkingfp-excersice
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  Scala

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../java/" class="md-tabs__link">
          
  
  
  Java

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Grokking Functional Programming" class="md-nav__button md-logo" aria-label="Grokking Functional Programming" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Grokking Functional Programming
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/grokkingfp-excersice" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    grokkingfp-excersice
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Scala
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Scala
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO と副作用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      
        第10章: 並行・並列処理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第10章: 並行・並列処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 並行処理の課題
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 チェックインのリアルタイム集計
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.2 チェックインのリアルタイム集計">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        トップ3都市の計算（純粋関数）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.3 逐次処理の問題
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#104-ref-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.4 Ref - アトミックな共有状態
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.4 Ref - アトミックな共有状態">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ref" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ref の主要メソッド
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#105-parsequence-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.5 parSequence - 並列実行
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.5 parSequence - 並列実行">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        スリープを使った比較
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#106" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.6 サイコロを並行して振る
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.6 サイコロを並行して振る">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ref-parsequence" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ref と parSequence の組み合わせ
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#107" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.7 チェックイン処理の並行版
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.7 チェックイン処理の並行版">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        チェックインの保存
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        ランキングの継続的な更新
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        完全な並行処理版
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#108-fiber-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.8 Fiber - 軽量スレッド
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.8 Fiber - 軽量スレッド">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fiber" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fiber の起動とキャンセル
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#109" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.9 呼び出し元に制御を返す
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.9 呼び出し元に制御を返す">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用例
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1010-iosleep-vs-threadsleep" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.10 IO.sleep vs Thread.sleep
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        まとめ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="まとめ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-v_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part V で学んだこと
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        主要コンポーネント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        キーポイント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        設計パターン
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        次のステップ
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        演習問題
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="演習問題">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-ref" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 1: Ref の基本
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 2: 並列実行
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 3: 並行カウント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 4: タイムアウト付き実行
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 5: 並行マップ更新
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Java
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Java
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO と副作用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="part-v">Part V: 並行処理<a class="headerlink" href="#part-v" title="Permanent link">&para;</a></h1>
<p>本章では、関数型プログラミングにおける並行処理を学びます。Fiber による軽量スレッド、Ref による安全な共有状態管理、そして並行プログラムの構築方法を習得します。</p>
<hr />
<h2 id="10">第10章: 並行・並列処理<a class="headerlink" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="101">10.1 並行処理の課題<a class="headerlink" href="#101" title="Permanent link">&para;</a></h3>
<p>従来の並行処理には多くの課題があります:</p>
<ul>
<li>デッドロック</li>
<li>競合状態（Race Condition）</li>
<li>共有状態の管理の複雑さ</li>
<li>スレッドのオーバーヘッド</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQyN3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODY3cHg7aGVpZ2h0OjQyN3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDg2NyA0MjciIHdpZHRoPSI4NjdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl8uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjQwOS44OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijg0OSIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzNjYuNTAwMyIgeT0iMjYuOTk1MSI+JiMyNDQ2NzsmIzI2NDY5OyYjMTIzOTg7JiMyMDAwNjsmIzM0ODkyOyYjMjA5NjY7JiMyOTcwMjsmIzEyMzk4OyYjMjE4Mzk7JiMzODk4ODs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHByb2JsZW1zLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwcm9ibGVtcyIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX3Byb2JsZW1zIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyNS41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjMxMyIgeD0iNDQiIHk9IjYzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI3Ljk5OTkiIHg9IjE4Ni41MDAxIiB5PSI3Ny45OTUxIj4mIzIxODM5OyYjMzg5ODg7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBzb2x1dGlvbnMtLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InNvbHV0aW9ucyIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iY2x1c3Rlcl9zb2x1dGlvbnMiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMTkwLjU5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNDMyIiB4PSIzOTciIHk9IjE5OS4zIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjU2NC4wMDAyIiB5PSIyMTQuMjk1MSI+JiMzODMwNjsmIzI1OTY4OyYjMjI0MTE7JiMxMjM5ODsmIzM1Mjk5OyYjMjc3NzA7JiMzMTU3NDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJlbnRpdHlfLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMDMuOTk5NiIgeD0iNzUiIHk9IjEwNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjk5OTYiIHg9Ijg1IiB5PSIxMjEuOTk1MSI+JiMxMjQ4NzsmIzEyNDgzOyYjMTI0ODk7JiMxMjUyNTsmIzEyNDgzOyYjMTI0NjM7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNzUuOTk5OCIgeD0iMjE0IiB5PSIxMDYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIyMjQiIHk9IjEyMS45OTUxIj4mIzMxNDc4OyYjMjE1MTI7JiMyOTM2NjsmIzI0OTA3OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5Xy4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExNy45OTk2IiB4PSI2OCIgeT0iMjQyLjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSI3OCIgeT0iMjU4LjI5NTEiPiYjMjE0ODc7JiMyMjc5MzsmIzI5MzY2OyYjMjQ5MDc7JiMxMjM5ODsmIzIwODQ5OyYjMjYzNzc7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjgiIGRhdGEtdWlkPSJlbnQwMDA3IiBpZD0iZW50aXR5Xy4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTAzLjk5OTYiIHg9IjIyMSIgeT0iMjQyLjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSIyMzEiIHk9IjI1OC4yOTUxIj4mIzEyNDczOyYjMTI1MjQ7JiMxMjQ4MzsmIzEyNDg5OyYjMzE2NDk7JiMyOTcwMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDkiIGlkPSJlbnRpdHlfLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTU5Ljk5OTQiIHg9IjQyMSIgeT0iMjQyLjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzkuOTk5NCIgeD0iNDMxIiB5PSIyNTguMjk1MSI+JiMxMjQ1MjsmIzEyNTExOyYjMTI1MTc7JiMxMjU0MDsmIzEyNDc5OyYjMTI1MDI7JiMxMjUyMzsmIzEyNDg3OyYjMTI1NDA7JiMxMjQ3OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVmPz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlJlZi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTMiIGRhdGEtdWlkPSJlbnQwMDEwIiBpZD0iZW50aXR5X1JlZi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTY5LjI2OSIgeD0iNjE2LjM3IiB5PSIyNDIuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0OS4yNjkiIHg9IjYyNi4zNyIgeT0iMjU4LjI5NTEiPlJlZiYjNjUyODg7JiMxMjQ1MDsmIzEyNDg4OyYjMTI1MTE7JiMxMjQ4MzsmIzEyNDYzOyYjMjE0NDI7JiMyOTAzMTsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSBGaWJlcj8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkZpYmVyLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjE0IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9GaWJlci4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNjcuMTk3OCIgeD0iNDIxLjQiIHk9IjM0My41OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0Ny4xOTc4IiB4PSI0MzEuNCIgeT0iMzU5LjU4NTEiPkZpYmVyJiM2NTI4ODsmIzM2NjA1OyYjMzczMjc7JiMxMjQ3MzsmIzEyNTI0OyYjMTI0ODM7JiMxMjQ4OTsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTUiIGRhdGEtdWlkPSJlbnQwMDEyIiBpZD0iZW50aXR5Xy4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzEuOTk5NSIgeD0iNjI0IiB5PSIzNDMuNTkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iNjM0IiB5PSIzNTkuNTg1MSI+JiMyMzQ1OTsmIzM1MzI4OyYjMzAzNDA7JiMxMjM5NDsmIzIwMDA2OyYjMzQ4OTI7JiMyMDk2NjsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWxpbmsgcHJvYmxlbXMgdG8gc29sdXRpb25zLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InByb2JsZW1zIiBkYXRhLWVudGl0eS0yPSJzb2x1dGlvbnMiIGRhdGEtc291cmNlLWxpbmU9IjE5IiBkYXRhLXVpZD0ibG5rMTMiIGlkPSJsaW5rX3Byb2JsZW1zX3NvbHV0aW9ucyI+PHBhdGggZD0iTTM1Ny40Mzg3LDExOS4yOTg2IEMzNTcuNjk4OCwxMTkuMzM0MSAzNTcuOTY0NSwxMTkuMzcwMyAzNTguMjM1OCwxMTkuNDA3MyBDMzU5LjMyMTEsMTE5LjU1NTMgMzYwLjQ5NTgsMTE5LjcxNTUgMzYxLjc1NjYsMTE5Ljg4NzUgQzM2NC4yNzgzLDEyMC4yMzE0IDM2Ny4xNDQ0LDEyMC42MjI2IDM3MC4zMjg1LDEyMS4wNTc0IEMzODMuMDY0NiwxMjIuNzk2NyA0MDAuODg3LDEyNS4yMzQ3IDQyMi4wOTQ1LDEyOC4xNDY5IEM0NjQuNTA5NywxMzMuOTcxMyA1MjAuNDY1NiwxNDEuNjkyNSA1NzYuMzUzOCwxNDkuNTE1IEM2ODguMTMsMTY1LjE2IDc5OS42MzUsMTgxLjIxIDgwMiwxODMuMyBDODA0Ljg5NSwxODUuODUyNSA4MDcuMzY3NSwxODguODAwOCA4MDkuNDc3NCwxOTIuMDExNiBDODEwLjUzMjMsMTkzLjYxNyA4MTEuNDk2NiwxOTUuMjg4IDgxMi4zNzc3LDE5Ny4wMDc5IEM4MTIuNTk3OSwxOTcuNDM3OSA4MTIuODEzLDE5Ny44NzEgODEzLjAyMywxOTguMzA2OSBDODEzLjEyOCwxOTguNTI0OCA4MTMuMjMxNywxOTguNzQzNCA4MTMuMzM0MiwxOTguOTYyNyBDODEzLjM4NTQsMTk5LjA3MjQgODEwLjkyODEsMTkzLjczMTYgODEwLjk3ODcsMTkzLjg0MTYiIGZpbGw9Im5vbmUiIGlkPSJwcm9ibGVtcy10by1zb2x1dGlvbnMiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjgxMy40ODcsMTk5LjI5MjEsODEzLjM1ODMsMTg5LjQ0NDEsODExLjM5NjgsMTk0Ljc1LDgwNi4wOTA5LDE5Mi43ODg1LDgxMy40ODcsMTk5LjI5MjEiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iNzU0LjA2IiB5PSIxNzEuMzY2OSI+JiMzODMwNjsmIzI1OTY4OyYjMjI0MTE7JiMxMjQ1MDsmIzEyNTAzOyYjMTI1MjU7JiMxMjU0MDsmIzEyNDgxOzwvdGV4dD48L2c+PCEtLVNSQz1bTFAxOUppRDA0NE50RUtOWlZJeDBXWUs3dTBQRVEyMklDeVc5QXVJNGtwMkU4UDhaZUhXOUNTV1A0STRFc0tHQzFXdkpqRGpQdkdndWRHNWRyck5yZy1semxyS3hlYUxBQWZmUUE2S29FaXROckRBWEhlZDJsd18zLW51UV9relJGXzhRdEVnQnZhTFN5Zk9weW5lQUVUYUdCdmpnYkxKcVNhd1puTWVpb0Fsd0ZiNEdCMEgwaTE1NnlpNzZvZDhZWGJGVWg4bEJRTVhVaE5oUzZWRWtsVVo5US1PYWxCRE5Hc0psMjItQnR1SmxuSzFBdmRJM1VrUXNtek9oVnYyeHFRMEpKWng0bzRzdWdjTmprNU9lYnI5V2g4bG1ZRDEzMjkzejhCVzhtdUhNYmdrUlVfSFc3aklIakg3Z1lMbXd1MHVKdmMwVWhDYnMycGNnbnhoZXlzamNFTWRFYjhaeGRVWmZKRG9VZV82U0piTVFZNnNpYXlqY1RyQXVzLUpWYkFJdUlOOEM0OG1fXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="102">10.2 チェックインのリアルタイム集計<a class="headerlink" href="#102" title="Permanent link">&para;</a></h3>
<p><strong>ソースファイル</strong>: <code>app/scala/src/main/scala/ch10_CheckIns.scala</code></p>
<p>都市へのチェックインをリアルタイムで集計し、ランキングを更新する例を見ていきます。</p>
<div class="highlight"><pre><span></span><code><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">City</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">)</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">CityStats</span><span class="p">(</span><span class="n">city</span><span class="p">:</span><span class="w"> </span><span class="nc">City</span><span class="p">,</span><span class="w"> </span><span class="n">checkIns</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span>

<span class="c1">// チェックインのストリーム</span>
<span class="kd">val</span><span class="w"> </span><span class="n">checkIns</span><span class="p">:</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">City</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nc">Stream</span><span class="p">(</span><span class="nc">City</span><span class="p">(</span><span class="s">&quot;Sydney&quot;</span><span class="p">),</span><span class="w"> </span><span class="nc">City</span><span class="p">(</span><span class="s">&quot;Dublin&quot;</span><span class="p">),</span><span class="w"> </span><span class="nc">City</span><span class="p">(</span><span class="s">&quot;Cape Town&quot;</span><span class="p">),</span><span class="w"> </span><span class="nc">City</span><span class="p">(</span><span class="s">&quot;Lima&quot;</span><span class="p">),</span><span class="w"> </span><span class="nc">City</span><span class="p">(</span><span class="s">&quot;Singapore&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">.</span><span class="n">repeatN</span><span class="p">(</span><span class="mi">100</span><span class="n">_000</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">covary</span><span class="p">[</span><span class="nc">IO</span><span class="p">]</span>
</code></pre></div>
<h4 id="3">トップ3都市の計算（純粋関数）<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">topCities</span><span class="p">(</span><span class="n">cityCheckIns</span><span class="p">:</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">City</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">]):</span><span class="w"> </span><span class="nc">List</span><span class="p">[</span><span class="nc">CityStats</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">cityCheckIns</span><span class="p">.</span><span class="n">toList</span>
<span class="w">    </span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">checkIns</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">CityStats</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">checkIns</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">.</span><span class="n">sortBy</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">checkIns</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">reverse</span>
<span class="w">    </span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="103">10.3 逐次処理の問題<a class="headerlink" href="#103" title="Permanent link">&para;</a></h3>
<p>最初の実装は逐次処理で、パフォーマンスに問題があります。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">processCheckIns</span><span class="p">(</span><span class="n">checkIns</span><span class="p">:</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">City</span><span class="p">]):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Unit</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">checkIns</span>
<span class="w">    </span><span class="p">.</span><span class="n">scan</span><span class="p">(</span><span class="nc">Map</span><span class="p">.</span><span class="n">empty</span><span class="p">[</span><span class="nc">City</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">])((</span><span class="n">cityCheckIns</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="n">cityCheckIns</span><span class="p">.</span><span class="n">updatedWith</span><span class="p">(</span><span class="n">city</span><span class="p">)(</span><span class="n">_</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="n">orElse</span><span class="p">(</span><span class="nc">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">topCities</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">foreach</span><span class="p">(</span><span class="nc">IO</span><span class="p">.</span><span class="n">println</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">compile</span>
<span class="w">    </span><span class="p">.</span><span class="n">drain</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQ3N3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MjIxcHg7aGVpZ2h0OjQ3N3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDIyMSA0NzciIHdpZHRoPSIyMjFweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl8uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjM3MS4xOCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE0NCIgeD0iNDAuNSIgeT0iMTIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iNjMuNTAwMiIgeT0iMjYuOTk1MSI+JiMzNjg4MDsmIzI3NDI1OyYjMjA5NjY7JiMyOTcwMjsmIzEyMzk4OyYjMjE4Mzk7JiMzODk4ODs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgYzEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iYzEiIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X2MxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMTIuOTA2OSIgeD0iNTYuMDUiIHk9IjQ3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTIuOTA2OSIgeD0iNjYuMDUiIHk9IjYyLjk5NTEiPiYjMTI0ODE7JiMxMjQ1NTsmIzEyNDgzOyYjMTI0NjM7JiMxMjQ1MjsmIzEyNTMxOzE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgYzItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iYzIiIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X2MyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMTIuOTA2OSIgeD0iNTYuMDUiIHk9IjE0Ni4yOSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkyLjkwNjkiIHg9IjY2LjA1IiB5PSIxNjIuMjg1MSI+JiMxMjQ4MTsmIzEyNDU1OyYjMTI0ODM7JiMxMjQ2MzsmIzEyNDUyOyYjMTI1MzE7MjwvdGV4dD48L2c+PCEtLWVudGl0eSBjMy0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJjMyIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfYzMiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExMi45MDY5IiB4PSI1Ni4wNSIgeT0iMjQ1LjU5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTIuOTA2OSIgeD0iNjYuMDUiIHk9IjI2MS41ODUxIj4mIzEyNDgxOyYjMTI0NTU7JiMxMjQ4MzsmIzEyNDYzOyYjMTI0NTI7JiMxMjUzMTszPC90ZXh0PjwvZz48IS0tZW50aXR5IGRvdHMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iZG90cyIgZGF0YS1zb3VyY2UtbGluZT0iNyIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJlbnRpdHlfZG90cyI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMzMuMzUwNiIgeD0iOTUuODIiIHk9IjM0NC44OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzLjM1MDYiIHg9IjEwNS44MiIgeT0iMzYwLjg4NTEiPi4uLjwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjEwIiBkYXRhLXNvdXJjZS1saW5lPSIxNSIgZGF0YS11aWQ9ImVudDAwMTEiIGlkPSJlbnRpdHlfR01OMTAiPjxwYXRoIGQ9Ik0xMSw0MzAuMTggTDExLDQ3MC40NDU2IEEwLDAgMCAwIDAgMTEsNDcwLjQ0NTYgTDIxNC4wMDAyLDQ3MC40NDU2IEEwLDAgMCAwIDAgMjE0LjAwMDIsNDcwLjQ0NTYgTDIxNC4wMDAyLDQ0MC4xOCBMMjA0LjAwMDIsNDMwLjE4IEwxMTYuNSw0MzAuMTggTDExMi41LDM2Ny42MiBMMTA4LjUsNDMwLjE4IEwxMSw0MzAuMTggQTAsMCAwIDAgMCAxMSw0MzAuMTgiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNMjA0LjAwMDIsNDMwLjE4IEwyMDQuMDAwMiw0NDAuMTggTDIxNC4wMDAyLDQ0MC4xOCBMMjA0LjAwMDIsNDMwLjE4IiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTgyLjAwMDIiIHg9IjE3IiB5PSI0NDcuMjQ2OSI+JiMyMTUwODsmIzEyNDgxOyYjMTI0NTU7JiMxMjQ4MzsmIzEyNDYzOyYjMTI0NTI7JiMxMjUzMTsmIzEyMzY0OyYjMjM0MzY7JiMyMDEwMjsmIzEyMzc3OyYjMTI0Mjc7JiMxMjQxNDsmIzEyMzkxOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzAuMDAwMiIgeD0iMTciIHk9IjQ2Mi4zNzk3Ij4mIzI3NDI1OyYjMTIzOTg7JiMyMDk2NjsmIzI5NzAyOyYjMTIzNjQ7JiMyMjk4NzsmIzEyNDE0OyYjMTI0MjU7JiMxMjM5NDsmIzEyMzU2OzwvdGV4dD48L2c+PCEtLWxpbmsgYzEgdG8gYzItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iYzEiIGRhdGEtZW50aXR5LTI9ImMyIiBkYXRhLXNvdXJjZS1saW5lPSI5IiBkYXRhLXVpZD0ibG5rNyIgaWQ9ImxpbmtfYzFfYzIiPjxwYXRoIGQ9Ik0xMTIuNSw2OS41NiBDMTEyLjUsODguMTkgMTEyLjUsMTIxLjAyIDExMi41LDEzOS44MSIgZmlsbD0ibm9uZSIgaWQ9ImMxLXRvLWMyIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMTIuNSwxNDUuODEsMTE2LjUsMTM2LjgxLDExMi41LDE0MC44MSwxMDguNSwxMzYuODEsMTEyLjUsMTQ1LjgxIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjYiIHg9IjExMy41IiB5PSIxMTIuMzU2OSI+JiMyNDQ1MzsmIzI3MjMxOzwvdGV4dD48L2c+PCEtLWxpbmsgYzIgdG8gYzMtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iYzIiIGRhdGEtZW50aXR5LTI9ImMzIiBkYXRhLXNvdXJjZS1saW5lPSIxMCIgZGF0YS11aWQ9ImxuazgiIGlkPSJsaW5rX2MyX2MzIj48cGF0aCBkPSJNMTEyLjUsMTY4Ljg1IEMxMTIuNSwxODcuNDggMTEyLjUsMjIwLjMyIDExMi41LDIzOS4xMSIgZmlsbD0ibm9uZSIgaWQ9ImMyLXRvLWMzIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMTIuNSwyNDUuMTEsMTE2LjUsMjM2LjExLDExMi41LDI0MC4xMSwxMDguNSwyMzYuMTEsMTEyLjUsMjQ1LjExIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjYiIHg9IjExMy41IiB5PSIyMTEuNjU2OSI+JiMyNDQ1MzsmIzI3MjMxOzwvdGV4dD48L2c+PCEtLWxpbmsgYzMgdG8gZG90cy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJjMyIgZGF0YS1lbnRpdHktMj0iZG90cyIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbms5IiBpZD0ibGlua19jM19kb3RzIj48cGF0aCBkPSJNMTEyLjUsMjY4LjE1IEMxMTIuNSwyODYuNzggMTEyLjUsMzE5LjYyIDExMi41LDMzOC40IiBmaWxsPSJub25lIiBpZD0iYzMtdG8tZG90cyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTEyLjUsMzQ0LjQsMTE2LjUsMzM1LjQsMTEyLjUsMzM5LjQsMTA4LjUsMzM1LjQsMTEyLjUsMzQ0LjQiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNiIgeD0iMTEzLjUiIHk9IjMxMC45NTY5Ij4mIzI0NDUzOyYjMjcyMzE7PC90ZXh0PjwvZz48IS0tU1JDPVtUUDJuMmk5MDM4UnRGNE5pUmc3anZrMnhyRlBHR0xsSHNxSm1oYktIMnRQblMxOTFCOGhldUVSV295SEpWMGxSQVlYOGpfM2JJcUItNGMtbURpREVvc3Z3MDV0Y1NEa2hqblhncHM1eUZ3cExQRms4bm9JRVFaNV9oWUNELSAtM09OSFNyMldKOVg4QTB2OGRhWGVBcGVRN1RHeVNlNUNvdE8xT0FyYmttRmVBa3dwYm1WVHUzUzBtaWJ3bGZFNVBHTktWdHRHaElFYVZNM3g5b2I4cnl1RzMweXBkM2NpLXZ0bU9MWF8tdElLSmc2RHFrd1F6QmFaQ0lMbjg5ZjBiYWx0ejJZNUlJRC1JS245djQyQ25wQ1RseTBXMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="104-ref-">10.4 Ref - アトミックな共有状態<a class="headerlink" href="#104-ref-" title="Permanent link">&para;</a></h3>
<p><strong>Ref</strong> は、複数の並行処理から安全にアクセスできるアトミックな参照です。</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">cats</span><span class="p">.</span><span class="nn">effect</span><span class="p">.</span><span class="nc">Ref</span>

<span class="c1">// Ref の作成と使用</span>
<span class="kd">val</span><span class="w"> </span><span class="n">example</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ref</span><span class="p">.</span><span class="n">of</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">](</span><span class="mi">0</span><span class="p">)</span><span class="w">    </span><span class="c1">// 初期値 0 の Ref を作成</span>
<span class="w">  </span><span class="n">_</span><span class="w">       </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="c1">// アトミックに更新</span>
<span class="w">  </span><span class="n">result</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="n">get</span><span class="w">            </span><span class="c1">// 現在の値を取得</span>
<span class="p">}</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="n">result</span>

<span class="n">example</span><span class="p">.</span><span class="n">unsafeRunSync</span><span class="p">()</span><span class="w">  </span><span class="c1">// 3</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI5OHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6Mzk0cHg7aGVpZ2h0OjI5OHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDM5NCAyOTgiIHdpZHRoPSIzOTRweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIFJlZiA/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9IlJlZiAuLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl9SZWYgLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI4MC44OCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjIwOCIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjczLjI0MDEiIHg9Ijc5LjM4IiB5PSIyNi45OTUxIj5SZWYgJiMxMjM5ODsmIzI1ODA1OyYjMjAzMTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IGNyZWF0ZS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJjcmVhdGUiIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X2NyZWF0ZSI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTM0LjUwODgiIHg9IjQ4Ljc1IiB5PSI0NyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNC41MDg4IiB4PSI1OC43NSIgeT0iNjIuOTk1MSI+UmVmLm9mW0lPLCBJbnRdKDApPC90ZXh0PjwvZz48IS0tZW50aXR5IHVwZGF0ZS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJ1cGRhdGUiIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X3VwZGF0ZSI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTc1LjEwNzQiIHg9IjI4LjQ1IiB5PSIxNDYuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1NS4xMDc0IiB4PSIzOC40NSIgeT0iMTYyLjI5NTEiPmNvdW50ZXIudXBkYXRlKF8gKyAzKTwvdGV4dD48L2c+PCEtLWVudGl0eSBnZXQtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iZ2V0IiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwNSIgaWQ9ImVudGl0eV9nZXQiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEwMS4zMDY2IiB4PSI2NS4zNSIgeT0iMjU0LjU4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODEuMzA2NiIgeD0iNzUuMzUiIHk9IjI3MC41NzUxIj5jb3VudGVyLmdldDwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjgiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImVudGl0eV9HTU44Ij48cGF0aCBkPSJNMjM2LjUsMjQ1LjYgTDIzNi41LDI4NS44NjU2IEEwLDAgMCAwIDAgMjM2LjUsMjg1Ljg2NTYgTDM4Ny41MDAyLDI4NS44NjU2IEEwLDAgMCAwIDAgMzg3LjUwMDIsMjg1Ljg2NTYgTDM4Ny41MDAyLDI1NS42IEwzNzcuNTAwMiwyNDUuNiBMMjgwLjA0LDI0NS42IEwxMzUuNTEsMTY5LjAzIEwyNzIuMDQsMjQ1LjYgTDIzNi41LDI0NS42IEEwLDAgMCAwIDAgMjM2LjUsMjQ1LjYiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNMzc3LjUwMDIsMjQ1LjYgTDM3Ny41MDAyLDI1NS42IEwzODcuNTAwMiwyNTUuNiBMMzc3LjUwMDIsMjQ1LjYiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjcuOTM3MSIgeD0iMjQyLjUiIHk9IjI2Mi42NjY5Ij51cGRhdGUgJiMxMjM5OTsmIzEyNDUwOyYjMTI0ODg7JiMxMjUxMTsmIzEyNDgzOyYjMTI0NjM7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzMC4wMDAyIiB4PSIyNDIuNSIgeT0iMjc3Ljc5OTciPiYjMjAxODI7JiMxMjM5ODsmIzIwOTY2OyYjMjk3MDI7JiMxMjM5MjsmIzMxNDc4OyYjMjE1MTI7JiMxMjM3NTsmIzEyMzk0OyYjMTIzNTY7PC90ZXh0PjwvZz48IS0tbGluayBjcmVhdGUgdG8gdXBkYXRlLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9ImNyZWF0ZSIgZGF0YS1lbnRpdHktMj0idXBkYXRlIiBkYXRhLXNvdXJjZS1saW5lPSI4IiBkYXRhLXVpZD0ibG5rNiIgaWQ9ImxpbmtfY3JlYXRlX3VwZGF0ZSI+PHBhdGggZD0iTTExNiw2OS41NyBDMTE2LDg4LjE5IDExNiwxMjEuMDMgMTE2LDEzOS44MiIgZmlsbD0ibm9uZSIgaWQ9ImNyZWF0ZS10by11cGRhdGUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjExNiwxNDUuODIsMTIwLDEzNi44MiwxMTYsMTQwLjgyLDExMiwxMzYuODIsMTE2LDE0NS44MiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI2IiB4PSIxMTciIHk9IjExMi4zNjY5Ij4mIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tbGluayB1cGRhdGUgdG8gZ2V0LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InVwZGF0ZSIgZGF0YS1lbnRpdHktMj0iZ2V0IiBkYXRhLXNvdXJjZS1saW5lPSI5IiBkYXRhLXVpZD0ibG5rNyIgaWQ9ImxpbmtfdXBkYXRlX2dldCI+PHBhdGggZD0iTTExNiwxNjkuMDMgQzExNiwxODkuNCAxMTYsMjI3Ljg2IDExNiwyNDguMiIgZmlsbD0ibm9uZSIgaWQ9InVwZGF0ZS10by1nZXQiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjExNiwyNTQuMiwxMjAsMjQ1LjIsMTE2LDI0OS4yLDExMiwyNDUuMiwxMTYsMjU0LjIiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNiIgeD0iMTE3IiB5PSIyMTEuNjY2OSI+JiMyNjM1NjsmIzI2MDMyOzwvdGV4dD48L2c+PCEtLVNSQz1bS29wOUlDckRMSVo4SVNwQ3UtOGdJYXFrSVNuQnBxYkxLMGZBSkxEdXRCWmtzVUpVOXRsZEEyYktTb0tkNWdNMFhWTm9xdzh6X05LS0ZGREFPWktDRDlLSzRlaUxhZWpJNHFqSWVNZ0l5cWxwSWJBQno0ZUJLZTIyNmw0QXNXaDY0NktHNEpIYndRYWJPNGFXcFNLNUNLWDFMelNFZ2JaMUlXN2VXNlNUNHhZV1Y5MEtLMmJHX0RkaUJTLWNSVTJndlVCQW9tVEE5RU1OYkVKZEFrSWRtUW8xUWRaU2tGdm5xd0I3cEhzRmMtU19SY3YtdEJJVXd5ZGtRSzJfRk1yVnpkbjJzLUY2NVN6TlJ0aXdlVURudV9KN1pRaVVEeFBtZlVRYkE4MkMxMDAwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h4 id="ref">Ref の主要メソッド<a class="headerlink" href="#ref" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>メソッド</th>
<th>説明</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ref.of[IO, A](initial)</code></td>
<td>初期値で Ref を作成</td>
<td><code>Ref.of[IO, Int](0)</code></td>
</tr>
<tr>
<td><code>ref.get</code></td>
<td>現在の値を取得</td>
<td><code>counter.get</code></td>
</tr>
<tr>
<td><code>ref.set(value)</code></td>
<td>値を設定</td>
<td><code>counter.set(10)</code></td>
</tr>
<tr>
<td><code>ref.update(f)</code></td>
<td>アトミックに更新</td>
<td><code>counter.update(_ + 1)</code></td>
</tr>
<tr>
<td><code>ref.modify(f)</code></td>
<td>更新して古い値を返す</td>
<td><code>counter.modify(n =&gt; (n + 1, n))</code></td>
</tr>
</tbody>
</table>
<h3 id="105-parsequence-">10.5 parSequence - 並列実行<a class="headerlink" href="#105-parsequence-" title="Permanent link">&para;</a></h3>
<p><code>sequence</code> は IO を順番に実行しますが、<code>parSequence</code> は並列に実行します。</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">cats</span><span class="p">.</span><span class="nn">implicits</span><span class="p">.</span><span class="n">_</span>

<span class="c1">// 順次実行</span>
<span class="kd">val</span><span class="w"> </span><span class="n">sequential</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">List</span><span class="p">[</span><span class="nc">Int</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nc">List</span><span class="p">(</span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">3</span><span class="p">)).</span><span class="n">sequence</span>

<span class="c1">// 並列実行</span>
<span class="kd">val</span><span class="w"> </span><span class="n">parallel</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">List</span><span class="p">[</span><span class="nc">Int</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nc">List</span><span class="p">(</span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">3</span><span class="p">)).</span><span class="n">parSequence</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjM1N3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6OTIzcHg7aGVpZ2h0OjM1N3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDkyMyAzNTciIHdpZHRoPSI5MjNweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIHNlcXVlbmNlIHZzIHBhclNlcXVlbmNlLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJzZXF1ZW5jZSB2cyBwYXJTZXF1ZW5jZSIgZGF0YS1zb3VyY2UtbGluZT0iMyIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJjbHVzdGVyX3NlcXVlbmNlIHZzIHBhclNlcXVlbmNlIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjMzOS43MyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjQ0MSIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIwNS40NzQ2IiB4PSIxMjkuNzYyNyIgeT0iMjYuOTk1MSI+c2VxdWVuY2UgdnMgcGFyU2VxdWVuY2U8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHNlcS0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0ic2VxIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImNsdXN0ZXJfc2VxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI1Ni43MyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE0NyIgeD0iNDQiIHk9IjYzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzMS4wNzIiIHg9IjUxLjk2NCIgeT0iNzcuOTk1MSI+c2VxdWVuY2UmIzY1Mjg4OyYjMzg5MTg7JiMyNzQyNTsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgcGFyLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwYXIiIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImNsdXN0ZXJfcGFyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE3My4wMiIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE5MCIgeD0iMjMxIiB5PSI2MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTkuMTk1MSIgeD0iMjQ2LjQwMjUiIHk9Ijc3Ljk5NTEiPnBhclNlcXVlbmNlJiM2NTI4ODsmIzIwMDA2OyYjMjEwMTU7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgczEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iczEiIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X3MxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI0NC4wNTU3IiB4PSI4NS45NyIgeT0iMTA2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjQuMDU1NyIgeD0iOTUuOTciIHk9IjEyMS45OTUxIj5JTzE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgczItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iczIiIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5X3MyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI0NC4wNTU3IiB4PSI4NS45NyIgeT0iMTg5LjcyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjQuMDU1NyIgeD0iOTUuOTciIHk9IjIwNS43MTUxIj5JTzI8L3RleHQ+PC9nPjwhLS1lbnRpdHkgczMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iczMiIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5X3MzIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI0NC4wNTU3IiB4PSI4NS45NyIgeT0iMjczLjQzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjQuMDU1NyIgeD0iOTUuOTciIHk9IjI4OS40MjUxIj5JTzM8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcDEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icDEiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV9wMSI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNDQuMDU1NyIgeD0iMjU0Ljk3IiB5PSIxMDYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNC4wNTU3IiB4PSIyNjQuOTciIHk9IjEyMS45OTUxIj5JTzE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcDItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icDIiIGRhdGEtc291cmNlLWxpbmU9IjE0IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9wMiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNDQuMDU1NyIgeD0iMzMzLjk3IiB5PSIxMDYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNC4wNTU3IiB4PSIzNDMuOTciIHk9IjEyMS45OTUxIj5JTzI8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcDMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icDMiIGRhdGEtc291cmNlLWxpbmU9IjE1IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9wMyI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNDQuMDU1NyIgeD0iMjU0Ljk3IiB5PSIxODkuNzIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNC4wNTU3IiB4PSIyNjQuOTciIHk9IjIwNS43MTUxIj5JTzM8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHTU4xMyIgZGF0YS1zb3VyY2UtbGluZT0iMjAiIGRhdGEtdWlkPSJlbnQwMDE0IiBpZD0iZW50aXR5X0dNTjEzIj48cGF0aCBkPSJNNDY5LjI2LDE4OC4zIEw0NjkuMjYsMjEzLjQzMjggTDY2Ni43NDM5LDIxMy40MzI4IEw2NjYuNzQzOSwxOTguMyBMNjU2Ljc0MzksMTg4LjMgTDQ2OS4yNiwxODguMyIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik02NTYuNzQzOSwxODguMyBMNjU2Ljc0MzksMTk4LjMgTDY2Ni43NDM5LDE5OC4zIEw2NTYuNzQzOSwxODguMyIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE3Ni40ODM5IiB4PSI0NzUuMjYiIHk9IjIwNS4zNjY5Ij4mIzIxNTEyOyYjMzUzMzY7JiMyNjE3ODsmIzM4MjkxOyA9IElPMSArIElPMiArIElPMzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjE2IiBkYXRhLXNvdXJjZS1saW5lPSIyNCIgZGF0YS11aWQ9ImVudDAwMTciIGlkPSJlbnRpdHlfR01OMTYiPjxwYXRoIGQ9Ik03MDEuOTIsMTg4LjMgTDcwMS45MiwyMTMuNDMyOCBMOTE2LjA4NTYsMjEzLjQzMjggTDkxNi4wODU2LDE5OC4zIEw5MDYuMDg1NiwxODguMyBMNzAxLjkyLDE4OC4zIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTkwNi4wODU2LDE4OC4zIEw5MDYuMDg1NiwxOTguMyBMOTE2LjA4NTYsMTk4LjMgTDkwNi4wODU2LDE4OC4zIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTkzLjE2NTYiIHg9IjcwNy45MiIgeT0iMjA1LjM2NjkiPiYjMjE1MTI7JiMzNTMzNjsmIzI2MTc4OyYjMzgyOTE7ICYjODc3NjsgbWF4KElPMSwgSU8yLCBJTzMpPC90ZXh0PjwvZz48IS0tbGluayBzMSB0byBzMi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJzMSIgZGF0YS1lbnRpdHktMj0iczIiIGRhdGEtc291cmNlLWxpbmU9IjgiIGRhdGEtdWlkPSJsbms3IiBpZD0ibGlua19zMV9zMiI+PHBhdGggZD0iTTEwOCwxMjguNSBDMTA4LDE0NC4xMyAxMDgsMTY3LjYxIDEwOCwxODMuMzQiIGZpbGw9Im5vbmUiIGlkPSJzMS10by1zMiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTA4LDE4OS4zNCwxMTIsMTgwLjM0LDEwOCwxODQuMzQsMTA0LDE4MC4zNCwxMDgsMTg5LjM0IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIHMyIHRvIHMzLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InMyIiBkYXRhLWVudGl0eS0yPSJzMyIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImxuazgiIGlkPSJsaW5rX3MyX3MzIj48cGF0aCBkPSJNMTA4LDIxMi4yMiBDMTA4LDIyNy44NSAxMDgsMjUxLjMyIDEwOCwyNjcuMDYiIGZpbGw9Im5vbmUiIGlkPSJzMi10by1zMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTA4LDI3My4wNiwxMTIsMjY0LjA2LDEwOCwyNjguMDYsMTA0LDI2NC4wNiwxMDgsMjczLjA2IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIHNlcSB0byBHTU4xMy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJzZXEiIGRhdGEtZW50aXR5LTI9IkdNTjEzIiBkYXRhLXNvdXJjZS1saW5lPSIyMCIgZGF0YS11aWQ9ImxuazE1IiBpZD0ibGlua19zZXFfR01OMTMiPjxwYXRoIGQ9Ik0xOTEuMjE5NSwxMTkuODk5NCBDMTkxLjM5ODUsMTE5LjkzNzQgMTkxLjU4MDIsMTE5Ljk3NiAxOTEuNzY0NywxMjAuMDE1MSBDMTkyLjUwMjUsMTIwLjE3MTcgMTkzLjI4MzcsMTIwLjMzNzUgMTk0LjEwNzEsMTIwLjUxMjIgQzIwMC42OTM2LDEyMS45MTAxIDIwOS45NzYzLDEyMy44ODAyIDIyMS4zMjA4LDEyNi4yODggQzI0NC4wMDk3LDEzMS4xMDM0IDI3NC45NDU2LDEzNy42Njk0IDMwOS4wNTM4LDE0NC45MDg4IEMzNzcuMjcsMTU5LjM4NzUgNDU4LjE3NSwxNzYuNTYgNTExLjE3LDE4Ny44MSIgZmlsbD0ibm9uZSIgaWQ9InNlcS1HTU4xMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjwvZz48IS0tbGluayBwYXIgdG8gR01OMTYtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0icGFyIiBkYXRhLWVudGl0eS0yPSJHTU4xNiIgZGF0YS1zb3VyY2UtbGluZT0iMjQiIGRhdGEtdWlkPSJsbmsxOCIgaWQ9ImxpbmtfcGFyX0dNTjE2Ij48cGF0aCBkPSJNNDIxLjQ1MjcsMTE5Ljg5OTQgQzQyMS42MzY4LDExOS45Mzc0IDQyMS44MjM3LDExOS45NzYgNDIyLjAxMzUsMTIwLjAxNTEgQzQyMi43NzI0LDEyMC4xNzE3IDQyMy41NzU5LDEyMC4zMzc1IDQyNC40MjI3LDEyMC41MTIyIEM0MzEuMTk3NSwxMjEuOTEwMSA0NDAuNzQ1MywxMjMuODgwMiA0NTIuNDEzOCwxMjYuMjg4IEM0NzUuNzUwNiwxMzEuMTAzNCA1MDcuNTcsMTM3LjY2OTQgNTQyLjY1MjUsMTQ0LjkwODggQzYxMi44MTc1LDE1OS4zODc1IDY5Ni4wMzUsMTc2LjU2IDc1MC41NSwxODcuODEiIGZpbGw9Im5vbmUiIGlkPSJwYXItR01OMTYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48L2c+PCEtLVNSQz1bS29wOUlDckRMSVo4SVNwQ3UtOGdJYXFrSVNuQnBxYkxLMmZFQkluRHBLakVMSVdoTFlYOEIwZzZTZktLZ2g2ZlVoLWR1LU0yamNUaDVoeFZxd2NhYTVZaTA5RzBnYW5FQjRmSEtGQnFEdUk4NlM4NVoyMDJIZDAxT3VZMENMVW5lT0FraFhyOGdqVzhtWkJjZ2FMbjZQOWhXRE8tc1I3aVFTVHFjQkwwRUduaDJ6MmpCSzJ0alcxYTFUMklsRm9JTDhNYV85QUlfNW81XzNJRzd4WVVKa1h1aVFCWnNTb2NiekNjQXpXZzBDcktxMFFJSGMzSWMyaXJCcUsxZjBqM0J6MFhnN2VWVE5PZXYyUE1RMDFEcTA0UDAyQUNEVTQ2MDAwMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h4 id="_1">スリープを使った比較<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">concurrent</span><span class="p">.</span><span class="nn">duration</span><span class="p">.</span><span class="n">_</span>

<span class="kd">val</span><span class="w"> </span><span class="n">program1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">second</span><span class="p">).</span><span class="n">flatMap</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">program2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">second</span><span class="p">).</span><span class="n">flatMap</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">program3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">second</span><span class="p">).</span><span class="n">flatMap</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="c1">// 順次実行: 約3秒</span>
<span class="nc">List</span><span class="p">(</span><span class="n">program1</span><span class="p">,</span><span class="w"> </span><span class="n">program2</span><span class="p">,</span><span class="w"> </span><span class="n">program3</span><span class="p">).</span><span class="n">sequence</span>

<span class="c1">// 並列実行: 約1秒</span>
<span class="nc">List</span><span class="p">(</span><span class="n">program1</span><span class="p">,</span><span class="w"> </span><span class="n">program2</span><span class="p">,</span><span class="w"> </span><span class="n">program3</span><span class="p">).</span><span class="n">parSequence</span>
</code></pre></div>
<h3 id="106">10.6 サイコロを並行して振る<a class="headerlink" href="#106" title="Permanent link">&para;</a></h3>
<p><strong>ソースファイル</strong>: <code>app/scala/src/main/scala/ch10_CastingDieConcurrently.scala</code></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">castTheDie</span><span class="p">():</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="n">castTheDieImpure</span><span class="p">())</span>

<span class="c1">// 2つのサイコロを並行して振り、合計を返す</span>
<span class="kd">val</span><span class="w"> </span><span class="n">program</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">_</span><span class="w">      </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="n">castTheDie</span><span class="p">(),</span><span class="w"> </span><span class="n">castTheDie</span><span class="p">()).</span><span class="n">parSequence</span>
<span class="p">}</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">sum</span>
</code></pre></div>
<h4 id="ref-parsequence">Ref と parSequence の組み合わせ<a class="headerlink" href="#ref-parsequence" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// 3つのサイコロを並行して振り、結果を Ref に保存</span>
<span class="kd">val</span><span class="w"> </span><span class="n">program</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">List</span><span class="p">[</span><span class="nc">Int</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">storedCasts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ref</span><span class="p">.</span><span class="n">of</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="p">[</span><span class="nc">Int</span><span class="p">]](</span><span class="nc">List</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span>
<span class="w">  </span><span class="n">singleCast</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">castTheDie</span><span class="p">().</span><span class="n">flatMap</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">                   </span><span class="n">storedCasts</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">appended</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
<span class="w">  </span><span class="n">_</span><span class="w">           </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">List</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">3</span><span class="p">)(</span><span class="n">singleCast</span><span class="p">).</span><span class="n">parSequence</span>
<span class="w">  </span><span class="n">casts</span><span class="w">       </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">storedCasts</span><span class="p">.</span><span class="n">get</span>
<span class="p">}</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="n">casts</span>
</code></pre></div>
<h3 id="107">10.7 チェックイン処理の並行版<a class="headerlink" href="#107" title="Permanent link">&para;</a></h3>
<p>チェックインの保存とランキングの更新を並行して実行します。</p>
<h4 id="_2">チェックインの保存<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">storeCheckIn</span><span class="p">(</span><span class="n">storedCheckIns</span><span class="p">:</span><span class="w"> </span><span class="nc">Ref</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">City</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">]])(</span><span class="n">city</span><span class="p">:</span><span class="w"> </span><span class="nc">City</span><span class="p">):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Unit</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">storedCheckIns</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">updatedWith</span><span class="p">(</span><span class="n">city</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nc">None</span><span class="w">           </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="n">checkIns</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="n">checkIns</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_3">ランキングの継続的な更新<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">updateRanking</span><span class="p">(</span>
<span class="w">    </span><span class="n">storedCheckIns</span><span class="p">:</span><span class="w"> </span><span class="nc">Ref</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">City</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">]],</span>
<span class="w">    </span><span class="n">storedRanking</span><span class="p">:</span><span class="w"> </span><span class="nc">Ref</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="p">[</span><span class="nc">CityStats</span><span class="p">]]</span>
<span class="p">):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Nothing</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">storedCheckIns</span><span class="p">.</span><span class="n">get</span>
<span class="w">    </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">topCities</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="n">storedRanking</span><span class="p">.</span><span class="n">set</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">foreverM</span><span class="w">  </span><span class="c1">// 永遠に繰り返す</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI0MnB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTMzNnB4O2hlaWdodDoyNDJweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMzM2IDI0MiIgd2lkdGg9IjEzMzZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl8uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyNC4wMSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEwOTAiIHg9IjEyIiB5PSIxMiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSI1MDguMDAwMiIgeT0iMjYuOTk1MSI+JiMyMDAwNjsmIzM0ODkyOyYjMjA5NjY7JiMyOTcwMjsmIzEyMzk4OyYjMjcwODM7JiMzNjg5Njs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIGNoZWNraW4tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9ImNoZWNraW4iIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iY2x1c3Rlcl9jaGVja2luIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjczLjMiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIzODciIHg9IjM2IiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iMTczLjUwMDIiIHk9IjY5Ljk5NTEiPiYjMTI0ODE7JiMxMjQ1NTsmIzEyNDgzOyYjMTI0NjM7JiMxMjQ1MjsmIzEyNTMxOyYjMjA5NjY7JiMyOTcwMjs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHJhbmtpbmctLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InJhbmtpbmciIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iY2x1c3Rlcl9yYW5raW5nIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE1Ny4wMSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM4NyIgeD0iNDQ3IiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSI1OTEuNTAwMiIgeT0iNjkuOTk1MSI+JiMxMjUyMTsmIzEyNTMxOyYjMTI0NjE7JiMxMjUzMTsmIzEyNDY0OyYjMjYzNTY7JiMyNjAzMjs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIG91dHB1dC0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0ib3V0cHV0IiBkYXRhLXNvdXJjZS1saW5lPSIxNSIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJjbHVzdGVyX291dHB1dCI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSI3My4zIiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMjIwIiB4PSI4NTgiIHk9IjU1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9Ijk0MC4wMDAxIiB5PSI2OS45OTUxIj4mIzIwOTg2OyYjMjExNDc7JiMyMDk2NjsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBTdHJlYW0gPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iU3RyZWFtIC4uLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0iZW50MDAwNCIgaWQ9ImVudGl0eV9TdHJlYW0gLi4uLi4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjIyOS40MTE0IiB4PSI1Mi4yOSIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMDkuNDExNCIgeD0iNjIuMjkiIHk9IjEwNS45OTUxIj5TdHJlYW0gJiMxMjM2MzsmIzEyNDI1OyYjMTI0ODE7JiMxMjQ1NTsmIzEyNDgzOyYjMTI0NjM7JiMxMjQ1MjsmIzEyNTMxOyYjMTI0MzQ7JiMyMTQ2MzsmIzIwNDQ5OzwvdGV4dD48L2c+PCEtLWVudGl0eSBSZWYgPz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlJlZiAuLi4iIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5X1JlZiAuLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijg5LjcxOTUiIHg9IjMxNy4xNCIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS43MTk1IiB4PSIzMjcuMTQiIHk9IjEwNS45OTUxIj5SZWYgJiMxMjM5NTsmIzIwNDQ1OyYjMjMzODQ7PC90ZXh0PjwvZz48IS0tZW50aXR5IFJlZiA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlJlZiAuLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfUmVmIC4uLi4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE4Ny43MTkxIiB4PSI0NjMuMTQiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTY3LjcxOTEiIHg9IjQ3My4xNCIgeT0iMTA1Ljk5NTEiPlJlZiAmIzEyMzYzOyYjMTI0MjU7JiMxMjQ4NzsmIzEyNTQwOyYjMTI0Nzk7JiMxMjQzNDsmIzM1NTAxOyYjMTI0MTU7JiMyMTQ2MjsmIzEyNDI2OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iZW50aXR5Xy4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzEuOTk5NSIgeD0iNjg2IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSI2OTYiIHk9IjEwNS45OTUxIj4mIzEyNTIxOyYjMTI1MzE7JiMxMjQ2MTsmIzEyNTMxOyYjMTI0NjQ7JiMxMjQzNDsmIzM1MzM2OyYjMzE2Mzk7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/PyBSZWYgPz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLiBSZWYgLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDkiIGlkPSJlbnRpdHlfLi4uIFJlZiAuLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEzNi4xNjk2IiB4PSI0ODguOTIiIHk9IjE3My43MSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi4xNjk2IiB4PSI0OTguOTIiIHk9IjE4OS43MDUxIj4mIzMyMDgwOyYjMjY1MjQ7JiMxMjQzNDsgUmVmICYjMTIzOTU7JiMyMDQ0NTsmIzIzMzg0OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxNiIgZGF0YS11aWQ9ImVudDAwMTEiIGlkPSJlbnRpdHlfLi4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxODcuOTk5MyIgeD0iODc0IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2Ny45OTkzIiB4PSI4ODQiIHk9IjEwNS45OTUxIj4mIzIzNDUwOyYjMjYzOTk7JiMzMDM0MDsmIzEyMzk1OyYjMTI1MjE7JiMxMjUzMTsmIzEyNDYxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyNDM0OyYjMjA5ODY7JiMyMTE0Nzs8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHTU4xMiIgZGF0YS1zb3VyY2UtbGluZT0iMjEiIGRhdGEtdWlkPSJlbnQwMDEzIiBpZD0iZW50aXR5X0dNTjEyIj48cGF0aCBkPSJNMTExOC4zNiwxNzIuMyBMMTExOC4zNiwxOTcuNDMyOCBBMCwwIDAgMCAwIDExMTguMzYsMTk3LjQzMjggTDEzMjkuNjMxMiwxOTcuNDMyOCBBMCwwIDAgMCAwIDEzMjkuNjMxMiwxOTcuNDMyOCBMMTMyOS42MzEyLDE4Mi4zIEwxMzE5LjYzMTIsMTcyLjMgTDExOTAuMjgsMTcyLjMgTDEwMDEuMjEsMTEyLjc1IEwxMTgyLjI4LDE3Mi4zIEwxMTE4LjM2LDE3Mi4zIEEwLDAgMCAwIDAgMTExOC4zNiwxNzIuMyIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0xMzE5LjYzMTIsMTcyLjMgTDEzMTkuNjMxMiwxODIuMyBMMTMyOS42MzEyLDE4Mi4zIEwxMzE5LjYzMTIsMTcyLjMiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOTAuMjcxMiIgeD0iMTEyNC4zNiIgeT0iMTg5LjM2NjkiPjMmIzEyMzg4OyYjMTIzOTg7JiMyMDk2NjsmIzI5NzAyOyYjMTIzNjQ7JiMyMDAwNjsmIzM0ODkyOyYjMTIzNzU7JiMxMjM5MDsmIzIzNDU1OyYjMzQ4OTI7JiMxMjM3MzsmIzEyNDI4OyYjMTI0Mjc7PC90ZXh0PjwvZz48IS0tU1JDPVtWUDdsSWlDbTVDTV96b2JZTnk0dHFJVWVOVG82UXBmZ3phYTRhdWhMalIwWGtDZXNkT0ZILU9WTVdHZVlHWF9jRGtyeTJ6Rk1aa2QwQm83YWRkRC1idm1qc2kwNkhrc01yWUlBT2M2VFFnSlVtYVhEdGVGYnIxREVhRk5GVzROZnRGcXdrTEZIcVJlNlIwUHkzaE9EXzFkdTNFb05LZ3lZeEgzZjNRbVZEOGJxdzlmTEctZWtqUjFjODYwa3k4akQ5XzFCcVZFSlVBaC13N1ZtbFhHXzlWNkQyQXpMdkxadkpOdWVGNjVuQmpCSFFwZk81NVhCOHY5UU5zN0JjOUJmV0ZxOUY5UWV2TUM4QjFRejBWMWsxVm9KY1Fsa3B4RjhoLVJQTXAtejdTamR6RXpnbWxhR3RUN1FIdldUc2t4R3JLOFk2Z1JaSUpPeWJHY1JvREFUUHlmS09iQUN6YW5BSktGUDFaUUpGTEk1VTZLX203bldXT1djblZxQWswVlNMSjJmZVRweDNHMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h4 id="_4">完全な並行処理版<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">processCheckIns</span><span class="p">(</span><span class="n">checkIns</span><span class="p">:</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">City</span><span class="p">]):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Unit</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">storedCheckIns</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ref</span><span class="p">.</span><span class="n">of</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">City</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">]](</span><span class="nc">Map</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span>
<span class="w">    </span><span class="n">storedRanking</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ref</span><span class="p">.</span><span class="n">of</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="p">[</span><span class="nc">CityStats</span><span class="p">]](</span><span class="nc">List</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// ランキング更新プログラム（永遠に実行）</span>
<span class="w">    </span><span class="n">rankingProgram</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">updateRanking</span><span class="p">(</span><span class="n">storedCheckIns</span><span class="p">,</span><span class="w"> </span><span class="n">storedRanking</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// チェックイン処理プログラム</span>
<span class="w">    </span><span class="n">checkInsProgram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkIns</span><span class="p">.</span><span class="n">evalMap</span><span class="p">(</span><span class="n">storeCheckIn</span><span class="p">(</span><span class="n">storedCheckIns</span><span class="p">)).</span><span class="n">compile</span><span class="p">.</span><span class="n">drain</span>

<span class="w">    </span><span class="c1">// 出力プログラム（1秒ごとにランキングを出力）</span>
<span class="w">    </span><span class="n">outputProgram</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">storedRanking</span><span class="p">.</span><span class="n">get</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="nc">IO</span><span class="p">.</span><span class="n">println</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">foreverM</span>

<span class="w">    </span><span class="c1">// 3つのプログラムを並行実行</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="n">rankingProgram</span><span class="p">,</span><span class="w"> </span><span class="n">checkInsProgram</span><span class="p">,</span><span class="w"> </span><span class="n">outputProgram</span><span class="p">).</span><span class="n">parSequence</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="108-fiber-">10.8 Fiber - 軽量スレッド<a class="headerlink" href="#108-fiber-" title="Permanent link">&para;</a></h3>
<p><strong>Fiber</strong> は、OS スレッドよりもはるかに軽量な実行単位です。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI0MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODAycHg7aGVpZ2h0OjI0MHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDgwMiAyNDAiIHdpZHRoPSI4MDJweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIFRocmVhZCB2cyBGaWJlci0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iVGhyZWFkIHZzIEZpYmVyIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfVGhyZWFkIHZzIEZpYmVyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyMi41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijc4NCIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyMy4zNzUiIHg9IjM0Mi4zMTI1IiB5PSIyNi45OTUxIj5UaHJlYWQgdnMgRmliZXI8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHRocmVhZC0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0idGhyZWFkIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImNsdXN0ZXJfdGhyZWFkIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE1NS41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjMzNSIgeD0iMzYiIHk9IjU1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgyLjI0MzIiIHg9IjE2Mi4zNzg0IiB5PSI2OS45OTUxIj5PUyBUaHJlYWQ8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIGZpYmVyLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJmaWJlciIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJlbnQwMDA3IiBpZD0iY2x1c3Rlcl9maWJlciI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIxNTUuNTkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIzNzciIHg9IjM5NSIgeT0iNTUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDAuNzgzMiIgeD0iNTYzLjEwODQiIHk9IjY5Ljk5NTEiPkZpYmVyPC90ZXh0PjwvZz48IS0tZW50aXR5ID8/P01CPz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi5NQi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5Xy4uLk1CLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTgxLjY4MyIgeD0iNTIuMTYiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTYxLjY4MyIgeD0iNjIuMTYiIHk9IjEwNS45OTUxIj4mIzM3MzI1OyYjMTIzNTY7JiM2NTI4ODtNQiYjMjEzMzY7JiMyMDMwMTsmIzEyMzk4OyYjMTI1MTM7JiMxMjUxNDsmIzEyNTIyOyYjNjUyODk7PC90ZXh0PjwvZz48IS0tZW50aXR5IE9TID8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJPUyAuLi4iIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5X09TIC4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iODYuMzU2MyIgeD0iMjY4LjgyIiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY2LjM1NjMiIHg9IjI3OC44MiIgeT0iMTA1Ljk5NTEiPk9TICYjMTIzNjQ7JiMzMTY0OTsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5Xy4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExNy45OTk2IiB4PSI4NCIgeT0iMTcyLjI5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iOTQiIHk9IjE4OC4yODUxIj4mIzI1OTY4OyYjMjEzMTU7JiMzMTI0MzsmIzI0MjMwOyYjMTIzNjQ7JiMzODQ4MDsmIzMwMDI4OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz9LQj8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uS0IuLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfLi4uS0IuLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNzguNzg0NSIgeD0iNDEwLjYxIiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1OC43ODQ1IiB4PSI0MjAuNjEiIHk9IjEwNS45OTUxIj4mIzM2NjA1OyYjMTIzNTY7JiM2NTI4ODtLQiYjMjEzMzY7JiMyMDMwMTsmIzEyMzk4OyYjMTI1MTM7JiMxMjUxNDsmIzEyNTIyOyYjNjUyODk7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDkiIGlkPSJlbnRpdHlfLi4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEzMS45OTk1IiB4PSI2MjQiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjYzNCIgeT0iMTA1Ljk5NTEiPiYjMTI1MjE7JiMxMjUzMTsmIzEyNDc5OyYjMTI0NTI7JiMxMjUxMjsmIzEyMzY0OyYjMzE2NDk7JiMyOTcwMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTMiIGRhdGEtdWlkPSJlbnQwMDEwIiBpZD0iZW50aXR5Xy4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTAzLjk5OTYiIHg9IjQ0OCIgeT0iMTcyLjI5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iNDU4IiB5PSIxODguMjg1MSI+JiMyNTk2ODsmIzMwMzM0OyYjMTk5NzU7JiMxMjQxODsmIzIxNDg3OyYjMzMwMjE7PC90ZXh0PjwvZz48IS0tU1JDPVtLb3A5SUNyRExJWjhJU3BDdS04Z0lhcWtJU25CcHFiTEswaDlBNGZESjU0ZUFyUG1vcW5BQkw5SWc0UU16R3pNVzJYR0thV2lMWVkxZ0F0Y0lhdWlJYjVHVWpkVS14WW52VnNVM2ItZGZ4cXBka201eWpPelJieHVrN2RIdS1QTHhfVHFBYTdMMEdydnREWnBWRHQydm5GUU82QkZmY3Z1c2pseVY0TnRxcnRCVzk4bFBxdnVGaEw3WVFpTW5Nckc1bTVqSldFbnUxUV9zQnFOT2g0dFZlaVZEd3p5dEJwdlNURi1ucXJCN1pTbG1FUTh2cEZ0RlRkSF9oWWZ3TWRfLVhWRFVxNGtnMEswXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h4 id="fiber">Fiber の起動とキャンセル<a class="headerlink" href="#fiber" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">program</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Unit</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Fiber を起動（バックグラウンドで実行）</span>
<span class="w">  </span><span class="n">fiber</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">.</span><span class="n">millis</span><span class="p">)</span>
<span class="w">             </span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">))</span>
<span class="w">             </span><span class="p">.</span><span class="n">foreverM</span>
<span class="w">             </span><span class="p">.</span><span class="n">start</span>

<span class="w">  </span><span class="c1">// 1秒待機</span>
<span class="w">  </span><span class="n">_</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// Fiber をキャンセル</span>
<span class="w">  </span><span class="n">_</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fiber</span><span class="p">.</span><span class="n">cancel</span>

<span class="w">  </span><span class="c1">// さらに1秒待機（hello は出力されない）</span>
<span class="w">  </span><span class="n">_</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>
<span class="p">}</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="p">()</span>
</code></pre></div>
<h3 id="109">10.9 呼び出し元に制御を返す<a class="headerlink" href="#109" title="Permanent link">&para;</a></h3>
<p>Fiber を使って、呼び出し元に制御を返しつつバックグラウンドで処理を続ける設計ができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ProcessingCheckIns</span><span class="p">(</span>
<span class="w">  </span><span class="n">currentRanking</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">List</span><span class="p">[</span><span class="nc">CityStats</span><span class="p">]],</span><span class="w">  </span><span class="c1">// 現在のランキングを取得</span>
<span class="w">  </span><span class="n">stop</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Unit</span><span class="p">]</span><span class="w">                         </span><span class="c1">// 処理を停止</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">processCheckIns</span><span class="p">(</span><span class="n">checkIns</span><span class="p">:</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">City</span><span class="p">]):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">ProcessingCheckIns</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">storedCheckIns</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ref</span><span class="p">.</span><span class="n">of</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">City</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">]](</span><span class="nc">Map</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span>
<span class="w">    </span><span class="n">storedRanking</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ref</span><span class="p">.</span><span class="n">of</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="p">[</span><span class="nc">CityStats</span><span class="p">]](</span><span class="nc">List</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span>

<span class="w">    </span><span class="n">rankingProgram</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">updateRanking</span><span class="p">(</span><span class="n">storedCheckIns</span><span class="p">,</span><span class="w"> </span><span class="n">storedRanking</span><span class="p">)</span>
<span class="w">    </span><span class="n">checkInsProgram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkIns</span><span class="p">.</span><span class="n">evalMap</span><span class="p">(</span><span class="n">storeCheckIn</span><span class="p">(</span><span class="n">storedCheckIns</span><span class="p">)).</span><span class="n">compile</span><span class="p">.</span><span class="n">drain</span>

<span class="w">    </span><span class="c1">// Fiber として起動し、すぐに戻る</span>
<span class="w">    </span><span class="n">fiber</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="n">rankingProgram</span><span class="p">,</span><span class="w"> </span><span class="n">checkInsProgram</span><span class="p">).</span><span class="n">parSequence</span><span class="p">.</span><span class="n">start</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="nc">ProcessingCheckIns</span><span class="p">(</span><span class="n">storedRanking</span><span class="p">.</span><span class="n">get</span><span class="p">,</span><span class="w"> </span><span class="n">fiber</span><span class="p">.</span><span class="n">cancel</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQzNHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NjQ4cHg7aGVpZ2h0OjQzNHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDY0OCA0MzQiIHdpZHRoPSI2NDhweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMyIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJjbHVzdGVyXy4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjQxNi4xOSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYzMCIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjI5Mi4wMDAyIiB5PSIyNi45OTUxIj4mIzIxMDQ2OyYjMjQ0ODE7JiMxMjM5ODsmIzI3OTY5OyYjMTI0Mjg7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBiZy0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iYmciIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImNsdXN0ZXJfYmciPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iODkuMyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM1MiIgeD0iMjU4IiB5PSIzMDYuODkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjM3OC4wMDAyIiB5PSIzMjEuODg1MSI+JiMxMjQ5NjsmIzEyNDgzOyYjMTI0NjM7JiMxMjQ2NDsmIzEyNTIxOyYjMTI0NTQ7JiMxMjUzMTsmIzEyNDg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSBjYWxsLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImNhbGwiIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X2NhbGwiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE5Ny45MTg3IiB4PSIxNjguMDQiIHk9IjQ3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTc3LjkxODciIHg9IjE3OC4wNCIgeT0iNjIuOTk1MSI+cHJvY2Vzc0NoZWNrSW5zICYjMjE2Mjg7JiMxMjQwMzsmIzIwOTg2OyYjMTIzNzU7PC90ZXh0PjwvZz48IS0tZW50aXR5IGluaXQtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iaW5pdCIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJlbnRpdHlfaW5pdCI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTAzLjcxOTUiIHg9IjIxNS4xNCIgeT0iMTMwLjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My43MTk1IiB4PSIyMjUuMTQiIHk9IjE0Ni4yOTUxIj5SZWYgJiMxMjM5ODsmIzIxMDIxOyYjMjYzOTk7JiMyMTI3MDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgc3RhcnQtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0ic3RhcnQiIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5X3N0YXJ0Ij48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMDEuNjQ4MyIgeD0iMjE2LjE4IiB5PSIyMTMuNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgxLjY0ODMiIHg9IjIyNi4xOCIgeT0iMjI5LjU5NTEiPkZpYmVyICYjMTIzOTg7JiMzNjIxNTsmIzIxMjA1OzwvdGV4dD48L2c+PCEtLWVudGl0eSByZXR1cm4tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icmV0dXJuIiBkYXRhLXNvdXJjZS1saW5lPSI3IiBkYXRhLXVpZD0iZW50MDAwNiIgaWQ9ImVudGl0eV9yZXR1cm4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjIwNS4xMjM4IiB4PSIyOC40NCIgeT0iMzQ5Ljg5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTg1LjEyMzgiIHg9IjM4LjQ0IiB5PSIzNjUuODg1MSI+UHJvY2Vzc2luZ0NoZWNrSW5zICYjMTI0MzQ7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWVudGl0eSBjaGVja2luLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImNoZWNraW4iIGRhdGEtc291cmNlLWxpbmU9IjE0IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9jaGVja2luIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzEuOTk5NSIgeD0iMjgyIiB5PSIzNDkuODkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iMjkyIiB5PSIzNjUuODg1MSI+JiMxMjQ4MTsmIzEyNDU1OyYjMTI0ODM7JiMxMjQ2MzsmIzEyNDUyOyYjMTI1MzE7JiMyMDk2NjsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWVudGl0eSByYW5raW5nLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9InJhbmtpbmciIGRhdGEtc291cmNlLWxpbmU9IjE1IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9yYW5raW5nIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMTcuOTk5NiIgeD0iNDQ5IiB5PSIzNDkuODkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSI0NTkiIHk9IjM2NS44ODUxIj4mIzEyNTIxOyYjMTI1MzE7JiMxMjQ2MTsmIzEyNTMxOyYjMTI0NjQ7JiMyNjM1NjsmIzI2MDMyOzwvdGV4dD48L2c+PCEtLWxpbmsgY2FsbCB0byBpbml0LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9ImNhbGwiIGRhdGEtZW50aXR5LTI9ImluaXQiIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJsbms3IiBpZD0ibGlua19jYWxsX2luaXQiPjxwYXRoIGQ9Ik0yNjcsNjkuNzggQzI2Nyw4NS4zNiAyNjcsMTA4LjI0IDI2NywxMjMuODIiIGZpbGw9Im5vbmUiIGlkPSJjYWxsLXRvLWluaXQiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjI2NywxMjkuODIsMjcxLDEyMC44MiwyNjcsMTI0LjgyLDI2MywxMjAuODIsMjY3LDEyOS44MiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBpbml0IHRvIHN0YXJ0LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9ImluaXQiIGRhdGEtZW50aXR5LTI9InN0YXJ0IiBkYXRhLXNvdXJjZS1saW5lPSIxMCIgZGF0YS11aWQ9ImxuazgiIGlkPSJsaW5rX2luaXRfc3RhcnQiPjxwYXRoIGQ9Ik0yNjcsMTUzLjA4IEMyNjcsMTY4LjY2IDI2NywxOTEuNTMgMjY3LDIwNy4xMSIgZmlsbD0ibm9uZSIgaWQ9ImluaXQtdG8tc3RhcnQiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjI2NywyMTMuMTEsMjcxLDIwNC4xMSwyNjcsMjA4LjExLDI2MywyMDQuMTEsMjY3LDIxMy4xMSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBzdGFydCB0byByZXR1cm4tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0ic3RhcnQiIGRhdGEtZW50aXR5LTI9InJldHVybiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbms5IiBpZD0ibGlua19zdGFydF9yZXR1cm4iPjxwYXRoIGQ9Ik0yNTYuMzMsMjM2LjI4IEMyMzAuOTEsMjYxLjM5IDE3MS4yNzAzLDMyMC4yODUyIDE0NS44OTAzLDM0NS4zMzUyIiBmaWxsPSJub25lIiBpZD0ic3RhcnQtdG8tcmV0dXJuIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxNDEuNjIsMzQ5LjU1LDE1MC44MzUzLDM0Ni4wNzQ3LDE0NS4xNzg2LDM0Ni4wMzc3LDE0NS4yMTU2LDM0MC4zODA5LDE0MS42MiwzNDkuNTUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS4wMDAxIiB4PSIyMjQuMDEiIHk9IjI3OC45NTY5Ij4mIzEyMzc3OyYjMTIzNjg7JiMxMjM5NTsmIzI1MTQ3OyYjMTI0Mjc7PC90ZXh0PjwvZz48IS0tbGluayBzdGFydCB0byBiZy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJzdGFydCIgZGF0YS1lbnRpdHktMj0iYmciIGRhdGEtc291cmNlLWxpbmU9IjE4IiBkYXRhLXVpZD0ibG5rMTMiIGlkPSJsaW5rX3N0YXJ0X2JnIj48cGF0aCBkPSJNMzE4LjI4LDIzNC44NyBDNDA1LjI2LDI1MC41NiA1NzMuMzMsMjgxLjgzIDU4MywyOTAuODkgQzU4NS44MTYzLDI5My41MyA1ODguMjI5MSwyOTYuNTQ0NyA1OTAuMjk0OCwyOTkuODA0NiBDNTkxLjMyNzcsMzAxLjQzNDYgNTkyLjI3MzksMzAzLjEyNTggNTkzLjE0MDMsMzA0Ljg2MjIgQzU5My4zNTY5LDMwNS4yOTYzIDU5My41Njg1LDMwNS43MzMzIDU5My43NzUzLDMwNi4xNzI3IEM1OTMuODc4NywzMDYuMzkyNSA1OTEuNDg3NywzMDEuMTU1NCA1OTEuNTg4NywzMDEuMzc2MyIgZmlsbD0ibm9uZSIgaWQ9InN0YXJ0LXRvLWJnIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSI1OTQuMDgxOCwzMDYuODMzOSw1OTMuOTgwNSwyOTYuOTg1NSw1OTIuMDA0MiwzMDIuMjg1OSw1ODYuNzAzOCwzMDAuMzA5Niw1OTQuMDgxOCwzMDYuODMzOSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjUyLjAwMDEiIHg9IjU1Ny44OSIgeT0iMjc4Ljk1NjkiPiYjMjAwMDY7JiMzNDg5MjsmIzIzNDU1OyYjMzQ4OTI7PC90ZXh0PjwvZz48IS0tU1JDPVtMUDMxSWlEMDU0TnR5bkxaemxzMUJqbThXWmxuM3dQbko4Q25iYWJTYkl2YzFjb2FNS0pISWI0ZjFPYUtpR1BnTExKcU92dUp5bmJFOWF0SHBPTjdFenB4dGJxQnNfSTB1ZXY3TjF5WEhrc0ctOHY3aVFNWVBfS3YwSnhCNW5uNFJFNGtpV2RSbkxRNzdUZXEyM1JRckR4VnlXRWlKWi0wcHJOXzNWWWJYS2MwUlU5dkl0UTd4YzVqZVFBUl83Z2l1ZzdQa3h1UkJsVVJSZWtvYVlXTUJzZm1PVFAxSTVZenR3d29ORHpQbk80dUF4eEVXT3lDcDZYdW5GSlhQSVBrRERPaHlyQkNMN2FQRE5FNXV3UUU3MDVGV0RfZHFKazhtUl9GR0lPVzlPWDc0MWQ4QU9XS3YxcGFZR2JpRVFpWUdFZll4Y2hxTGFFZ2RfdWFucks5dlJzd3FYZ1RiWHhZbU1ZTU5wdGJtd253V0ZXUVNyMEZfSmJKWHBKbnpzalFKNjhyNnNqNWxMeTBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h4 id="_5">使用例<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">program</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">List</span><span class="p">[</span><span class="nc">CityStats</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">processing</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">processCheckIns</span><span class="p">(</span><span class="n">checkIns</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 最初のランキングを取得</span>
<span class="w">  </span><span class="n">ranking</span><span class="w">    </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">processing</span><span class="p">.</span><span class="n">currentRanking</span>
<span class="w">  </span><span class="n">_</span><span class="w">          </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">ranking</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 1秒待機</span>
<span class="w">  </span><span class="n">_</span><span class="w">          </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>

<span class="w">  </span><span class="c1">// 更新されたランキングを取得</span>
<span class="w">  </span><span class="n">newRanking</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">processing</span><span class="p">.</span><span class="n">currentRanking</span>

<span class="w">  </span><span class="c1">// 処理を停止</span>
<span class="w">  </span><span class="n">_</span><span class="w">          </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">processing</span><span class="p">.</span><span class="n">stop</span>
<span class="p">}</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="n">newRanking</span>
</code></pre></div>
<h3 id="1010-iosleep-vs-threadsleep">10.10 IO.sleep vs Thread.sleep<a class="headerlink" href="#1010-iosleep-vs-threadsleep" title="Permanent link">&para;</a></h3>
<p><code>IO.sleep</code> と <code>Thread.sleep</code> は異なる動作をします。</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>IO.sleep</th>
<th>Thread.sleep</th>
</tr>
</thead>
<tbody>
<tr>
<td>ブロック対象</td>
<td>Fiber</td>
<td>OS Thread</td>
</tr>
<tr>
<td>リソース</td>
<td>軽量</td>
<td>重い</td>
</tr>
<tr>
<td>並行性</td>
<td>他の Fiber が実行可能</td>
<td>スレッドがブロック</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="c1">// Thread.sleep: スレッドをブロック</span>
<span class="kd">val</span><span class="w"> </span><span class="n">threadSleep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>

<span class="c1">// IO.sleep: Fiber をスリープ（スレッドは解放）</span>
<span class="kd">val</span><span class="w"> </span><span class="n">fiberSleep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>

<span class="c1">// シングルスレッドで3つの IO.sleep を並行実行 → 約1秒</span>
<span class="nc">List</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">3</span><span class="p">)(</span><span class="n">fiberSleep</span><span class="p">).</span><span class="n">parSequence</span>

<span class="c1">// シングルスレッドで3つの Thread.sleep を並行実行 → 約3秒</span>
<span class="nc">List</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">3</span><span class="p">)(</span><span class="n">threadSleep</span><span class="p">).</span><span class="n">parSequence</span>
</code></pre></div>
<hr />
<h2 id="_6">まとめ<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<h3 id="part-v_1">Part V で学んだこと<a class="headerlink" href="#part-v_1" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI0MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzAycHg7aGVpZ2h0OjI0MHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDcwMiAyNDAiIHdpZHRoPSI3MDJweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIFBhcnQgVjogPz8/Py0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iUGFydCBWLiAuLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfUGFydCBWLiAuLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyMi41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjY4NCIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNS40ODYxIiB4PSIyOTYuMjU3IiB5PSIyNi45OTUxIj5QYXJ0IFY6ICYjMjAwMDY7JiMzNDg5MjsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBjaDEwLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJjaDEwIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImNsdXN0ZXJfY2gxMCI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIxNTUuNTkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI2MzYiIHg9IjM2IiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0Ny40ODIzIiB4PSIzMzAuMjU4OSIgeT0iNjkuOTk1MSI+JiMzMTUzMjsxMCYjMzE0NTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IFJlZj8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSZWYuLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X1JlZi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTY5LjI2OSIgeD0iNTIuMzciIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQ5LjI2OSIgeD0iNjIuMzciIHk9IjEwNS45OTUxIj5SZWYmIzY1Mjg4OyYjMTI0NTA7JiMxMjQ4ODsmIzEyNTExOyYjMTI0ODM7JiMxMjQ2MzsmIzIxNDQyOyYjMjkwMzE7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcGFyU2VxdWVuY2U/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icGFyU2VxdWVuY2UuLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5X3BhclNlcXVlbmNlLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxOTYuMjc4IiB4PSIyNTYuODYiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTc2LjI3OCIgeD0iMjY2Ljg2IiB5PSIxMDUuOTk1MSI+cGFyU2VxdWVuY2UmIzY1Mjg4OyYjMjAwMDY7JiMyMTAxNTsmIzIzNDU1OyYjMzQ4OTI7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgRmliZXI/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJGaWJlci4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI3IiBkYXRhLXVpZD0iZW50MDAwNiIgaWQ9ImVudGl0eV9GaWJlci4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNjcuMTk3OCIgeD0iNDg4LjQiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQ3LjE5NzgiIHg9IjQ5OC40IiB5PSIxMDUuOTk1MSI+RmliZXImIzY1Mjg4OyYjMzY2MDU7JiMzNzMyNzsmIzEyNDczOyYjMTI1MjQ7JiMxMjQ4MzsmIzEyNDg5OyYjNjUyODk7PC90ZXh0PjwvZz48IS0tZW50aXR5IGZvcmV2ZXJNPz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iZm9yZXZlck0uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iOCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfZm9yZXZlck0uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTk0LjU5NjIiIHg9IjUxLjciIHk9IjE3Mi4yOSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE3NC41OTYyIiB4PSI2MS43IiB5PSIxODguMjg1MSI+Zm9yZXZlck0mIzY1Mjg4OyYjMjc3MDQ7JiMzMjE1NDsmIzMwMzQwOyYjMTIzOTQ7JiMyMzQ1NTsmIzM0ODkyOyYjNjUyODk7PC90ZXh0PjwvZz48IS0tZW50aXR5IHN0YXJ0IC8gY2FuY2VsLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9InN0YXJ0IC4gY2FuY2VsIiBkYXRhLXNvdXJjZS1saW5lPSI5IiBkYXRhLXVpZD0iZW50MDAwOCIgaWQ9ImVudGl0eV9zdGFydCAuIGNhbmNlbCI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTExLjU3NDIiIHg9IjI4MS4yMSIgeT0iMTcyLjI5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTEuNTc0MiIgeD0iMjkxLjIxIiB5PSIxODguMjg1MSI+c3RhcnQgLyBjYW5jZWw8L3RleHQ+PC9nPjwhLS1TUkM9W0tvcDlJQ3JETElaOElTcEN1LThnSWFxa0lTbkJwcWJMSzBmOEIyZkgyQkRJVUI5WnNPazVGS19SYnBzVnFBUWFLOHNpdkZjUURPTzZwclNsSzU5OEI1UDhwWjBxMDRlZDluUWJBMlc1ZlFRenR6Rm5rNmRIdS1RRW55dHA3cFN0RnN2UV94SV93TmRoeWxUeEVmTVdnV2VJWXU5SjJxakp5djlKV1FnMTVadGpjRnZxdE5vV1RLWUF0M0FKS2VrMHFZenN4dHRQdGwtdVFVVlp2WktXeXZleGFISWJ2SFViYmdLTS1HQkxGVGttdV9jc01TemRqSm5rTjhMWE03NDlvNVZ3MmljOUczanBiQlhna01lMV0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_7">主要コンポーネント<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ref[IO, A]</code></td>
<td>スレッドセーフな共有状態</td>
</tr>
<tr>
<td><code>parSequence</code></td>
<td>IO のリストを並列実行</td>
</tr>
<tr>
<td><code>Fiber</code></td>
<td>軽量な実行単位</td>
</tr>
<tr>
<td><code>fiber.start</code></td>
<td>Fiber をバックグラウンドで起動</td>
</tr>
<tr>
<td><code>fiber.cancel</code></td>
<td>Fiber をキャンセル</td>
</tr>
<tr>
<td><code>foreverM</code></td>
<td>永遠に繰り返し実行</td>
</tr>
</tbody>
</table>
<h3 id="_8">キーポイント<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Ref</strong>: 複数の並行処理から安全にアクセスできるアトミックな参照</li>
<li><strong>parSequence</strong>: IO のリストを並列実行して結果を集約</li>
<li><strong>Fiber</strong>: OS スレッドより軽量で、数百万の並行処理が可能</li>
<li><strong>start</strong>: Fiber をバックグラウンドで起動し、すぐに制御を返す</li>
<li><strong>IO.sleep</strong>: Fiber をスリープさせ、スレッドは解放する</li>
</ol>
<h3 id="_9">設計パターン<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI0MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTAzM3B4O2hlaWdodDoyNDBweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMDMzIDI0MCIgd2lkdGg9IjEwMzNweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMyIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJjbHVzdGVyXy4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyMi41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEwMTUiIHg9IjEyIiB5PSIxMiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNDQyLjUwMDMiIHk9IjI2Ljk5NTEiPiYjMjAwMDY7JiMzNDg5MjsmIzIwOTY2OyYjMjk3MDI7JiMxMjM5ODsmIzM1MzczOyYjMzUzMzY7JiMxMjQ5NzsmIzEyNDc5OyYjMTI1NDA7JiMxMjUzMTs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHAxLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwMSIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX3AxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjczLjI5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMzEzIiB4PSIzNiIgeT0iNTUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMyLjIxMzQiIHg9IjEyNi4zOTMzIiB5PSI2OS45OTUxIj4mIzEyNDk3OyYjMTI0Nzk7JiMxMjU0MDsmIzEyNTMxOzE6ICYjMjAwMDY7JiMyMTAxNTsmIzM4NTk4OyYjMzIwMDQ7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBwMi0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0icDIiIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iY2x1c3Rlcl9wMiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSI3My4yOSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM0NyIgeD0iMzczIiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzIuMjEzNCIgeD0iNDgwLjM5MzMiIHk9IjY5Ljk5NTEiPiYjMTI0OTc7JiMxMjQ3OTsmIzEyNTQwOyYjMTI1MzE7MjogJiMyMDg0OTsmIzI2Mzc3OyYjMjkzNjY7JiMyNDkwNzs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHAzLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwMyIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iY2x1c3Rlcl9wMyI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIxNTUuNTkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyNTkiIHg9Ijc0NCIgeT0iNTUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjE2LjIxMyIgeD0iNzY1LjM5MzUiIHk9IjY5Ljk5NTEiPiYjMTI0OTc7JiMxMjQ3OTsmIzEyNTQwOyYjMTI1MzE7MzogJiMxMjQ5NjsmIzEyNDgzOyYjMTI0NjM7JiMxMjQ2NDsmIzEyNTIxOyYjMTI0NTQ7JiMxMjUzMTsmIzEyNDg5OyYjMjA5NjY7JiMyOTcwMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/IElPID8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLiBJTyAuLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJlbnRpdHlfLi4uIElPIC4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNTYuMDQ4MyIgeD0iNTEuOTgiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTM2LjA0ODMiIHg9IjYxLjk4IiB5PSIxMDUuOTk1MSI+JiMzNTA3OTsmIzI1OTY4OyYjMTIzOTg7IElPICYjMTI0MzQ7JiMyMDAwNjsmIzIxMDE1OyYjMjM0NTU7JiMzNDg5Mjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5Xy4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI4OS45OTk3IiB4PSIyNDMiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMjUzIiB5PSIxMDUuOTk1MSI+JiMzMjA4MDsmIzI2NTI0OyYjMTI0MzQ7JiMzODU5ODsmIzMyMDA0OzwvdGV4dD48L2c+PCEtLWVudGl0eSBSZWYgPz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlJlZiAuLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEwIiBkYXRhLXVpZD0iZW50MDAwNyIgaWQ9ImVudGl0eV9SZWYgLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzEuNzE5NCIgeD0iMzg5LjE0IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS43MTk0IiB4PSIzOTkuMTQiIHk9IjEwNS45OTUxIj5SZWYgJiMxMjM5MTsmIzI5MzY2OyYjMjQ5MDc7JiMxMjQzNDsmIzIwODQ5OyYjMjYzNzc7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/PyBGaWJlciA/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uIEZpYmVyIC4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iZW50aXR5Xy4uLiBGaWJlciAuLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE0OC4wOTgzIiB4PSI1NTUuOTUiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI4LjA5ODMiIHg9IjU2NS45NSIgeT0iMTA1Ljk5NTEiPiYjMzUwNzk7JiMyNTk2ODsmIzEyMzk4OyBGaWJlciAmIzEyMzY0OyYjMjYzNTY7JiMyNjAzMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgRmliZXIgPz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkZpYmVyIC4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTUiIGRhdGEtdWlkPSJlbnQwMDEwIiBpZD0iZW50aXR5X0ZpYmVyIC4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTAxLjY0ODMiIHg9Ijc2MC4xOCIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4MS42NDgzIiB4PSI3NzAuMTgiIHk9IjEwNS45OTUxIj5GaWJlciAmIzEyMzkxOyYjMzYyMTU7JiMyMTIwNTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjE2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV8uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iODkuOTk5NyIgeD0iODk3IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjkwNyIgeT0iMTA1Ljk5NTEiPiYjMjEwNDY7JiMyNDQ4MTsmIzEyNDM0OyYjMzY4MjA7JiMxMjM3Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/Py8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxNyIgZGF0YS11aWQ9ImVudDAwMTIiIGlkPSJlbnRpdHlfLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTUwLjcxNjIiIHg9Ijc1OS42NCIgeT0iMTcyLjI5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMwLjcxNjIiIHg9Ijc2OS42NCIgeT0iMTg4LjI4NTEiPiYjMjQ0NjA7JiMxMjM5MTsmIzMyMDgwOyYjMjY1MjQ7JiMxMjQzNDsmIzIxNDYyOyYjMjQ0NzE7LyYjMjA1NzI7JiMyNzQ5MDs8L3RleHQ+PC9nPjwhLS1TUkM9W1ZQMzFKaTkwNDhSbFZPZm5OeTAwanB3MFlJU0p0dzNZZ1lIOElFTGNFQkdoS0FJOXJHWjRxNldtZmswMWgxN0dXb2FGQy13c2xlTEJiWk9hSGd5cF9fcFZiemNnZFQxSjJqTW9LUWZlY2FjQkRRRG9OQVAwbFp3MlBFWm9MWDF4SlJJY29OWUlaMXJhcnNXbGFOcVlVb0RtbGZkVk5FTHFhRVZTd055RmNsN2lXZTFuMWpNU3AxU0R5bjE4eWpHSXRMMk1ta3VVZTdzWmlkcHc4ODVhZE9kZGRoWnR2TjlUZVRNcmxzWHY3TlpaTFZaai03OFg2WHI1b3NVcVZOZTRROHRLS1hRZ0JGZGJpYkN3ZUFQQ2tjOG00eHRtRnM5MTFzR1VDZVJzMnplWGljVXEwcGI3cmJPRkttdzVwMjdqN1lOcFR6eGZmZDNrQjdXcWI0eDl5WFFqa3NtU2tJbFh6MEZ5Z2lVWl9aUXRWMzV2TjZkTFZtMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_10">次のステップ<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>Part VI では、以下のトピックを学びます:</p>
<ul>
<li>実践的なアプリケーション構築</li>
<li>外部 API との連携</li>
<li>テスト戦略</li>
</ul>
<hr />
<h2 id="_11">演習問題<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<h3 id="1-ref">問題 1: Ref の基本<a class="headerlink" href="#1-ref" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。カウンターを 0 から始めて、3回インクリメントした結果を返します。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">incrementThreeTimes</span><span class="p">():</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">???</span>

<span class="c1">// 期待される動作</span>
<span class="n">incrementThreeTimes</span><span class="p">().</span><span class="n">unsafeRunSync</span><span class="p">()</span><span class="w">  </span><span class="c1">// 3</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">incrementThreeTimes</span><span class="p">():</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ref</span><span class="p">.</span><span class="n">of</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">](</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">_</span><span class="w">       </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">_</span><span class="w">       </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">_</span><span class="w">       </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">result</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="n">get</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="n">result</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="2">問題 2: 並列実行<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。3つの IO を並列実行し、結果の合計を返します。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sumParallel</span><span class="p">(</span><span class="n">io1</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">],</span><span class="w"> </span><span class="n">io2</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">],</span><span class="w"> </span><span class="n">io3</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">???</span>

<span class="c1">// 期待される動作</span>
<span class="n">sumParallel</span><span class="p">(</span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">3</span><span class="p">)).</span><span class="n">unsafeRunSync</span><span class="p">()</span><span class="w">  </span><span class="c1">// 6</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">cats</span><span class="p">.</span><span class="nn">implicits</span><span class="p">.</span><span class="n">_</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sumParallel</span><span class="p">(</span><span class="n">io1</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">],</span><span class="w"> </span><span class="n">io2</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">],</span><span class="w"> </span><span class="n">io3</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nc">List</span><span class="p">(</span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">io2</span><span class="p">,</span><span class="w"> </span><span class="n">io3</span><span class="p">).</span><span class="n">parSequence</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">sum</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="3_1">問題 3: 並行カウント<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。100個の IO を並行実行し、そのうち偶数を返した回数をカウントします。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">countEvens</span><span class="p">(</span><span class="n">ios</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">[</span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]]):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">???</span>

<span class="c1">// 使用例</span>
<span class="kd">val</span><span class="w"> </span><span class="n">ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">100</span><span class="p">)(</span><span class="nc">IO</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="n">scala</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nc">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
<span class="n">countEvens</span><span class="p">(</span><span class="n">ios</span><span class="p">).</span><span class="n">unsafeRunSync</span><span class="p">()</span><span class="w">  </span><span class="c1">// 約50（ランダム）</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">countEvens</span><span class="p">(</span><span class="n">ios</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">[</span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]]):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ref</span><span class="p">.</span><span class="n">of</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">](</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">_</span><span class="w">       </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ios</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">io</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">                 </span><span class="n">io</span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                   </span><span class="k">else</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">unit</span>
<span class="w">                 </span><span class="p">)</span>
<span class="w">               </span><span class="p">).</span><span class="n">parSequence</span>
<span class="w">    </span><span class="n">result</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="n">get</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="n">result</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="4">問題 4: タイムアウト付き実行<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。指定時間後に Fiber をキャンセルし、それまでに蓄積された結果を返します。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">collectFor</span><span class="p">(</span><span class="n">duration</span><span class="p">:</span><span class="w"> </span><span class="nc">FiniteDuration</span><span class="p">):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">List</span><span class="p">[</span><span class="nc">Int</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">???</span>

<span class="c1">// 期待される動作</span>
<span class="c1">// 1秒間、100msごとに乱数を生成してリストに追加</span>
<span class="c1">// 約10個の要素が返される</span>
<span class="n">collectFor</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">second</span><span class="p">).</span><span class="n">unsafeRunSync</span><span class="p">()</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">concurrent</span><span class="p">.</span><span class="nn">duration</span><span class="p">.</span><span class="n">_</span>

<span class="k">def</span><span class="w"> </span><span class="nf">collectFor</span><span class="p">(</span><span class="n">duration</span><span class="p">:</span><span class="w"> </span><span class="nc">FiniteDuration</span><span class="p">):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">List</span><span class="p">[</span><span class="nc">Int</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">collected</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ref</span><span class="p">.</span><span class="n">of</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="p">[</span><span class="nc">Int</span><span class="p">]](</span><span class="nc">List</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 100msごとに乱数を追加するプログラム</span>
<span class="w">    </span><span class="n">producer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">.</span><span class="n">millis</span><span class="p">)</span><span class="w"> </span><span class="o">*&gt;</span>
<span class="w">                </span><span class="nc">IO</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="n">scala</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nc">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="w">                  </span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">collected</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">appended</span><span class="p">(</span><span class="n">n</span><span class="p">))))</span>
<span class="w">                </span><span class="p">.</span><span class="n">foreverM</span>

<span class="w">    </span><span class="c1">// Fiber として起動</span>
<span class="w">    </span><span class="n">fiber</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">producer</span><span class="p">.</span><span class="n">start</span>

<span class="w">    </span><span class="c1">// 指定時間待機</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// キャンセル</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fiber</span><span class="p">.</span><span class="n">cancel</span>

<span class="w">    </span><span class="c1">// 結果を取得</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">collected</span><span class="p">.</span><span class="n">get</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="n">result</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="5">問題 5: 並行マップ更新<a class="headerlink" href="#5" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。複数の更新を並行して Map に適用し、最終的な Map を返します。</p>
<div class="highlight"><pre><span></span><code><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Update</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">applyUpdates</span><span class="p">(</span><span class="n">updates</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">[</span><span class="nc">Update</span><span class="p">]):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Map</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">???</span>

<span class="c1">// 期待される動作</span>
<span class="kd">val</span><span class="w"> </span><span class="n">updates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span>
<span class="w">  </span><span class="nc">Update</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">  </span><span class="nc">Update</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w">  </span><span class="nc">Update</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w">  </span><span class="c1">// &quot;a&quot; を上書き</span>
<span class="w">  </span><span class="nc">Update</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">applyUpdates</span><span class="p">(</span><span class="n">updates</span><span class="p">).</span><span class="n">unsafeRunSync</span><span class="p">()</span><span class="w">  </span><span class="c1">// Map(&quot;a&quot; -&gt; 3, &quot;b&quot; -&gt; 2, &quot;c&quot; -&gt; 4)</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Update</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">applyUpdates</span><span class="p">(</span><span class="n">updates</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">[</span><span class="nc">Update</span><span class="p">]):</span><span class="w"> </span><span class="nc">IO</span><span class="p">[</span><span class="nc">Map</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mapRef</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ref</span><span class="p">.</span><span class="n">of</span><span class="p">[</span><span class="nc">IO</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">]](</span><span class="nc">Map</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span>
<span class="w">    </span><span class="n">_</span><span class="w">      </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">updates</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">update</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">                </span><span class="n">mapRef</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">updated</span><span class="p">(</span><span class="n">update</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">update</span><span class="p">.</span><span class="n">value</span><span class="p">))</span>
<span class="w">              </span><span class="p">).</span><span class="n">parSequence</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mapRef</span><span class="p">.</span><span class="n">get</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="n">result</span>
<span class="p">}</span>
</code></pre></div>

注意: 並行実行なので、同じキーへの複数の更新がある場合、最終的な値は実行順序に依存します。

</details>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>