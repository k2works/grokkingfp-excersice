
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Scala、Java、F#、C#、Haskell、Clojure、Elixir、Rust、Python、TypeScript、Ruby で学ぶ関数型プログラミング">
      
      
        <meta name="author" content="Project Team">
      
      
      
        <link rel="prev" href="../part-4/">
      
      
        <link rel="next" href="../part-6/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Part V - 並行処理 - Grokking Functional Programming</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#part-v" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Grokking Functional Programming" class="md-header__button md-logo" aria-label="Grokking Functional Programming" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Grokking Functional Programming
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Part V - 並行処理
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/grokkingfp-excersice" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    grokkingfp-excersice
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../scala/" class="md-tabs__link">
          
  
  
  Scala

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../java/" class="md-tabs__link">
          
  
  
  Java

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../fsharp/" class="md-tabs__link">
          
  
  
  F#

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../csharp/" class="md-tabs__link">
          
  
  
  C#

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../haskell/" class="md-tabs__link">
          
  
  
  Haskell

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../clojure/" class="md-tabs__link">
          
  
  
  Clojure

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../elixir/" class="md-tabs__link">
          
  
  
  Elixir

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../rust/" class="md-tabs__link">
          
  
  
  Rust

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../python/" class="md-tabs__link">
          
  
  
  Python

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../typescript/" class="md-tabs__link">
          
  
  
  TypeScript

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  Ruby

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Grokking Functional Programming" class="md-nav__button md-logo" aria-label="Grokking Functional Programming" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Grokking Functional Programming
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/grokkingfp-excersice" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    grokkingfp-excersice
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Scala
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Scala
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO と副作用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Java
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Java
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO と副作用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    F#
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    F#
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - 非同期処理とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    C#
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    C#
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - 非同期処理とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Haskell
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Haskell
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Clojure
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Clojure
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - nil 安全性
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - 副作用とシーケンス
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Elixir
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Elixir
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../elixir/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../elixir/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../elixir/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../elixir/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../elixir/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../elixir/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理と OTP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../elixir/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Rust
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Rust
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rust/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rust/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rust/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rust/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rust/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - 非同期とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rust/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rust/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Python
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Python
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    TypeScript
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    TypeScript
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - Task と IO
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../typescript/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" checked>
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Ruby
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ruby
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      
        第10章: 並行・並列処理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第10章: 並行・並列処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 並行処理の課題
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-ref-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 Ref - アトミックな共有状態
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.2 Ref - アトミックな共有状態">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ref" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ref の使用例
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ref_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ref の主要メソッド
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.3 スレッドセーフな更新
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#104-par_sequence-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.4 par_sequence - 並列実行
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.4 par_sequence - 並列実行">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        並列実行の効果
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#105" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.5 チェックインのリアルタイム集計
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.5 チェックインのリアルタイム集計">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#n" class="md-nav__link">
    <span class="md-ellipsis">
      
        トップ N 都市の計算（純粋関数）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        チェックインの保存
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#106" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.6 並行チェックイン処理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#107-fiberhandle-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.7 FiberHandle - バックグラウンド実行
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.7 FiberHandle - バックグラウンド実行">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用例
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#108" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.8 呼び出し元に制御を返す設計
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.8 呼び出し元に制御を返す設計">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用例
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#109" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.9 タイムアウト付き実行
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1010" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.10 一定時間の結果収集
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1011" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.11 並列マップ更新
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1012-producer-consumer" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.12 Producer-Consumer パターン
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        まとめ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="まとめ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-v_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part V で学んだこと
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        主要コンポーネント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ruby-scala" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ruby と Scala の対応
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        キーポイント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        設計パターン
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        次のステップ
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        演習問題
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="演習問題">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-ref" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 1: Ref の基本
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 2: 並列実行
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 3: 並行カウント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 4: タイムアウト付き実行
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 5: 並行マップ更新
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 6: レース
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="part-v">Part V: 並行処理<a class="headerlink" href="#part-v" title="Permanent link">&para;</a></h1>
<p>本章では、関数型プログラミングにおける並行処理を学びます。Ref による安全な共有状態管理、並列実行、そして並行プログラムの構築方法を習得します。</p>
<hr />
<h2 id="10">第10章: 並行・並列処理<a class="headerlink" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="101">10.1 並行処理の課題<a class="headerlink" href="#101" title="Permanent link">&para;</a></h3>
<p>従来の並行処理には多くの課題があります:</p>
<ul>
<li>デッドロック</li>
<li>競合状態（Race Condition）</li>
<li>共有状態の管理の複雑さ</li>
<li>スレッドのオーバーヘッド</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQyN3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODY3cHg7aGVpZ2h0OjQyN3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDg2NyA0MjciIHdpZHRoPSI4NjdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl8uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjQwOS44OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijg0OSIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzNjYuNTAwMyIgeT0iMjYuOTk1MSI+JiMyNDQ2NzsmIzI2NDY5OyYjMTIzOTg7JiMyMDAwNjsmIzM0ODkyOyYjMjA5NjY7JiMyOTcwMjsmIzEyMzk4OyYjMjE4Mzk7JiMzODk4ODs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHByb2JsZW1zLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwcm9ibGVtcyIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX3Byb2JsZW1zIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyNS41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjMxMyIgeD0iNDQiIHk9IjYzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI3Ljk5OTkiIHg9IjE4Ni41MDAxIiB5PSI3Ny45OTUxIj4mIzIxODM5OyYjMzg5ODg7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBzb2x1dGlvbnMtLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InNvbHV0aW9ucyIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iY2x1c3Rlcl9zb2x1dGlvbnMiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMTkwLjU5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNDMyIiB4PSIzOTciIHk9IjE5OS4zIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjU2NC4wMDAyIiB5PSIyMTQuMjk1MSI+JiMzODMwNjsmIzI1OTY4OyYjMjI0MTE7JiMxMjM5ODsmIzM1Mjk5OyYjMjc3NzA7JiMzMTU3NDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJlbnRpdHlfLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMDMuOTk5NiIgeD0iNzUiIHk9IjEwNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjk5OTYiIHg9Ijg1IiB5PSIxMjEuOTk1MSI+JiMxMjQ4NzsmIzEyNDgzOyYjMTI0ODk7JiMxMjUyNTsmIzEyNDgzOyYjMTI0NjM7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNzUuOTk5OCIgeD0iMjE0IiB5PSIxMDYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIyMjQiIHk9IjEyMS45OTUxIj4mIzMxNDc4OyYjMjE1MTI7JiMyOTM2NjsmIzI0OTA3OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5Xy4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExNy45OTk2IiB4PSI2OCIgeT0iMjQyLjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSI3OCIgeT0iMjU4LjI5NTEiPiYjMjE0ODc7JiMyMjc5MzsmIzI5MzY2OyYjMjQ5MDc7JiMxMjM5ODsmIzIwODQ5OyYjMjYzNzc7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjgiIGRhdGEtdWlkPSJlbnQwMDA3IiBpZD0iZW50aXR5Xy4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTAzLjk5OTYiIHg9IjIyMSIgeT0iMjQyLjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSIyMzEiIHk9IjI1OC4yOTUxIj4mIzEyNDczOyYjMTI1MjQ7JiMxMjQ4MzsmIzEyNDg5OyYjMzE2NDk7JiMyOTcwMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDkiIGlkPSJlbnRpdHlfLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTU5Ljk5OTQiIHg9IjQyMSIgeT0iMjQyLjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzkuOTk5NCIgeD0iNDMxIiB5PSIyNTguMjk1MSI+JiMxMjQ1MjsmIzEyNTExOyYjMTI1MTc7JiMxMjU0MDsmIzEyNDc5OyYjMTI1MDI7JiMxMjUyMzsmIzEyNDg3OyYjMTI1NDA7JiMxMjQ3OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVmPz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlJlZi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTMiIGRhdGEtdWlkPSJlbnQwMDEwIiBpZD0iZW50aXR5X1JlZi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTY5LjI2OSIgeD0iNjE2LjM3IiB5PSIyNDIuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0OS4yNjkiIHg9IjYyNi4zNyIgeT0iMjU4LjI5NTEiPlJlZiYjNjUyODg7JiMxMjQ1MDsmIzEyNDg4OyYjMTI1MTE7JiMxMjQ4MzsmIzEyNDYzOyYjMjE0NDI7JiMyOTAzMTsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGRhdGEtdWlkPSJlbnQwMDExIiBpZD0iZW50aXR5Xy4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzEuOTk5NSIgeD0iNDM1IiB5PSIzNDMuNTkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iNDQ1IiB5PSIzNTkuNTg1MSI+JiMyMzQ1OTsmIzM1MzI4OyYjMzAzNDA7JiMxMjM5NDsmIzIwMDA2OyYjMzQ4OTI7JiMyMDk2NjsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBJTyA/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iSU8gLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxNSIgZGF0YS11aWQ9ImVudDAwMTIiIGlkPSJlbnRpdHlfSU8gLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI4MS41OTg0IiB4PSI2MDIuMiIgeT0iMzQzLjU5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuNTk4NCIgeD0iNjEyLjIiIHk9IjM1OS41ODUxIj5JTyAmIzEyNTE0OyYjMTI0OTA7JiMxMjQ4OTs8L3RleHQ+PC9nPjwhLS1saW5rIHByb2JsZW1zIHRvIHNvbHV0aW9ucy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJwcm9ibGVtcyIgZGF0YS1lbnRpdHktMj0ic29sdXRpb25zIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19wcm9ibGVtc19zb2x1dGlvbnMiPjxwYXRoIGQ9Ik0zNTcuNDM4NywxMTkuMjk4NiBDMzU3LjY5ODgsMTE5LjMzNDEgMzU3Ljk2NDUsMTE5LjM3MDMgMzU4LjIzNTgsMTE5LjQwNzMgQzM1OS4zMjExLDExOS41NTUzIDM2MC40OTU4LDExOS43MTU1IDM2MS43NTY2LDExOS44ODc1IEMzNjQuMjc4MywxMjAuMjMxNCAzNjcuMTQ0NCwxMjAuNjIyNiAzNzAuMzI4NSwxMjEuMDU3NCBDMzgzLjA2NDYsMTIyLjc5NjcgNDAwLjg4NywxMjUuMjM0NyA0MjIuMDk0NSwxMjguMTQ2OSBDNDY0LjUwOTcsMTMzLjk3MTMgNTIwLjQ2NTYsMTQxLjY5MjUgNTc2LjM1MzgsMTQ5LjUxNSBDNjg4LjEzLDE2NS4xNiA3OTkuNjM1LDE4MS4yMSA4MDIsMTgzLjMgQzgwNC44OTUsMTg1Ljg1MjUgODA3LjM2NzUsMTg4LjgwMDggODA5LjQ3NzQsMTkyLjAxMTYgQzgxMC41MzIzLDE5My42MTcgODExLjQ5NjYsMTk1LjI4OCA4MTIuMzc3NywxOTcuMDA3OSBDODEyLjU5NzksMTk3LjQzNzkgODEyLjgxMywxOTcuODcxIDgxMy4wMjMsMTk4LjMwNjkgQzgxMy4xMjgsMTk4LjUyNDggODEzLjIzMTcsMTk4Ljc0MzQgODEzLjMzNDIsMTk4Ljk2MjcgQzgxMy4zODU0LDE5OS4wNzI0IDgxMC45MjgxLDE5My43MzE2IDgxMC45Nzg3LDE5My44NDE2IiBmaWxsPSJub25lIiBpZD0icHJvYmxlbXMtdG8tc29sdXRpb25zIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSI4MTMuNDg3LDE5OS4yOTIxLDgxMy4zNTgzLDE4OS40NDQxLDgxMS4zOTY4LDE5NC43NSw4MDYuMDkwOSwxOTIuNzg4NSw4MTMuNDg3LDE5OS4yOTIxIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjAwMDEiIHg9Ijc1NC4wNiIgeT0iMTcxLjM2NjkiPiYjMzgzMDY7JiMyNTk2ODsmIzIyNDExOyYjMTI0NTA7JiMxMjUwMzsmIzEyNTI1OyYjMTI1NDA7JiMxMjQ4MTs8L3RleHQ+PC9nPjwhLS1TUkM9W0xQM0JKaTkwNThSdFZPZ25VcngwWE5qTjlodjFuTDU5MllNcWhlbzlwMTZ2STU4SUdxc0NidkloYVBqaVk5ZjY3LU91ZFJCWTVQbWY1NjR0dl9uZHBsLVRWeVN2ZXJiQXlnUUhvTWJRV1FPVDh0VGdLZ0JweHhsbWdPbDV5VXo3Ql9CaGxEbUpaSGpQeWdPeHotaXdrVFdRTlpLRGMtR0JyZjU5aXhPU0kxazVPdzhaYjE0MGVPZW1LV3lzcUxVQTZDbnVlbzlnaXgxcWNfSXVFLTZUd2hBZHQ0aEp5QjZRWUNXLTRPUkJSTUJpSW8xVGt6b1lkZGtqaUZkRWR6TlZnRHlFZnJ6WXZDTFNqY01VRW5haGptNzZFV1dsMjVzNDBEYUZXZVNtWTZiTGNOV1VxZkQ1SzQ3TUdnWjR1LWUyeFo5SHdZLTJESGFWandGTkFfNW1aU010cFMwSVZWLTA4Q1dMREtja2MyTnJFZ1hLUWMtM1JmVnl0dzFDeC1GTzBlSlk3bTAwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="102-ref-">10.2 Ref - アトミックな共有状態<a class="headerlink" href="#102-ref-" title="Permanent link">&para;</a></h3>
<p><strong>ソースファイル</strong>: <code>app/ruby/src/ch10_concurrency.rb</code></p>
<p><strong>Ref</strong> は、複数の並行処理から安全にアクセスできるアトミックな参照です。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Ref</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">initial_value</span><span class="p">)</span>
<span class="w">    </span><span class="vi">@value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initial_value</span>
<span class="w">    </span><span class="vi">@mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Mutex</span><span class="o">.</span><span class="n">new</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nc">self</span><span class="o">.</span><span class="nf">of</span><span class="p">(</span><span class="n">initial_value</span><span class="p">)</span>
<span class="w">    </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kp">new</span><span class="p">(</span><span class="n">initial_value</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">get</span>
<span class="w">    </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vi">@mutex</span><span class="o">.</span><span class="n">synchronize</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vi">@value</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn</span><span class="p">)</span>
<span class="w">    </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="vi">@mutex</span><span class="o">.</span><span class="n">synchronize</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vi">@value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="vi">@value</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h4 id="ref">Ref の使用例<a class="headerlink" href="#ref" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Ref の作成と使用</span>
<span class="n">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Ref</span><span class="o">.</span><span class="n">of</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">counter</span><span class="o">|</span>
<span class="w">  </span><span class="n">counter</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">}</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">counter</span><span class="o">.</span><span class="n">get</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">program</span><span class="o">.</span><span class="n">run!</span><span class="w">  </span><span class="c1"># 3</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI5OHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NDM2cHg7aGVpZ2h0OjI5OHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDQzNiAyOTgiIHdpZHRoPSI0MzZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIFJlZiA/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9IlJlZiAuLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl9SZWYgLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI4MC44OCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjI1MCIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjczLjI0MDEiIHg9IjEwMC4zOCIgeT0iMjYuOTk1MSI+UmVmICYjMTIzOTg7JiMyNTgwNTsmIzIwMzE2OzwvdGV4dD48L2c+PCEtLWVudGl0eSBjcmVhdGUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iY3JlYXRlIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImVudGl0eV9jcmVhdGUiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjgxLjA0NDkiIHg9Ijk2LjQ4IiB5PSI0NyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYxLjA0NDkiIHg9IjEwNi40OCIgeT0iNjIuOTk1MSI+UmVmLm9mKDApPC90ZXh0PjwvZz48IS0tZW50aXR5IHVwZGF0ZS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJ1cGRhdGUiIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X3VwZGF0ZSI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMjE4LjgwMjciIHg9IjI3LjYiIHk9IjE0Ni4zIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTk4LjgwMjciIHg9IjM3LjYiIHk9IjE2Mi4yOTUxIj5jb3VudGVyLnVwZGF0ZSB7IHx4fCB4ICsgMyB9PC90ZXh0PjwvZz48IS0tZW50aXR5IGdldC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJnZXQiIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5X2dldCI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTAxLjMwNjYiIHg9Ijg2LjM1IiB5PSIyNTQuNTgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4MS4zMDY2IiB4PSI5Ni4zNSIgeT0iMjcwLjU3NTEiPmNvdW50ZXIuZ2V0PC90ZXh0PjwvZz48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR01OOCIgZGF0YS1zb3VyY2UtbGluZT0iMTMiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iZW50aXR5X0dNTjgiPjxwYXRoIGQ9Ik0yNzguNSwyNDUuNiBMMjc4LjUsMjg1Ljg2NTYgQTAsMCAwIDAgMCAyNzguNSwyODUuODY1NiBMNDI5LjUwMDIsMjg1Ljg2NTYgQTAsMCAwIDAgMCA0MjkuNTAwMiwyODUuODY1NiBMNDI5LjUwMDIsMjU1LjYgTDQxOS41MDAyLDI0NS42IEwzMTguMTksMjQ1LjYgTDE1OC42LDE2OS4wMyBMMzEwLjE5LDI0NS42IEwyNzguNSwyNDUuNiBBMCwwIDAgMCAwIDI3OC41LDI0NS42IiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTQxOS41MDAyLDI0NS42IEw0MTkuNTAwMiwyNTUuNiBMNDI5LjUwMDIsMjU1LjYgTDQxOS41MDAyLDI0NS42IiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI3LjkzNzEiIHg9IjI4NC41IiB5PSIyNjIuNjY2OSI+dXBkYXRlICYjMTIzOTk7JiMxMjQ1MDsmIzEyNDg4OyYjMTI1MTE7JiMxMjQ4MzsmIzEyNDYzOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzAuMDAwMiIgeD0iMjg0LjUiIHk9IjI3Ny43OTk3Ij4mIzIwMTgyOyYjMTIzOTg7JiMyMDk2NjsmIzI5NzAyOyYjMTIzOTI7JiMzMTQ3ODsmIzIxNTEyOyYjMTIzNzU7JiMxMjM5NDsmIzEyMzU2OzwvdGV4dD48L2c+PCEtLWxpbmsgY3JlYXRlIHRvIHVwZGF0ZS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJjcmVhdGUiIGRhdGEtZW50aXR5LTI9InVwZGF0ZSIgZGF0YS1zb3VyY2UtbGluZT0iOCIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rX2NyZWF0ZV91cGRhdGUiPjxwYXRoIGQ9Ik0xMzcsNjkuNTcgQzEzNyw4OC4xOSAxMzcsMTIxLjAzIDEzNywxMzkuODIiIGZpbGw9Im5vbmUiIGlkPSJjcmVhdGUtdG8tdXBkYXRlIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMzcsMTQ1LjgyLDE0MSwxMzYuODIsMTM3LDE0MC44MiwxMzMsMTM2LjgyLDEzNywxNDUuODIiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNiIgeD0iMTM4IiB5PSIxMTIuMzY2OSI+JiMyMDMxNjsmIzI1MTA0OzwvdGV4dD48L2c+PCEtLWxpbmsgdXBkYXRlIHRvIGdldC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJ1cGRhdGUiIGRhdGEtZW50aXR5LTI9ImdldCIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImxuazciIGlkPSJsaW5rX3VwZGF0ZV9nZXQiPjxwYXRoIGQ9Ik0xMzcsMTY5LjAzIEMxMzcsMTg5LjQgMTM3LDIyNy44NiAxMzcsMjQ4LjIiIGZpbGw9Im5vbmUiIGlkPSJ1cGRhdGUtdG8tZ2V0IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMzcsMjU0LjIsMTQxLDI0NS4yLDEzNywyNDkuMiwxMzMsMjQ1LjIsMTM3LDI1NC4yIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjYiIHg9IjEzOCIgeT0iMjExLjY2NjkiPiYjMjYzNTY7JiMyNjAzMjs8L3RleHQ+PC9nPjwhLS1TUkM9W0tvcDlJQ3JETElaOElTcEN1LThnSWFxa0lTbkJwcWJMSzBmQUpMRHV0Qlprc1VKVTl0bGRBMmJLU29LZDVnTTBYVk5vcXBHQ0Q5S0s0ZWlMYWVqSTRxakllTEI5LVFMdjlRYjVVZ0s1QUsxMVhNZzVjZWVRWEdlNVJHTFpYTGdtUWVXNGNraHFyMUFtOTkzY3VlQU9mdzJoUW1UTGg2MmIwQkotTVNTNEJZV1Y5MExLMlhIX0RkbEJpc2FSazZndmtGQm9XSDk5LUlLYi1SYUEtTWFtUXcwUTdaVWtWem9xdzc1cG4tRmMtTy1SY255dGhVVHdpZGlRcTZURnN2U3pkejNzazc3NXl6TlJkYXhlVURtdV9ON1pnaVVEQkxvZlVJYUE4MkMxXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h4 id="ref_1">Ref の主要メソッド<a class="headerlink" href="#ref_1" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>メソッド</th>
<th>説明</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ref.of(initial)</code></td>
<td>初期値で Ref を作成</td>
<td><code>Ref.of(0)</code></td>
</tr>
<tr>
<td><code>ref.get</code></td>
<td>現在の値を取得</td>
<td><code>counter.get</code></td>
</tr>
<tr>
<td><code>ref.set(value)</code></td>
<td>値を設定</td>
<td><code>counter.set(10)</code></td>
</tr>
<tr>
<td><code>ref.update { }</code></td>
<td>アトミックに更新</td>
<td><code>counter.update { \|x\| x + 1 }</code></td>
</tr>
<tr>
<td><code>ref.modify { }</code></td>
<td>更新して古い値を返す</td>
<td><code>counter.modify { \|n\| [n + 1, n] }</code></td>
</tr>
</tbody>
</table>
<h3 id="103">10.3 スレッドセーフな更新<a class="headerlink" href="#103" title="Permanent link">&para;</a></h3>
<p>Ref を使った並行更新はスレッドセーフです:</p>
<div class="highlight"><pre><span></span><code><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Ref</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># 100スレッドで各10回インクリメント</span>
<span class="n">threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">map</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="mi">10</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ref</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="o">.</span><span class="n">run!</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">threads</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:join</span><span class="p">)</span>
<span class="n">ref</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">run!</span><span class="w">  </span><span class="c1"># 常に 1000</span>
</code></pre></div>
<h3 id="104-par_sequence-">10.4 par_sequence - 並列実行<a class="headerlink" href="#104-par_sequence-" title="Permanent link">&para;</a></h3>
<p><code>sequence</code> は IO を順番に実行しますが、<code>par_sequence</code> は並列に実行します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 順次実行</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sequence</span><span class="p">(</span><span class="n">ios</span><span class="p">)</span>
<span class="w">  </span><span class="n">ios</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="no">IO</span><span class="o">.</span><span class="n">pure</span><span class="p">(</span><span class="o">[]</span><span class="p">))</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="o">|</span>
<span class="w">    </span><span class="n">acc</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">results</span><span class="o">|</span>
<span class="w">      </span><span class="n">io</span><span class="o">.</span><span class="n">fmap</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">result</span><span class="o">|</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">[</span><span class="n">result</span><span class="o">]</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 並列実行</span>
<span class="k">def</span><span class="w"> </span><span class="nf">par_sequence</span><span class="p">(</span><span class="n">ios</span><span class="p">)</span>
<span class="w">  </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ios</span><span class="o">.</span><span class="n">map</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">io</span><span class="o">|</span>
<span class="w">      </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">io</span><span class="o">.</span><span class="n">run!</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">threads</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:value</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjM1N3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6OTIzcHg7aGVpZ2h0OjM1N3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDkyMyAzNTciIHdpZHRoPSI5MjNweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIHNlcXVlbmNlIHZzIHBhcl9zZXF1ZW5jZS0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0ic2VxdWVuY2UgdnMgcGFyX3NlcXVlbmNlIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfc2VxdWVuY2UgdnMgcGFyX3NlcXVlbmNlIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjMzOS43MyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjQ0MSIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIxMC43MjQ2IiB4PSIxMjcuMTM3NyIgeT0iMjYuOTk1MSI+c2VxdWVuY2UgdnMgcGFyX3NlcXVlbmNlPC90ZXh0PjwvZz48IS0tY2x1c3RlciBzZXEtLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InNlcSIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX3NlcSI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyNTYuNzMiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNDciIHg9IjQ0IiB5PSI2MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzEuMDcyIiB4PSI1MS45NjQiIHk9Ijc3Ljk5NTEiPnNlcXVlbmNlJiM2NTI4ODsmIzM4OTE4OyYjMjc0MjU7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHBhci0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0icGFyIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDkiIGlkPSJjbHVzdGVyX3BhciI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIxNzMuMDIiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxOTAiIHg9IjIzMSIgeT0iNjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTY0LjQ0NTEiIHg9IjI0My43Nzc1IiB5PSI3Ny45OTUxIj5wYXJfc2VxdWVuY2UmIzY1Mjg4OyYjMjAwMDY7JiMyMTAxNTsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSBzMS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJzMSIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJlbnRpdHlfczEiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjQ0LjA1NTciIHg9Ijg1Ljk3IiB5PSIxMDYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNC4wNTU3IiB4PSI5NS45NyIgeT0iMTIxLjk5NTEiPklPMTwvdGV4dD48L2c+PCEtLWVudGl0eSBzMi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJzMiIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfczIiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjQ0LjA1NTciIHg9Ijg1Ljk3IiB5PSIxODkuNzIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNC4wNTU3IiB4PSI5NS45NyIgeT0iMjA1LjcxNTEiPklPMjwvdGV4dD48L2c+PCEtLWVudGl0eSBzMy0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJzMyIgZGF0YS1zb3VyY2UtbGluZT0iNyIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJlbnRpdHlfczMiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjQ0LjA1NTciIHg9Ijg1Ljk3IiB5PSIyNzMuNDMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNC4wNTU3IiB4PSI5NS45NyIgeT0iMjg5LjQyNTEiPklPMzwvdGV4dD48L2c+PCEtLWVudGl0eSBwMS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJwMSIgZGF0YS1zb3VyY2UtbGluZT0iMTMiIGRhdGEtdWlkPSJlbnQwMDEwIiBpZD0iZW50aXR5X3AxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI0NC4wNTU3IiB4PSIyNTQuOTciIHk9IjEwNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI0LjA1NTciIHg9IjI2NC45NyIgeT0iMTIxLjk5NTEiPklPMTwvdGV4dD48L2c+PCEtLWVudGl0eSBwMi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJwMiIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGRhdGEtdWlkPSJlbnQwMDExIiBpZD0iZW50aXR5X3AyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI0NC4wNTU3IiB4PSIzMzMuOTciIHk9IjEwNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI0LjA1NTciIHg9IjM0My45NyIgeT0iMTIxLjk5NTEiPklPMjwvdGV4dD48L2c+PCEtLWVudGl0eSBwMy0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJwMyIgZGF0YS1zb3VyY2UtbGluZT0iMTUiIGRhdGEtdWlkPSJlbnQwMDEyIiBpZD0iZW50aXR5X3AzIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI0NC4wNTU3IiB4PSIyNTQuOTciIHk9IjE4OS43MiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI0LjA1NTciIHg9IjI2NC45NyIgeT0iMjA1LjcxNTEiPklPMzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjEzIiBkYXRhLXNvdXJjZS1saW5lPSIyMCIgZGF0YS11aWQ9ImVudDAwMTQiIGlkPSJlbnRpdHlfR01OMTMiPjxwYXRoIGQ9Ik00NjkuMjYsMTg4LjMgTDQ2OS4yNiwyMTMuNDMyOCBMNjY2Ljc0MzksMjEzLjQzMjggTDY2Ni43NDM5LDE5OC4zIEw2NTYuNzQzOSwxODguMyBMNDY5LjI2LDE4OC4zIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTY1Ni43NDM5LDE4OC4zIEw2NTYuNzQzOSwxOTguMyBMNjY2Ljc0MzksMTk4LjMgTDY1Ni43NDM5LDE4OC4zIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTc2LjQ4MzkiIHg9IjQ3NS4yNiIgeT0iMjA1LjM2NjkiPiYjMjE1MTI7JiMzNTMzNjsmIzI2MTc4OyYjMzgyOTE7ID0gSU8xICsgSU8yICsgSU8zPC90ZXh0PjwvZz48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR01OMTYiIGRhdGEtc291cmNlLWxpbmU9IjI0IiBkYXRhLXVpZD0iZW50MDAxNyIgaWQ9ImVudGl0eV9HTU4xNiI+PHBhdGggZD0iTTcwMS45MiwxODguMyBMNzAxLjkyLDIxMy40MzI4IEw5MTYuMDg1NiwyMTMuNDMyOCBMOTE2LjA4NTYsMTk4LjMgTDkwNi4wODU2LDE4OC4zIEw3MDEuOTIsMTg4LjMiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNOTA2LjA4NTYsMTg4LjMgTDkwNi4wODU2LDE5OC4zIEw5MTYuMDg1NiwxOTguMyBMOTA2LjA4NTYsMTg4LjMiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOTMuMTY1NiIgeD0iNzA3LjkyIiB5PSIyMDUuMzY2OSI+JiMyMTUxMjsmIzM1MzM2OyYjMjYxNzg7JiMzODI5MTsgJiM4Nzc2OyBtYXgoSU8xLCBJTzIsIElPMyk8L3RleHQ+PC9nPjwhLS1saW5rIHMxIHRvIHMyLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InMxIiBkYXRhLWVudGl0eS0yPSJzMiIgZGF0YS1zb3VyY2UtbGluZT0iOCIgZGF0YS11aWQ9ImxuazciIGlkPSJsaW5rX3MxX3MyIj48cGF0aCBkPSJNMTA4LDEyOC41IEMxMDgsMTQ0LjEzIDEwOCwxNjcuNjEgMTA4LDE4My4zNCIgZmlsbD0ibm9uZSIgaWQ9InMxLXRvLXMyIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMDgsMTg5LjM0LDExMiwxODAuMzQsMTA4LDE4NC4zNCwxMDQsMTgwLjM0LDEwOCwxODkuMzQiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgczIgdG8gczMtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iczIiIGRhdGEtZW50aXR5LTI9InMzIiBkYXRhLXNvdXJjZS1saW5lPSI5IiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfczJfczMiPjxwYXRoIGQ9Ik0xMDgsMjEyLjIyIEMxMDgsMjI3Ljg1IDEwOCwyNTEuMzIgMTA4LDI2Ny4wNiIgZmlsbD0ibm9uZSIgaWQ9InMyLXRvLXMzIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMDgsMjczLjA2LDExMiwyNjQuMDYsMTA4LDI2OC4wNiwxMDQsMjY0LjA2LDEwOCwyNzMuMDYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgc2VxIHRvIEdNTjEzLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InNlcSIgZGF0YS1lbnRpdHktMj0iR01OMTMiIGRhdGEtc291cmNlLWxpbmU9IjIwIiBkYXRhLXVpZD0ibG5rMTUiIGlkPSJsaW5rX3NlcV9HTU4xMyI+PHBhdGggZD0iTTE5MS4yMTk1LDExOS44OTk0IEMxOTEuMzk4NSwxMTkuOTM3NCAxOTEuNTgwMiwxMTkuOTc2IDE5MS43NjQ3LDEyMC4wMTUxIEMxOTIuNTAyNSwxMjAuMTcxNyAxOTMuMjgzNywxMjAuMzM3NSAxOTQuMTA3MSwxMjAuNTEyMiBDMjAwLjY5MzYsMTIxLjkxMDEgMjA5Ljk3NjMsMTIzLjg4MDIgMjIxLjMyMDgsMTI2LjI4OCBDMjQ0LjAwOTcsMTMxLjEwMzQgMjc0Ljk0NTYsMTM3LjY2OTQgMzA5LjA1MzgsMTQ0LjkwODggQzM3Ny4yNywxNTkuMzg3NSA0NTguMTc1LDE3Ni41NiA1MTEuMTcsMTg3LjgxIiBmaWxsPSJub25lIiBpZD0ic2VxLUdNTjEzIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PC9nPjwhLS1saW5rIHBhciB0byBHTU4xNi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJwYXIiIGRhdGEtZW50aXR5LTI9IkdNTjE2IiBkYXRhLXNvdXJjZS1saW5lPSIyNCIgZGF0YS11aWQ9ImxuazE4IiBpZD0ibGlua19wYXJfR01OMTYiPjxwYXRoIGQ9Ik00MjEuNDUyNywxMTkuODk5NCBDNDIxLjYzNjgsMTE5LjkzNzQgNDIxLjgyMzcsMTE5Ljk3NiA0MjIuMDEzNSwxMjAuMDE1MSBDNDIyLjc3MjQsMTIwLjE3MTcgNDIzLjU3NTksMTIwLjMzNzUgNDI0LjQyMjcsMTIwLjUxMjIgQzQzMS4xOTc1LDEyMS45MTAxIDQ0MC43NDUzLDEyMy44ODAyIDQ1Mi40MTM4LDEyNi4yODggQzQ3NS43NTA2LDEzMS4xMDM0IDUwNy41NywxMzcuNjY5NCA1NDIuNjUyNSwxNDQuOTA4OCBDNjEyLjgxNzUsMTU5LjM4NzUgNjk2LjAzNSwxNzYuNTYgNzUwLjU1LDE4Ny44MSIgZmlsbD0ibm9uZSIgaWQ9InBhci1HTU4xNiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjwvZz48IS0tU1JDPVtLb3A5SUNyRExJWjhJU3BDdS04Z0lhcWtJU25CcHFiTEsyZkVCSW5EcEtqRUxJV2hMWVg4QjhnN3lQS0tnaDRmVXgtZHUtTTJqY1RoNWh4VnF3Y2FhNVlpMDlHMGdhbkVCNGZIS0ZCcUR1STg2Uzg1WjIwMkhkMDFPdVkwQ0xVbmVPQWtoWHI4Z2pXOG1aQmNnYUxuNmg5cFdGTy1zUjdpUVNUcWNCcjBJR254MnozakJLMnRqbTFhMXoyTWxGb0lMOE1hXzlBSV81bzVfM0lHOXhZVUprWHVpUUJac1NvY2J6Q2NBeldnMENyS3EwUUlIYzNJYzJpckJxSzFmMGozQnowWGc3ZVZUTk9ldjJQTVEwMURxMDRQMDJBQ0RVNDYwMDAwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h4 id="_1">並列実行の効果<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 各IOが0.1秒かかる場合</span>
<span class="n">ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">sleep</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>

<span class="c1"># 順次実行: 約0.3秒</span>
<span class="n">sequence</span><span class="p">(</span><span class="n">ios</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span>

<span class="c1"># 並列実行: 約0.1秒</span>
<span class="n">par_sequence</span><span class="p">(</span><span class="n">ios</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span>
</code></pre></div>
<h3 id="105">10.5 チェックインのリアルタイム集計<a class="headerlink" href="#105" title="Permanent link">&para;</a></h3>
<p>都市へのチェックインをリアルタイムで集計し、ランキングを更新する例を見ていきます。</p>
<div class="highlight"><pre><span></span><code><span class="no">City</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">keyword_init</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">)</span>
<span class="no">CityStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:city</span><span class="p">,</span><span class="w"> </span><span class="ss">:check_ins</span><span class="p">,</span><span class="w"> </span><span class="ss">keyword_init</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">)</span>

<span class="c1"># チェックインデータ</span>
<span class="n">check_ins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">  </span><span class="no">City</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Sydney&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="no">City</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Dublin&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="no">City</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Sydney&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="no">City</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Lima&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="no">City</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Sydney&#39;</span><span class="p">)</span>
<span class="o">]</span>
</code></pre></div>
<h4 id="n">トップ N 都市の計算（純粋関数）<a class="headerlink" href="#n" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">top_cities</span><span class="p">(</span><span class="n">city_check_ins</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="w">  </span><span class="n">city_check_ins</span>
<span class="w">    </span><span class="o">.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="o">|</span><span class="w"> </span><span class="no">CityStats</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">city</span><span class="p">:</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="ss">check_ins</span><span class="p">:</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="o">.</span><span class="n">sort_by</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">stats</span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="n">stats</span><span class="o">.</span><span class="n">check_ins</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<h4 id="_2">チェックインの保存<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">store_check_in</span><span class="p">(</span><span class="n">stored_check_ins</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">)</span>
<span class="w">  </span><span class="n">stored_check_ins</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">check_ins</span><span class="o">|</span>
<span class="w">    </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_ins</span><span class="o">[</span><span class="n">city</span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">check_ins</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">city</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="106">10.6 並行チェックイン処理<a class="headerlink" href="#106" title="Permanent link">&para;</a></h3>
<p>チェックインの保存とランキングの更新を並行して実行します。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_check_ins_concurrent</span><span class="p">(</span><span class="n">check_ins</span><span class="p">)</span>
<span class="w">  </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">stored_check_ins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Ref</span><span class="o">.</span><span class="n">new</span><span class="p">({})</span>
<span class="w">    </span><span class="n">stored_ranking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Ref</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span>

<span class="w">    </span><span class="n">cancel_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="ss">cancelled</span><span class="p">:</span><span class="w"> </span><span class="kp">false</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="c1"># ランキング更新スレッド（継続的に実行）</span>
<span class="w">    </span><span class="n">ranking_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="k">until</span><span class="w"> </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span>
<span class="w">        </span><span class="n">update_ranking</span><span class="p">(</span><span class="n">stored_check_ins</span><span class="p">,</span><span class="w"> </span><span class="n">stored_ranking</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span>
<span class="w">        </span><span class="nb">sleep</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">01</span><span class="p">)</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c1"># チェックイン処理スレッド</span>
<span class="w">    </span><span class="n">checkin_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">check_ins</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">city</span><span class="o">|</span>
<span class="w">        </span><span class="k">break</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span>
<span class="w">        </span><span class="n">store_check_in</span><span class="p">(</span><span class="n">stored_check_ins</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c1"># チェックイン完了を待機</span>
<span class="w">    </span><span class="n">checkin_thread</span><span class="o">.</span><span class="n">join</span>

<span class="w">    </span><span class="c1"># 最終ランキング更新</span>
<span class="w">    </span><span class="nb">sleep</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">05</span><span class="p">)</span>
<span class="w">    </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
<span class="w">    </span><span class="n">ranking_thread</span><span class="o">.</span><span class="n">join</span>

<span class="w">    </span><span class="n">stored_ranking</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">run!</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjIwNHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTAzNXB4O2hlaWdodDoyMDRweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMDM1IDIwNCIgd2lkdGg9IjEwMzVweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl8uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE0MC4zIiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTAxNyIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjQ3MS41MDAyIiB5PSIyNi45OTUxIj4mIzIwMDA2OyYjMzQ4OTI7JiMyMDk2NjsmIzI5NzAyOyYjMTIzOTg7JiMyNzA4MzsmIzM2ODk2OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgY2hlY2tpbi0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iY2hlY2tpbiIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX2NoZWNraW4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iNzMuMyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM4NyIgeD0iMzYiIHk9IjU1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxNzMuNTAwMiIgeT0iNjkuOTk1MSI+JiMxMjQ4MTsmIzEyNDU1OyYjMTI0ODM7JiMxMjQ2MzsmIzEyNDUyOyYjMTI1MzE7JiMyMDk2NjsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgcmFua2luZy0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0icmFua2luZyIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJjbHVzdGVyX3JhbmtpbmciPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iNzMuMyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjU1OCIgeD0iNDQ3IiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSI2NzcuMDAwMiIgeT0iNjkuOTk1MSI+JiMxMjUyMTsmIzEyNTMxOyYjMTI0NjE7JiMxMjUzMTsmIzEyNDY0OyYjMjYzNTY7JiMyNjAzMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgU3RyZWFtID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlN0cmVhbSAuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJlbnRpdHlfU3RyZWFtIC4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyMjkuNDExNCIgeD0iNTIuMjkiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjA5LjQxMTQiIHg9IjYyLjI5IiB5PSIxMDUuOTk1MSI+U3RyZWFtICYjMTIzNjM7JiMxMjQyNTsmIzEyNDgxOyYjMTI0NTU7JiMxMjQ4MzsmIzEyNDYzOyYjMTI0NTI7JiMxMjUzMTsmIzEyNDM0OyYjMjE0NjM7JiMyMDQ0OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVmID8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSZWYgLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwNSIgaWQ9ImVudGl0eV9SZWYgLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI4OS43MTk1IiB4PSIzMTcuMTQiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuNzE5NSIgeD0iMzI3LjE0IiB5PSIxMDUuOTk1MSI+UmVmICYjMTIzOTU7JiMyMDQ0NTsmIzIzMzg0OzwvdGV4dD48L2c+PCEtLWVudGl0eSBSZWYgPz8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSZWYgLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJlbnQwMDA3IiBpZD0iZW50aXR5X1JlZiAuLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxODcuNzE5MSIgeD0iNDYzLjE0IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2Ny43MTkxIiB4PSI0NzMuMTQiIHk9IjEwNS45OTUxIj5SZWYgJiMxMjM2MzsmIzEyNDI1OyYjMTI0ODc7JiMxMjU0MDsmIzEyNDc5OyYjMTI0MzQ7JiMzNTUwMTsmIzEyNDE1OyYjMjE0NjI7JiMxMjQyNjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjExIiBkYXRhLXVpZD0iZW50MDAwOCIgaWQ9ImVudGl0eV8uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTMxLjk5OTUiIHg9IjY4NiIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iNjk2IiB5PSIxMDUuOTk1MSI+JiMxMjUyMTsmIzEyNTMxOyYjMTI0NjE7JiMxMjUzMTsmIzEyNDY0OyYjMTI0MzQ7JiMzNTMzNjsmIzMxNjM5OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8gUmVmID8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4gUmVmIC4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTIiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iZW50aXR5Xy4uLiBSZWYgLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzYuMTY5NiIgeD0iODUyLjkyIiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNi4xNjk2IiB4PSI4NjIuOTIiIHk9IjEwNS45OTUxIj4mIzMyMDgwOyYjMjY1MjQ7JiMxMjQzNDsgUmVmICYjMTIzOTU7JiMyMDQ0NTsmIzIzMzg0OzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjEwIiBkYXRhLXNvdXJjZS1saW5lPSIxNyIgZGF0YS11aWQ9ImVudDAwMTEiIGlkPSJlbnRpdHlfR01OMTAiPjxwYXRoIGQ9Ik04MTUuMzYsMTcyLjMgTDgxNS4zNiwxOTcuNDMyOCBBMCwwIDAgMCAwIDgxNS4zNiwxOTcuNDMyOCBMMTAyNi42MzEyLDE5Ny40MzI4IEEwLDAgMCAwIDAgMTAyNi42MzEyLDE5Ny40MzI4IEwxMDI2LjYzMTIsMTgyLjMgTDEwMTYuNjMxMiwxNzIuMyBMOTI1LDE3Mi4zIEw5MjEsMTEyLjUgTDkxNywxNzIuMyBMODE1LjM2LDE3Mi4zIEEwLDAgMCAwIDAgODE1LjM2LDE3Mi4zIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTEwMTYuNjMxMiwxNzIuMyBMMTAxNi42MzEyLDE4Mi4zIEwxMDI2LjYzMTIsMTgyLjMgTDEwMTYuNjMxMiwxNzIuMyIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE5MC4yNzEyIiB4PSI4MjEuMzYiIHk9IjE4OS4zNjY5Ij4yJiMxMjM4ODsmIzEyMzk4OyYjMjA5NjY7JiMyOTcwMjsmIzEyMzY0OyYjMjAwMDY7JiMzNDg5MjsmIzEyMzc1OyYjMTIzOTA7JiMyMzQ1NTsmIzM0ODkyOyYjMTIzNzM7JiMxMjQyODsmIzEyNDI3OzwvdGV4dD48L2c+PCEtLVNSQz1bUFAzVElpQ202OFJGU25LbmItMmJ3MU40QmN4M0RQTVFDbjVDMGN3cFhHdDFMVjF0QzNmX1Exc2V1ODdHWV9jUVRqdzVNTWo1dEthOG9WRC1weVV4OEpoQ1BOWV9IeGlTOFB5dldsOXNaczZJbHlWQlFNWndTSmEtMFBhTXktM3AtOHhXbXp5Q1EwYmczYmczVVdPcjBfckl5bUpKMC1ucWNCRk52SlJYS0ItNW9SUm02TktubzAzS1MzcTl3aW9DZVpvUmFjei1ZLXJRLTJkRmhhcm9HVDBILWNqLWczOTlUSXdBb3pUWWlnWXFGa05Nc2x4SHJjRGdQbl9xMXdaQ2dmUUYyU1pDWjJRV0pYbFhsdmFod2R2R2ZiN3BOeHdEWXZpaC11cE5MaEZCU0t5bWxFQzl1UmJlNC1KQ1RqUUs1elBUV2VuMG5ZUXpoVXhkZTQ5RzBNQXlYTFZQQm0wMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h3 id="107-fiberhandle-">10.7 FiberHandle - バックグラウンド実行<a class="headerlink" href="#107-fiberhandle-" title="Permanent link">&para;</a></h3>
<p><code>FiberHandle</code> はバックグラウンドで実行中の計算を表します。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FiberHandle</span>
<span class="w">  </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:thread</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span><span class="w"> </span><span class="n">cancel_flag</span><span class="p">)</span>
<span class="w">    </span><span class="vi">@thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread</span>
<span class="w">    </span><span class="vi">@cancel_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cancel_flag</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">join</span>
<span class="w">    </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vi">@thread</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">cancel</span>
<span class="w">    </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="vi">@cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
<span class="w">      </span><span class="vi">@thread</span><span class="o">.</span><span class="n">kill</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="vi">@thread</span><span class="o">.</span><span class="n">alive?</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># IO をバックグラウンドで開始</span>
<span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
<span class="w">  </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">cancel_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="ss">cancelled</span><span class="p">:</span><span class="w"> </span><span class="kp">false</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">io</span><span class="o">.</span><span class="n">run!</span><span class="w"> </span><span class="k">unless</span><span class="w"> </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="no">FiberHandle</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span><span class="w"> </span><span class="n">cancel_flag</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h4 id="_3">使用例<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># バックグラウンドで処理を開始</span>
<span class="n">fiber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">(</span><span class="n">long_running_io</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span>

<span class="c1"># 何か他の作業をする</span>
<span class="n">do_other_work</span>

<span class="c1"># 結果を待つ</span>
<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fiber</span><span class="o">.</span><span class="n">join</span><span class="o">.</span><span class="n">run!</span>

<span class="c1"># または途中でキャンセル</span>
<span class="n">fiber</span><span class="o">.</span><span class="n">cancel</span><span class="o">.</span><span class="n">run!</span>
</code></pre></div>
<h3 id="108">10.8 呼び出し元に制御を返す設計<a class="headerlink" href="#108" title="Permanent link">&para;</a></h3>
<p>FiberHandle を使って、呼び出し元に制御を返しつつバックグラウンドで処理を続ける設計ができます。</p>
<div class="highlight"><pre><span></span><code><span class="no">ProcessingResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:current_ranking</span><span class="p">,</span><span class="w"> </span><span class="ss">:stop</span><span class="p">,</span><span class="w"> </span><span class="ss">keyword_init</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">start_processing</span><span class="p">(</span><span class="n">check_ins</span><span class="p">)</span>
<span class="w">  </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">stored_check_ins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Ref</span><span class="o">.</span><span class="n">new</span><span class="p">({})</span>
<span class="w">    </span><span class="n">stored_ranking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Ref</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span>

<span class="w">    </span><span class="n">cancel_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="ss">cancelled</span><span class="p">:</span><span class="w"> </span><span class="kp">false</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="c1"># バックグラウンドスレッドを開始</span>
<span class="w">    </span><span class="n">ranking_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="k">until</span><span class="w"> </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span>
<span class="w">        </span><span class="n">update_ranking</span><span class="p">(</span><span class="n">stored_check_ins</span><span class="p">,</span><span class="w"> </span><span class="n">stored_ranking</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span>
<span class="w">        </span><span class="nb">sleep</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">01</span><span class="p">)</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">checkin_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">check_ins</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">city</span><span class="o">|</span>
<span class="w">        </span><span class="k">break</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span>
<span class="w">        </span><span class="n">store_check_in</span><span class="p">(</span><span class="n">stored_check_ins</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c1"># 制御インターフェースを返す</span>
<span class="w">    </span><span class="n">current_ranking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stored_ranking</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">run!</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
<span class="w">      </span><span class="n">checkin_thread</span><span class="o">.</span><span class="n">kill</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">checkin_thread</span><span class="o">.</span><span class="n">alive?</span>
<span class="w">      </span><span class="n">ranking_thread</span><span class="o">.</span><span class="n">join</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="no">ProcessingResult</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">current_ranking</span><span class="p">:</span><span class="w"> </span><span class="n">current_ranking</span><span class="p">,</span><span class="w"> </span><span class="ss">stop</span><span class="p">:</span><span class="w"> </span><span class="n">stop</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQzNHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NjI4cHg7aGVpZ2h0OjQzNHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDYyOCA0MzQiIHdpZHRoPSI2MjhweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMyIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJjbHVzdGVyXy4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjQxNi4xOSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYxMCIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjI4Mi4wMDAyIiB5PSIyNi45OTUxIj4mIzIxMDQ2OyYjMjQ0ODE7JiMxMjM5ODsmIzI3OTY5OyYjMTI0Mjg7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBiZy0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iYmciIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImNsdXN0ZXJfYmciPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iODkuMyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM1MiIgeD0iMjM4IiB5PSIzMDYuODkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjM1OC4wMDAyIiB5PSIzMjEuODg1MSI+JiMxMjQ5NjsmIzEyNDgzOyYjMTI0NjM7JiMxMjQ2NDsmIzEyNTIxOyYjMTI0NTQ7JiMxMjUzMTsmIzEyNDg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSBjYWxsLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImNhbGwiIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X2NhbGwiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE5NS44MTMyIiB4PSI3OS4wOSIgeT0iNDciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNzUuODEzMiIgeD0iODkuMDkiIHk9IjYyLjk5NTEiPnN0YXJ0X3Byb2Nlc3NpbmcgJiMyMTYyODsmIzEyNDAzOyYjMjA5ODY7JiMxMjM3NTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgaW5pdC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJpbml0IiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0iZW50MDAwNCIgaWQ9ImVudGl0eV9pbml0Ij48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMDMuNzE5NSIgeD0iMTI1LjE0IiB5PSIxMzAuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjcxOTUiIHg9IjEzNS4xNCIgeT0iMTQ2LjI5NTEiPlJlZiAmIzEyMzk4OyYjMjEwMjE7JiMyNjM5OTsmIzIxMjcwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBzdGFydC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJzdGFydCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfc3RhcnQiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExNy45OTk2IiB4PSIxMTgiIHk9IjIxMy42Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMTI4IiB5PSIyMjkuNTk1MSI+JiMxMjQ3MzsmIzEyNTI0OyYjMTI0ODM7JiMxMjQ4OTsmIzEyMzk4OyYjMzYyMTU7JiMyMTIwNTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcmV0dXJuLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9InJldHVybiIgZGF0YS1zb3VyY2UtbGluZT0iNyIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJlbnRpdHlfcmV0dXJuIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxODUuNjQ4MyIgeD0iMjguMTgiIHk9IjM0OS44OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2NS42NDgzIiB4PSIzOC4xOCIgeT0iMzY1Ljg4NTEiPlByb2Nlc3NpbmdSZXN1bHQgJiMxMjQzNDsmIzM2ODIwOyYjMTIzNzc7PC90ZXh0PjwvZz48IS0tZW50aXR5IGNoZWNraW4tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iY2hlY2tpbiIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGRhdGEtdWlkPSJlbnQwMDExIiBpZD0iZW50aXR5X2NoZWNraW4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEzMS45OTk1IiB4PSIyNjIiIHk9IjM0OS44OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIyNzIiIHk9IjM2NS44ODUxIj4mIzEyNDgxOyYjMTI0NTU7JiMxMjQ4MzsmIzEyNDYzOyYjMTI0NTI7JiMxMjUzMTsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tZW50aXR5IHJhbmtpbmctLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icmFua2luZyIgZGF0YS1zb3VyY2UtbGluZT0iMTUiIGRhdGEtdWlkPSJlbnQwMDEyIiBpZD0iZW50aXR5X3JhbmtpbmciPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExNy45OTk2IiB4PSI0MjkiIHk9IjM0OS44OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjQzOSIgeT0iMzY1Ljg4NTEiPiYjMTI1MjE7JiMxMjUzMTsmIzEyNDYxOyYjMTI1MzE7JiMxMjQ2NDsmIzI2MzU2OyYjMjYwMzI7PC90ZXh0PjwvZz48IS0tbGluayBjYWxsIHRvIGluaXQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iY2FsbCIgZGF0YS1lbnRpdHktMj0iaW5pdCIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImxuazciIGlkPSJsaW5rX2NhbGxfaW5pdCI+PHBhdGggZD0iTTE3Nyw2OS43OCBDMTc3LDg1LjM2IDE3NywxMDguMjQgMTc3LDEyMy44MiIgZmlsbD0ibm9uZSIgaWQ9ImNhbGwtdG8taW5pdCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTc3LDEyOS44MiwxODEsMTIwLjgyLDE3NywxMjQuODIsMTczLDEyMC44MiwxNzcsMTI5LjgyIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIGluaXQgdG8gc3RhcnQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iaW5pdCIgZGF0YS1lbnRpdHktMj0ic3RhcnQiIGRhdGEtc291cmNlLWxpbmU9IjEwIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfaW5pdF9zdGFydCI+PHBhdGggZD0iTTE3NywxNTMuMDggQzE3NywxNjguNjYgMTc3LDE5MS41MyAxNzcsMjA3LjExIiBmaWxsPSJub25lIiBpZD0iaW5pdC10by1zdGFydCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTc3LDIxMy4xMSwxODEsMjA0LjExLDE3NywyMDguMTEsMTczLDIwNC4xMSwxNzcsMjEzLjExIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIHN0YXJ0IHRvIHJldHVybi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJzdGFydCIgZGF0YS1lbnRpdHktMj0icmV0dXJuIiBkYXRhLXNvdXJjZS1saW5lPSIxMSIgZGF0YS11aWQ9ImxuazkiIGlkPSJsaW5rX3N0YXJ0X3JldHVybiI+PHBhdGggZD0iTTE3Mi42MSwyMzYuMjggQzE2Mi4xNCwyNjEuMzkgMTM4LjEzLDMxOC45NjI1IDEyNy42OCwzNDQuMDEyNSIgZmlsbD0ibm9uZSIgaWQ9InN0YXJ0LXRvLXJldHVybiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTI1LjM3LDM0OS41NSwxMzIuNTI2NywzNDIuNzgzOCwxMjcuMjk1LDM0NC45MzU0LDEyNS4xNDM0LDMzOS43MDM3LDEyNS4zNywzNDkuNTUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS4wMDAxIiB4PSIxNTkuODkiIHk9IjI3OC45NTY5Ij4mIzEyMzc3OyYjMTIzNjg7JiMxMjM5NTsmIzI1MTQ3OyYjMTI0Mjc7PC90ZXh0PjwvZz48IS0tbGluayBzdGFydCB0byBiZy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJzdGFydCIgZGF0YS1lbnRpdHktMj0iYmciIGRhdGEtc291cmNlLWxpbmU9IjE4IiBkYXRhLXVpZD0ibG5rMTMiIGlkPSJsaW5rX3N0YXJ0X2JnIj48cGF0aCBkPSJNMjM2LjI4LDIzNC4wNSBDMzQxLjQ3LDI0OS4wMiA1NTAuOTUsMjgwIDU2MywyOTAuODkgQzU2NS44NjM4LDI5My40Nzg3IDU2OC4zMTI1LDI5Ni40NTQ1IDU3MC40MDQ4LDI5OS42ODU2IEM1NzEuNDUwOSwzMDEuMzAxMiA1NzIuNDA3OSwzMDIuOTgwNiA1NzMuMjgzMSwzMDQuNzA3NCBDNTczLjUwMTksMzA1LjEzOSA1NzMuNzE1NiwzMDUuNTczNyA1NzMuOTI0MywzMDYuMDExIEM1NzQuMDI4NiwzMDYuMjI5NyA1NzEuNjEwOCwzMDEuMDA0NCA1NzEuNzEyNywzMDEuMjI0NCIgZmlsbD0ibm9uZSIgaWQ9InN0YXJ0LXRvLWJnIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSI1NzQuMjMzNiwzMDYuNjY5MSw1NzQuMDgyLDI5Ni44MjE0LDU3Mi4xMzI4LDMwMi4xMzE4LDU2Ni44MjI0LDMwMC4xODI2LDU3NC4yMzM2LDMwNi42NjkxIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTIuMDAwMSIgeD0iNTM4LjQxIiB5PSIyNzguOTU2OSI+JiMyMDAwNjsmIzM0ODkyOyYjMjM0NTU7JiMzNDg5Mjs8L3RleHQ+PC9nPjwhLS1TUkM9W0xQM0RJaUQwNThOdFVPZW4teHYwNXB3M3owTGFaNkNRWkI1Q2ZZbGZPY1IwSGZmNTVBcUtiTEFHSTU1aGVEUF96NjZrNF9DT0pZUGZxU3Mxb19zdXZ6b3BuamZhWncyRVp4dDBpWVhuNjB2U2RvMVJIS19nU205eWJZeXVZRFg2MXZRM3dKUW9HdU9mcy1wR1ZPVTRlSFV1STFyXzA5LWhfWGxtU25sWDQzZE96c2t1SE5RR2xnNllnX25vaEVBWHNOazFuLWV6WTVVR1RvMGJvMkZENU9qZERKV3BhQjZmZ09zTE1PazROUHlYNDJWNXJvZG1hSzRmT0xzZ3F2VS1nRDVPaG1uQUNMRHJvUVlQQW5tclRSMEh5MEp1Ukh3elduWnlVbnphS2dPSTNvMG9hNUNHQVNZdjNjYUNqem5MNm8xckVwVEJ6NWYzZ2ZfLTk4VEw0TXRZeEVmVWItWXFsMjdrWk1Sdm5NQy1wQWU3U0EwbnItZlBWczlnYW9Sd1ZhY0JJUW5jT3dyTXhuUzBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h4 id="_4">使用例<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 処理を開始（すぐに戻る）</span>
<span class="n">processing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_processing</span><span class="p">(</span><span class="n">check_ins</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span>

<span class="c1"># ランキングを確認</span>
<span class="n">ranking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processing</span><span class="o">.</span><span class="n">current_ranking</span><span class="o">.</span><span class="n">run!</span>
<span class="nb">puts</span><span class="w"> </span><span class="n">ranking</span>

<span class="c1"># しばらく待機</span>
<span class="nb">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 更新されたランキングを確認</span>
<span class="n">new_ranking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processing</span><span class="o">.</span><span class="n">current_ranking</span><span class="o">.</span><span class="n">run!</span>

<span class="c1"># 処理を停止</span>
<span class="n">processing</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">run!</span>
</code></pre></div>
<h3 id="109">10.9 タイムアウト付き実行<a class="headerlink" href="#109" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_timeout</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_seconds</span><span class="p">)</span>
<span class="w">  </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span>
<span class="w">    </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">false</span>

<span class="w">    </span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="o">.</span><span class="n">run!</span>
<span class="w">      </span><span class="n">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">completed</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="ss">success</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">thread</span><span class="o">.</span><span class="n">kill</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="ss">success</span><span class="p">:</span><span class="w"> </span><span class="kp">false</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Timeout&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 使用例</span>
<span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">sleep</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">);</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="p">}</span>
<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">with_timeout</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span><span class="w">  </span><span class="c1"># { success: true, value: 42 }</span>
<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">with_timeout</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span><span class="w">  </span><span class="c1"># { success: false, error: &#39;Timeout&#39; }</span>
</code></pre></div>
<h3 id="1010">10.10 一定時間の結果収集<a class="headerlink" href="#1010" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">collect_for</span><span class="p">(</span><span class="n">producer_io</span><span class="p">,</span><span class="w"> </span><span class="n">duration_seconds</span><span class="p">)</span>
<span class="w">  </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">collected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Ref</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span>
<span class="w">    </span><span class="n">cancel_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="ss">cancelled</span><span class="p">:</span><span class="w"> </span><span class="kp">false</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">producer_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="k">until</span><span class="w"> </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">producer_io</span><span class="o">.</span><span class="n">run!</span>
<span class="w">        </span><span class="n">collected</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">arr</span><span class="o">|</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">[</span><span class="n">result</span><span class="o">]</span><span class="w"> </span><span class="p">}</span><span class="o">.</span><span class="n">run!</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="nb">sleep</span><span class="p">(</span><span class="n">duration_seconds</span><span class="p">)</span>
<span class="w">    </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
<span class="w">    </span><span class="n">producer_thread</span><span class="o">.</span><span class="n">kill</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">producer_thread</span><span class="o">.</span><span class="n">alive?</span>

<span class="w">    </span><span class="n">collected</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">run!</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 0.5秒間、サイコロを振り続けて結果を収集</span>
<span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collect_for</span><span class="p">(</span><span class="n">cast_the_die</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span>
</code></pre></div>
<h3 id="1011">10.11 並列マップ更新<a class="headerlink" href="#1011" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="no">Update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:key</span><span class="p">,</span><span class="w"> </span><span class="ss">:value</span><span class="p">,</span><span class="w"> </span><span class="ss">keyword_init</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">apply_updates</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>
<span class="w">  </span><span class="no">Ref</span><span class="o">.</span><span class="n">of</span><span class="p">({})</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">map_ref</span><span class="o">|</span>
<span class="w">    </span><span class="n">ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updates</span><span class="o">.</span><span class="n">map</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">update</span><span class="o">|</span>
<span class="w">      </span><span class="n">map_ref</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">m</span><span class="o">|</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">key</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">update</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">par_sequence</span><span class="p">(</span><span class="n">ios</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">map_ref</span><span class="o">.</span><span class="n">get</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 使用例</span>
<span class="n">updates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">  </span><span class="no">Update</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">  </span><span class="no">Update</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w">  </span><span class="no">Update</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="o">]</span>
<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apply_updates</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span><span class="w">  </span><span class="c1"># { &#39;a&#39; =&gt; 1, &#39;b&#39; =&gt; 2, &#39;c&#39; =&gt; 3 }</span>
</code></pre></div>
<h3 id="1012-producer-consumer">10.12 Producer-Consumer パターン<a class="headerlink" href="#1012-producer-consumer" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RefQueue</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span>
<span class="w">    </span><span class="vi">@ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Ref</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">enqueue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="w">    </span><span class="vi">@ref</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">arr</span><span class="o">|</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">[</span><span class="n">value</span><span class="o">]</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">dequeue</span>
<span class="w">    </span><span class="vi">@ref</span><span class="o">.</span><span class="n">modify</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">arr</span><span class="o">|</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">arr</span><span class="o">.</span><span class="n">empty?</span>
<span class="w">        </span><span class="o">[</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="kp">nil</span><span class="o">]</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="o">[</span><span class="n">arr</span><span class="o">[</span><span class="mi">1</span><span class="o">..]</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="o">[</span><span class="mi">0</span><span class="o">]]</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span><span class="w"> </span><span class="nf">producer_consumer</span><span class="p">(</span><span class="n">producer_io</span><span class="p">,</span><span class="w"> </span><span class="n">consumer_fn</span><span class="p">,</span><span class="w"> </span><span class="n">duration_seconds</span><span class="p">)</span>
<span class="w">  </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">RefQueue</span><span class="o">.</span><span class="n">new</span>
<span class="w">    </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Ref</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span>
<span class="w">    </span><span class="n">cancel_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="ss">cancelled</span><span class="p">:</span><span class="w"> </span><span class="kp">false</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="c1"># プロデューサースレッド</span>
<span class="w">    </span><span class="n">producer_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="k">until</span><span class="w"> </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">producer_io</span><span class="o">.</span><span class="n">run!</span>
<span class="w">        </span><span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c1"># コンシューマースレッド</span>
<span class="w">    </span><span class="n">consumer_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="k">until</span><span class="w"> </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue</span><span class="o">.</span><span class="n">dequeue</span><span class="o">.</span><span class="n">run!</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">value</span>
<span class="w">          </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumer_fn</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="w">          </span><span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">arr</span><span class="o">|</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">[</span><span class="n">result</span><span class="o">]</span><span class="w"> </span><span class="p">}</span><span class="o">.</span><span class="n">run!</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">          </span><span class="nb">sleep</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">001</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="nb">sleep</span><span class="p">(</span><span class="n">duration_seconds</span><span class="p">)</span>
<span class="w">    </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
<span class="w">    </span><span class="n">producer_thread</span><span class="o">.</span><span class="n">kill</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">producer_thread</span><span class="o">.</span><span class="n">alive?</span>
<span class="w">    </span><span class="n">consumer_thread</span><span class="o">.</span><span class="n">kill</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">consumer_thread</span><span class="o">.</span><span class="n">alive?</span>

<span class="w">    </span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">run!</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<hr />
<h2 id="_5">まとめ<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="part-v_1">Part V で学んだこと<a class="headerlink" href="#part-v_1" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI0MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODExcHg7aGVpZ2h0OjI0MHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDgxMSAyNDAiIHdpZHRoPSI4MTFweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIFBhcnQgVjogPz8/Py0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iUGFydCBWLiAuLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfUGFydCBWLiAuLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyMi41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijc5MyIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNS40ODYxIiB4PSIzNTAuNzU3IiB5PSIyNi45OTUxIj5QYXJ0IFY6ICYjMjAwMDY7JiMzNDg5MjsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBjaDEwLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJjaDEwIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImNsdXN0ZXJfY2gxMCI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIxNTUuNTkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI3NDUiIHg9IjM2IiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0Ny40ODIzIiB4PSIzODQuNzU4OSIgeT0iNjkuOTk1MSI+JiMzMTUzMjsxMCYjMzE0NTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IFJlZj8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSZWYuLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X1JlZi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTY5LjI2OSIgeD0iNTIuMzciIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQ5LjI2OSIgeD0iNjIuMzciIHk9IjEwNS45OTUxIj5SZWYmIzY1Mjg4OyYjMTI0NTA7JiMxMjQ4ODsmIzEyNTExOyYjMTI0ODM7JiMxMjQ2MzsmIzIxNDQyOyYjMjkwMzE7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcGFyX3NlcXVlbmNlPz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9InBhcl9zZXF1ZW5jZS4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfcGFyX3NlcXVlbmNlLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyMDEuNjg1MiIgeD0iMjU2LjE2IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE4MS42ODUyIiB4PSIyNjYuMTYiIHk9IjEwNS45OTUxIj5wYXJfc2VxdWVuY2UmIzY1Mjg4OyYjMjAwMDY7JiMyMTAxNTsmIzIzNDU1OyYjMzQ4OTI7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgRmliZXJIYW5kbGU/Pz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iRmliZXJIYW5kbGUuLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5X0ZpYmVySGFuZGxlLi4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyNzIuNTY2NyIgeD0iNDkyLjcyIiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI1Mi41NjY3IiB4PSI1MDIuNzIiIHk9IjEwNS45OTUxIj5GaWJlckhhbmRsZSYjNjUyODg7JiMxMjQ5NjsmIzEyNDgzOyYjMTI0NjM7JiMxMjQ2NDsmIzEyNTIxOyYjMTI0NTQ7JiMxMjUzMTsmIzEyNDg5OyYjMjM0NTU7JiMzNDg5MjsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSB3aXRoX3RpbWVvdXQtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0id2l0aF90aW1lb3V0IiBkYXRhLXNvdXJjZS1saW5lPSI4IiBkYXRhLXVpZD0iZW50MDAwNyIgaWQ9ImVudGl0eV93aXRoX3RpbWVvdXQiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExMS4yNTk4IiB4PSI4MS4zNyIgeT0iMTcyLjI5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTEuMjU5OCIgeD0iOTEuMzciIHk9IjE4OC4yODUxIj53aXRoX3RpbWVvdXQ8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUHJvZHVjZXItQ29uc3VtZXItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUHJvZHVjZXItQ29uc3VtZXIiIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iZW50aXR5X1Byb2R1Y2VyLUNvbnN1bWVyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNTkuMDI5MyIgeD0iMjI3LjQ5IiB5PSIxNzIuMjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzkuMDI5MyIgeD0iMjM3LjQ5IiB5PSIxODguMjg1MSI+UHJvZHVjZXItQ29uc3VtZXI8L3RleHQ+PC9nPjwhLS1TUkM9W0tvcDlJQ3JETElaOElTcEN1LThnSWFxa0lTbkJwcWJMSzBmOEIyZkgyQkRJVUI5WnNPazVGS19SYnBzVnFBUWFLOHNpdkZjUURPTzZwclNsSzU5OEI1UDhwWjBxMDRlZDluUWJBMlc1ZlFRenR6Rm5rNmRIdS1RRW55dHA3cFN0RnN2UV94SV93TmRoeWxUeEVmTVdnV2VJWS1BQkttakJLX0VJS3U3QVdKT3p4UFotVERyeWU3cjhnam1vYXJBQkYxQnBLZDkwWVh1dEp1Mk96aFhmbS1GY2JPLVJiWnJrdGxvdWtIRDNNdGJjSUtQeUlNUGtRZHZmMkttaWUyV19mSkd2aktaTkVKLWxrM0d0aktZOWd2UWg1VzAwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_6">主要コンポーネント<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ref</code></td>
<td>スレッドセーフな共有状態</td>
</tr>
<tr>
<td><code>par_sequence</code></td>
<td>IO のリストを並列実行</td>
</tr>
<tr>
<td><code>par_map2</code></td>
<td>2つの IO を並列実行して結合</td>
</tr>
<tr>
<td><code>FiberHandle</code></td>
<td>バックグラウンド実行の制御</td>
</tr>
<tr>
<td><code>with_timeout</code></td>
<td>タイムアウト付き実行</td>
</tr>
<tr>
<td><code>RefQueue</code></td>
<td>スレッドセーフなキュー</td>
</tr>
</tbody>
</table>
<h3 id="ruby-scala">Ruby と Scala の対応<a class="headerlink" href="#ruby-scala" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Scala (Cats Effect)</th>
<th>Ruby</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ref[IO, A]</code></td>
<td><code>Ref</code> クラス</td>
</tr>
<tr>
<td><code>Ref.of[IO, A](initial)</code></td>
<td><code>Ref.of(initial)</code></td>
</tr>
<tr>
<td><code>ref.get</code></td>
<td><code>ref.get</code></td>
</tr>
<tr>
<td><code>ref.update(f)</code></td>
<td><code>ref.update { }</code></td>
</tr>
<tr>
<td><code>parSequence</code></td>
<td><code>par_sequence</code></td>
</tr>
<tr>
<td><code>Fiber</code></td>
<td><code>FiberHandle</code></td>
</tr>
<tr>
<td><code>fiber.start</code></td>
<td><code>start(io)</code></td>
</tr>
<tr>
<td><code>fiber.cancel</code></td>
<td><code>fiber.cancel</code></td>
</tr>
</tbody>
</table>
<h3 id="_7">キーポイント<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Ref</strong>: 複数のスレッドから安全にアクセスできるアトミックな参照</li>
<li><strong>par_sequence</strong>: IO のリストを並列実行して結果を集約</li>
<li><strong>FiberHandle</strong>: バックグラウンドで実行し、後で結果を取得/キャンセル</li>
<li><strong>Mutex</strong>: Ruby のスレッドセーフ機構を活用</li>
<li><strong>Producer-Consumer</strong>: キューを介したスレッド間通信</li>
</ol>
<h3 id="_8">設計パターン<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI0MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTA5NXB4O2hlaWdodDoyNDBweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMDk1IDI0MCIgd2lkdGg9IjEwOTVweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMyIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJjbHVzdGVyXy4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyMi41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEwNzciIHg9IjEyIiB5PSIxMiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNDczLjUwMDMiIHk9IjI2Ljk5NTEiPiYjMjAwMDY7JiMzNDg5MjsmIzIwOTY2OyYjMjk3MDI7JiMxMjM5ODsmIzM1MzczOyYjMzUzMzY7JiMxMjQ5NzsmIzEyNDc5OyYjMTI1NDA7JiMxMjUzMTs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHAxLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwMSIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX3AxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjczLjI5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMzEzIiB4PSIzNiIgeT0iNTUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMyLjIxMzQiIHg9IjEyNi4zOTMzIiB5PSI2OS45OTUxIj4mIzEyNDk3OyYjMTI0Nzk7JiMxMjU0MDsmIzEyNTMxOzE6ICYjMjAwMDY7JiMyMTAxNTsmIzM4NTk4OyYjMzIwMDQ7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBwMi0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0icDIiIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iY2x1c3Rlcl9wMiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSI3My4yOSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM1OSIgeD0iMzczIiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzIuMjEzNCIgeD0iNDg2LjM5MzMiIHk9IjY5Ljk5NTEiPiYjMTI0OTc7JiMxMjQ3OTsmIzEyNTQwOyYjMTI1MzE7MjogJiMyMDg0OTsmIzI2Mzc3OyYjMjkzNjY7JiMyNDkwNzs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHAzLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwMyIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iY2x1c3Rlcl9wMyI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIxNTUuNTkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIzMDkiIHg9Ijc1NiIgeT0iNTUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjE2LjIxMyIgeD0iODAyLjM5MzUiIHk9IjY5Ljk5NTEiPiYjMTI0OTc7JiMxMjQ3OTsmIzEyNTQwOyYjMTI1MzE7MzogJiMxMjQ5NjsmIzEyNDgzOyYjMTI0NjM7JiMxMjQ2NDsmIzEyNTIxOyYjMTI0NTQ7JiMxMjUzMTsmIzEyNDg5OyYjMjA5NjY7JiMyOTcwMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/IElPID8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLiBJTyAuLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJlbnRpdHlfLi4uIElPIC4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNTYuMDQ4MyIgeD0iNTEuOTgiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTM2LjA0ODMiIHg9IjYxLjk4IiB5PSIxMDUuOTk1MSI+JiMzNTA3OTsmIzI1OTY4OyYjMTIzOTg7IElPICYjMTI0MzQ7JiMyMDAwNjsmIzIxMDE1OyYjMjM0NTU7JiMzNDg5Mjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5Xy4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI4OS45OTk3IiB4PSIyNDMiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iMjUzIiB5PSIxMDUuOTk1MSI+JiMzMjA4MDsmIzI2NTI0OyYjMTI0MzQ7JiMzODU5ODsmIzMyMDA0OzwvdGV4dD48L2c+PCEtLWVudGl0eSBSZWYgPz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlJlZiAuLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEwIiBkYXRhLXVpZD0iZW50MDAwNyIgaWQ9ImVudGl0eV9SZWYgLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzEuNzE5NCIgeD0iMzg5LjE0IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS43MTk0IiB4PSIzOTkuMTQiIHk9IjEwNS45OTUxIj5SZWYgJiMxMjM5MTsmIzI5MzY2OyYjMjQ5MDc7JiMxMjQzNDsmIzIwODQ5OyYjMjYzNzc7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iZW50aXR5Xy4uLi4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE1OS45OTk0IiB4PSI1NTYiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTM5Ljk5OTQiIHg9IjU2NiIgeT0iMTA1Ljk5NTEiPiYjMzUwNzk7JiMyNTk2ODsmIzEyMzk4OyYjMTI0NzM7JiMxMjUyNDsmIzEyNDgzOyYjMTI0ODk7JiMxMjM2NDsmIzI2MzU2OyYjMjYwMzI7PC90ZXh0PjwvZz48IS0tZW50aXR5IEZpYmVySGFuZGxlID8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJGaWJlckhhbmRsZSAuLi4iIGRhdGEtc291cmNlLWxpbmU9IjE1IiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV9GaWJlckhhbmRsZSAuLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE1MS4wMTc0IiB4PSI3NzIuNDkiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMxLjAxNzQiIHg9Ijc4Mi40OSIgeT0iMTA1Ljk5NTEiPkZpYmVySGFuZGxlICYjMTIzOTE7JiMzNjIxNTsmIzIxMjA1OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTYiIGRhdGEtdWlkPSJlbnQwMDExIiBpZD0iZW50aXR5Xy4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI4OS45OTk3IiB4PSI5NTkiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjkuOTk5NyIgeD0iOTY5IiB5PSIxMDUuOTk1MSI+JiMyMTA0NjsmIzI0NDgxOyYjMTI0MzQ7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/Lz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjE3IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV8uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNTAuNzE2MiIgeD0iNzcyLjY0IiB5PSIxNzIuMjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzAuNzE2MiIgeD0iNzgyLjY0IiB5PSIxODguMjg1MSI+JiMyNDQ2MDsmIzEyMzkxOyYjMzIwODA7JiMyNjUyNDsmIzEyNDM0OyYjMjE0NjI7JiMyNDQ3MTsvJiMyMDU3MjsmIzI3NDkwOzwvdGV4dD48L2c+PCEtLVNSQz1bVlAzVklpOUc3Q1Zsem5JZGxLMmVUdGswZ0FrV0RyWHdBaTY2QkVfMll2c0pFZEZHWWJKMktIWW41RDhNZ0hONFY5WFZ2LXBxNVhxdkVZSWVzel90dHVWVkhrSzg3c0RLQmZiNUl6RGlkQS1PcmM0OThfdGhGSEh6WnBOMm5BLTNDblEzYUhZdUcyLTFwODUtMGR0THFVY3dWcnRBNjRaNmNUbHp4ak1Kb1BjRXAxREtwYVhfdGhHQkkxU0YzVHdFUDJkUXNLTDBoZklOWlVfYWVCeHE5NUVWdG1QSU41UGVMVXNsalFvMU1FczUxeXRhVkNQaEJSTU1KVFZzeTA0MnZyNjlpYjF2elR5aUczdzBGVzZiRzlsV1VCbXR1UHRlbHpjU1dPM3dZbTF2MVg4MTdHODl2THRjclRTS0kydTVzSWhrT3RsUmowZ29JR0E5d0hqaGpMU1NwOXNuazJfbm5GbVFkOWxxNzdpQnpqS3BzNE03blRyRHZXSHlUQi0wZ191MF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_9">次のステップ<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>Part VI では、以下のトピックを学びます:</p>
<ul>
<li>実践的なアプリケーション構築</li>
<li>外部 API との連携</li>
<li>テスト戦略</li>
</ul>
<hr />
<h2 id="_10">演習問題<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<h3 id="1-ref">問題 1: Ref の基本<a class="headerlink" href="#1-ref" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。カウンターを 0 から始めて、3回インクリメントした結果を返します。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">increment_three_times</span>
<span class="w">  </span><span class="sc">??</span><span class="p">?</span>
<span class="k">end</span>

<span class="c1"># 期待される動作</span>
<span class="n">increment_three_times</span><span class="o">.</span><span class="n">run!</span><span class="w">  </span><span class="c1"># 3</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">increment_three_times</span>
<span class="w">  </span><span class="no">Ref</span><span class="o">.</span><span class="n">of</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">counter</span><span class="o">|</span>
<span class="w">    </span><span class="n">counter</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">counter</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="n">counter</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span>
<span class="w">          </span><span class="n">counter</span><span class="o">.</span><span class="n">get</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># または</span>
<span class="k">def</span><span class="w"> </span><span class="nf">increment_three_times</span>
<span class="w">  </span><span class="no">Ref</span><span class="o">.</span><span class="n">of</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">counter</span><span class="o">|</span>
<span class="w">    </span><span class="mi">3</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">counter</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="o">.</span><span class="n">run!</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">counter</span><span class="o">.</span><span class="n">get</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>

</details>

<h3 id="2">問題 2: 並列実行<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。3つの IO を並列実行し、結果の合計を返します。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sum_parallel</span><span class="p">(</span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">io2</span><span class="p">,</span><span class="w"> </span><span class="n">io3</span><span class="p">)</span>
<span class="w">  </span><span class="sc">??</span><span class="p">?</span>
<span class="k">end</span>

<span class="c1"># 期待される動作</span>
<span class="n">sum_parallel</span><span class="p">(</span><span class="no">IO</span><span class="o">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">run!</span><span class="w">  </span><span class="c1"># 6</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sum_parallel</span><span class="p">(</span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">io2</span><span class="p">,</span><span class="w"> </span><span class="n">io3</span><span class="p">)</span>
<span class="w">  </span><span class="n">par_sequence</span><span class="p">(</span><span class="o">[</span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">io2</span><span class="p">,</span><span class="w"> </span><span class="n">io3</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">fmap</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">results</span><span class="o">|</span><span class="w"> </span><span class="n">results</span><span class="o">.</span><span class="n">sum</span><span class="w"> </span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>

</details>

<h3 id="3">問題 3: 並行カウント<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。複数の IO を並行実行し、そのうち偶数を返した回数をカウントします。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">count_evens</span><span class="p">(</span><span class="n">ios</span><span class="p">)</span>
<span class="w">  </span><span class="sc">??</span><span class="p">?</span>
<span class="k">end</span>

<span class="c1"># 使用例</span>
<span class="n">ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="no">IO</span><span class="o">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">pure</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">]</span>
<span class="n">count_evens</span><span class="p">(</span><span class="n">ios</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span><span class="w">  </span><span class="c1"># 3</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">count_evens</span><span class="p">(</span><span class="n">ios</span><span class="p">)</span>
<span class="w">  </span><span class="no">Ref</span><span class="o">.</span><span class="n">of</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">counter</span><span class="o">|</span>
<span class="w">    </span><span class="n">check_ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ios</span><span class="o">.</span><span class="n">map</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">io</span><span class="o">|</span>
<span class="w">      </span><span class="n">io</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">n</span><span class="o">|</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="o">.</span><span class="n">even?</span>
<span class="w">          </span><span class="n">counter</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">c</span><span class="o">|</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">          </span><span class="no">IO</span><span class="o">.</span><span class="n">unit</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">par_sequence</span><span class="p">(</span><span class="n">check_ios</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">counter</span><span class="o">.</span><span class="n">get</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>

</details>

<h3 id="4">問題 4: タイムアウト付き実行<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。指定時間後に処理をキャンセルし、それまでに蓄積された結果を返します。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">collect_for</span><span class="p">(</span><span class="n">producer_io</span><span class="p">,</span><span class="w"> </span><span class="n">duration_seconds</span><span class="p">)</span>
<span class="w">  </span><span class="sc">??</span><span class="p">?</span>
<span class="k">end</span>

<span class="c1"># 期待される動作</span>
<span class="c1"># 0.5秒間、50msごとに乱数を生成してリストに追加</span>
<span class="c1"># 約10個の要素が返される</span>
<span class="n">producer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">sleep</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">05</span><span class="p">);</span><span class="w"> </span><span class="nb">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">collect_for</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">collect_for</span><span class="p">(</span><span class="n">producer_io</span><span class="p">,</span><span class="w"> </span><span class="n">duration_seconds</span><span class="p">)</span>
<span class="w">  </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">collected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Ref</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span>
<span class="w">    </span><span class="n">cancel_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="ss">cancelled</span><span class="p">:</span><span class="w"> </span><span class="kp">false</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">producer_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="k">until</span><span class="w"> </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">producer_io</span><span class="o">.</span><span class="n">run!</span>
<span class="w">        </span><span class="n">collected</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">arr</span><span class="o">|</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">[</span><span class="n">result</span><span class="o">]</span><span class="w"> </span><span class="p">}</span><span class="o">.</span><span class="n">run!</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="nb">sleep</span><span class="p">(</span><span class="n">duration_seconds</span><span class="p">)</span>
<span class="w">    </span><span class="n">cancel_flag</span><span class="o">[</span><span class="ss">:cancelled</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
<span class="w">    </span><span class="n">producer_thread</span><span class="o">.</span><span class="n">kill</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">producer_thread</span><span class="o">.</span><span class="n">alive?</span>

<span class="w">    </span><span class="n">collected</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">run!</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>

</details>

<h3 id="5">問題 5: 並行マップ更新<a class="headerlink" href="#5" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。複数の更新を並行して Map に適用し、最終的な Map を返します。</p>
<div class="highlight"><pre><span></span><code><span class="no">Update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:key</span><span class="p">,</span><span class="w"> </span><span class="ss">:value</span><span class="p">,</span><span class="w"> </span><span class="ss">keyword_init</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">apply_updates</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>
<span class="w">  </span><span class="sc">??</span><span class="p">?</span>
<span class="k">end</span>

<span class="c1"># 期待される動作</span>
<span class="n">updates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">  </span><span class="no">Update</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">  </span><span class="no">Update</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w">  </span><span class="no">Update</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="o">]</span>
<span class="n">apply_updates</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span><span class="w">  </span><span class="c1"># { &#39;a&#39; =&gt; 1, &#39;b&#39; =&gt; 2, &#39;c&#39; =&gt; 3 }</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_updates</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>
<span class="w">  </span><span class="no">Ref</span><span class="o">.</span><span class="n">of</span><span class="p">({})</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">map_ref</span><span class="o">|</span>
<span class="w">    </span><span class="n">ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updates</span><span class="o">.</span><span class="n">map</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">update</span><span class="o">|</span>
<span class="w">      </span><span class="n">map_ref</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">m</span><span class="o">|</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">key</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">update</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">par_sequence</span><span class="p">(</span><span class="n">ios</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">map_ref</span><span class="o">.</span><span class="n">get</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>

</details>

<h3 id="6">問題 6: レース<a class="headerlink" href="#6" title="Permanent link">&para;</a></h3>
<p>2つの IO のうち、先に完了した方の結果を返す関数を実装してください。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">race</span><span class="p">(</span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">io2</span><span class="p">)</span>
<span class="w">  </span><span class="sc">??</span><span class="p">?</span>
<span class="k">end</span>

<span class="c1"># 期待される動作</span>
<span class="n">slow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">sleep</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="s1">&#39;slow&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="n">fast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">sleep</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">05</span><span class="p">);</span><span class="w"> </span><span class="s1">&#39;fast&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="n">race</span><span class="p">(</span><span class="n">slow</span><span class="p">,</span><span class="w"> </span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">run!</span><span class="w">  </span><span class="c1"># &#39;fast&#39;</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">race</span><span class="p">(</span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">io2</span><span class="p">)</span>
<span class="w">  </span><span class="no">IO</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span>
<span class="w">    </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">false</span>
<span class="w">    </span><span class="n">mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Mutex</span><span class="o">.</span><span class="n">new</span>
<span class="w">    </span><span class="n">cv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ConditionVariable</span><span class="o">.</span><span class="n">new</span>

<span class="w">    </span><span class="o">[</span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">io2</span><span class="o">].</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">io</span><span class="o">|</span>
<span class="w">      </span><span class="no">Thread</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="o">.</span><span class="n">run!</span>
<span class="w">        </span><span class="n">mutex</span><span class="o">.</span><span class="n">synchronize</span><span class="w"> </span><span class="k">do</span>
<span class="w">          </span><span class="k">unless</span><span class="w"> </span><span class="n">done</span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span>
<span class="w">            </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">true</span>
<span class="w">            </span><span class="n">cv</span><span class="o">.</span><span class="n">signal</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">mutex</span><span class="o">.</span><span class="n">synchronize</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">cv</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="n">done</span>
<span class="w">      </span><span class="n">result</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>

</details>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>