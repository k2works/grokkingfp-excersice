
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Scala、Java、F#、C# で学ぶ関数型プログラミング">
      
      
        <meta name="author" content="Project Team">
      
      
      
        <link rel="prev" href="../part-4/">
      
      
        <link rel="next" href="../part-6/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Part V - 並行処理 - Grokking Functional Programming</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#part-v" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Grokking Functional Programming" class="md-header__button md-logo" aria-label="Grokking Functional Programming" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Grokking Functional Programming
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Part V - 並行処理
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/grokkingfp-excersice" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    grokkingfp-excersice
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../scala/" class="md-tabs__link">
          
  
  
  Scala

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../java/" class="md-tabs__link">
          
  
  
  Java

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  F#

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../csharp/" class="md-tabs__link">
          
  
  
  C#

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Grokking Functional Programming" class="md-nav__button md-logo" aria-label="Grokking Functional Programming" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Grokking Functional Programming
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/grokkingfp-excersice" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    grokkingfp-excersice
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Scala
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Scala
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO と副作用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Java
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Java
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO と副作用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    F#
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    F#
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - 非同期処理とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      
        第10章: 並行・並列処理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第10章: 並行・並列処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 並行処理の課題
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 チェックインのリアルタイム集計
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.2 チェックインのリアルタイム集計">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        トップ3都市の計算（純粋関数）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103-ref-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.3 Ref - スレッドセーフな共有状態
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.3 Ref - スレッドセーフな共有状態">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ref" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ref の主要メソッド
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用例
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#104-parsequence-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.4 parSequence - 並列実行
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.4 parSequence - 並列実行">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#async" class="md-nav__link">
    <span class="md-ellipsis">
      
        複数の Async を並列実行
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#105" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.5 サイコロを並行して振る
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#106-fiber-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.6 Fiber - キャンセル可能な非同期タスク
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.6 Fiber - キャンセル可能な非同期タスク">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#foreverm-" class="md-nav__link">
    <span class="md-ellipsis">
      
        foreverM - 永遠に繰り返す
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#107" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.7 チェックイン処理の並行版
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.7 チェックイン処理の並行版">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        チェックインの保存
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        ランキングの継続的な更新
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#108" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.8 呼び出し元に制御を返す
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.8 呼び出し元に制御を返す">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用例
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#109-mailboxprocessoragent" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.9 MailboxProcessor（Agent）による並行処理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.9 MailboxProcessor（Agent）による並行処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        カウンターエージェント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        カウンターの使用
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        チェックインエージェント
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1010" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.10 並列処理ユーティリティ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1011" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.11 タイムアウト付き実行
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1012" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.12 偶数カウント（並行版）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scala" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scala との比較
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scala との比較">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ref_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ref の比較
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        並列実行の比較
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fiber" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fiber の比較
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentactor" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agent（Actor）の比較
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        まとめ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="まとめ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-v_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part V で学んだこと
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        主要コンポーネント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        キーポイント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        設計パターン
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        演習問題
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="演習問題">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-ref" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 1: Ref の基本
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 2: 並列実行
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 3: 並行カウント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-mailboxprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 4: MailboxProcessor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 5: タイムアウト付き収集
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    C#
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    C#
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - 非同期処理とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="part-v">Part V: 並行処理<a class="headerlink" href="#part-v" title="Permanent link">&para;</a></h1>
<p>本章では、関数型プログラミングにおける並行処理を学びます。Ref によるスレッドセーフな共有状態管理、Async.Parallel による並列実行、そして MailboxProcessor（Agent）による軽量並行処理の構築方法を習得します。</p>
<hr />
<h2 id="10">第10章: 並行・並列処理<a class="headerlink" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="101">10.1 並行処理の課題<a class="headerlink" href="#101" title="Permanent link">&para;</a></h3>
<p>従来の並行処理には多くの課題があります:</p>
<ul>
<li>デッドロック</li>
<li>競合状態（Race Condition）</li>
<li>共有状態の管理の複雑さ</li>
<li>スレッドのオーバーヘッド</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQyN3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6OTU4cHg7aGVpZ2h0OjQyN3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDk1OCA0MjciIHdpZHRoPSI5NThweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl8uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjQwOS44OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijk0MCIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSI0MTIuMDAwMyIgeT0iMjYuOTk1MSI+JiMyNDQ2NzsmIzI2NDY5OyYjMTIzOTg7JiMyMDAwNjsmIzM0ODkyOyYjMjA5NjY7JiMyOTcwMjsmIzEyMzk4OyYjMjE4Mzk7JiMzODk4ODs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHByb2JsZW1zLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwcm9ibGVtcyIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX3Byb2JsZW1zIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyNS41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjMxMyIgeD0iNDQiIHk9IjYzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI3Ljk5OTkiIHg9IjE4Ni41MDAxIiB5PSI3Ny45OTUxIj4mIzIxODM5OyYjMzg5ODg7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBzb2x1dGlvbnMtLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InNvbHV0aW9ucyIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iY2x1c3Rlcl9zb2x1dGlvbnMiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMTkwLjU5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNTIzIiB4PSIzOTciIHk9IjE5OS4zIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk2LjE2NzciIHg9IjYxMC40MTYyIiB5PSIyMTQuMjk1MSI+RiMgJiMxMjM5MTsmIzEyMzk4OyYjMzUyOTk7JiMyNzc3MDsmIzMxNTc0OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0iZW50MDAwNCIgaWQ9ImVudGl0eV8uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEwMy45OTk2IiB4PSI3NSIgeT0iMTA2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iODUiIHk9IjEyMS45OTUxIj4mIzEyNDg3OyYjMTI0ODM7JiMxMjQ4OTsmIzEyNTI1OyYjMTI0ODM7JiMxMjQ2Mzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwNSIgaWQ9ImVudGl0eV8uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI3NS45OTk4IiB4PSIyMTQiIHk9IjEwNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjIyNCIgeT0iMTIxLjk5NTEiPiYjMzE0Nzg7JiMyMTUxMjsmIzI5MzY2OyYjMjQ5MDc7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNyIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJlbnRpdHlfLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTE3Ljk5OTYiIHg9IjY4IiB5PSIyNDIuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9Ijc4IiB5PSIyNTguMjk1MSI+JiMyMTQ4NzsmIzIyNzkzOyYjMjkzNjY7JiMyNDkwNzsmIzEyMzk4OyYjMjA4NDk7JiMyNjM3Nzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iOCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMDMuOTk5NiIgeD0iMjIxIiB5PSIyNDIuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjk5OTYiIHg9IjIzMSIgeT0iMjU4LjI5NTEiPiYjMTI0NzM7JiMxMjUyNDsmIzEyNDgzOyYjMTI0ODk7JiMzMTY0OTsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImVudGl0eV8uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iNDQ3IiB5PSIyNDIuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSI0NTciIHk9IjI1OC4yOTUxIj4mIzEyNDUyOyYjMTI1MTE7JiMxMjUxNzsmIzEyNTQwOyYjMTI0Nzk7JiMxMjUwMjsmIzEyNTIzOyYjMTI0ODc7JiMxMjU0MDsmIzEyNDc5OzwvdGV4dD48L2c+PCEtLWVudGl0eSBSZWY/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlJlZi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV9SZWYuLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxODMuMjY4OSIgeD0iNjQyLjM3IiB5PSIyNDIuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2My4yNjg5IiB4PSI2NTIuMzciIHk9IjI1OC4yOTUxIj5SZWYmIzY1Mjg4OyYjMTI1MjU7JiMxMjQ4MzsmIzEyNDYzOyYjMTI1MDU7JiMxMjU0MDsmIzEyNDczOyYjMjE0NDI7JiMyOTAzMTsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSBNYWlsYm94UHJvY2Vzc29yP0FnZW50Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJNYWlsYm94UHJvY2Vzc29yLkFnZW50LiIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGRhdGEtdWlkPSJlbnQwMDExIiBpZD0iZW50aXR5X01haWxib3hQcm9jZXNzb3IuQWdlbnQuIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyMTEuNTk3NSIgeD0iNDIxLjIiIHk9IjM0My41OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE5MS41OTc1IiB4PSI0MzEuMiIgeT0iMzU5LjU4NTEiPk1haWxib3hQcm9jZXNzb3ImIzY1Mjg4O0FnZW50JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgQXN5bmMgPz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iQXN5bmMgLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjE1IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9Bc3luYyAuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMjIwLjE3NjEiIHg9IjY2Ny45MSIgeT0iMzQzLjU5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjAwLjE3NjEiIHg9IjY3Ny45MSIgeT0iMzU5LjU4NTEiPkFzeW5jICYjMTIzOTU7JiMxMjQyNDsmIzEyNDI3OyYjMjM0NTk7JiMzNTMyODsmIzMwMzQwOyYjMTIzOTQ7JiMyMDAwNjsmIzM0ODkyOyYjMjA5NjY7JiMyOTcwMjs8L3RleHQ+PC9nPjwhLS1saW5rIHByb2JsZW1zIHRvIHNvbHV0aW9ucy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJwcm9ibGVtcyIgZGF0YS1lbnRpdHktMj0ic29sdXRpb25zIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19wcm9ibGVtc19zb2x1dGlvbnMiPjxwYXRoIGQ9Ik0zNTcuNTE2LDExOS4wNzYgQzM1Ny44MDY5LDExOS4xMDc3IDM1OC4xMDQ5LDExOS4xNDAyIDM1OC40MDk4LDExOS4xNzM0IEMzNTkuMDE5NywxMTkuMjM5OSAzNTkuNjU3NCwxMTkuMzA5NCAzNjAuMzIyNiwxMTkuMzgxOSBDMzYxLjY1MywxMTkuNTI2OSAzNjMuMDkzLDExOS42ODM5IDM2NC42Mzg2LDExOS44NTI1IEMzNjcuNzI5NywxMjAuMTg5NyAzNzEuMjQzMiwxMjAuNTczMiAzNzUuMTQ2MywxMjAuOTk5NiBDMzkwLjc1ODksMTIyLjcwNTMgNDEyLjYwNjUsMTI1LjA5NzcgNDM4LjYwMywxMjcuOTU5OCBDNDkwLjU5NTksMTMzLjY4NDEgNTU5LjE4NDQsMTQxLjI4NjkgNjI3LjY3ODgsMTQ5LjAzMTIgQzc2NC42Njc1LDE2NC41MiA5MDEuMjgsMTgwLjU3NSA5MDQsMTgzLjMgQzkwNi42NDYzLDE4NS45NTEyIDkwOC43Njg5LDE4OC45NzQ0IDkxMC40NTYsMTkyLjI0MDQgQzkxMS4yOTk1LDE5My44NzM1IDkxMi4wMzQyLDE5NS41NjcyIDkxMi42NzA5LDE5Ny4zMDU2IEM5MTIuODMwMSwxOTcuNzQwMiA5MTIuOTgzMSwxOTguMTc3NiA5MTMuMTMwMywxOTguNjE3NSBDOTEzLjIwMzgsMTk4LjgzNzQgOTExLjQ1MTMsMTkzLjM0MjIgOTExLjUyMTksMTkzLjU2MzQiIGZpbGw9Im5vbmUiIGlkPSJwcm9ibGVtcy10by1zb2x1dGlvbnMiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjkxMy4zNDY1LDE5OS4yNzkyLDkxNC40MjAyLDE4OS40ODkxLDkxMS44MjYsMTk0LjUxNiw5MDYuNzk5MSwxOTEuOTIxOCw5MTMuMzQ2NSwxOTkuMjc5MiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSI4NDUuMTciIHk9IjE3MS4zNjY5Ij4mIzM4MzA2OyYjMjU5Njg7JiMyMjQxMTsmIzEyNDUwOyYjMTI1MDM7JiMxMjUyNTsmIzEyNTQwOyYjMTI0ODE7PC90ZXh0PjwvZz48IS0tU1JDPVtMUDNCSmk5RzQ4UnRGQ01uaGRhMTVvUGl0OWFPdHczSzh2QUtiaEdycUhXSlVxTzRYMEdJMHFSWjlMbmhINDBzSDRvWjNwRVU3YlpuMmhSYmFoOHh5X19fZEZiY2pnbUpjZzRhZ3lmZkJIT3BnNkI5TWFnYkhFOF9UenZwMS10MXRyVHRzWVpwVjVUS1Jfb0lyb2dwSGJhWTVubFhmSVlSOTZsZUlQTGNKMy1Xb0NPSGFIM28yODFHSEVXNzNwUUtiZXhlWk5jcjg2eDdOZ3dxcWRYYm9EbDVYSFBDb3VzeWYtQkFIM1AxLTVaeTlXT0Q3cVlBTk12R3hzcUpqMXNfU1VncWxENnR3RFQzQTVETkp3c3FoYU1lTTFsWDVRNjN1MkJ4SFFXWno0QktlNW1ERkFKN1N4VW0xYVR1MkZxOWhwMkhTLVJrY2NuVkpnajlfVXAwcTFMZ2NoaFhUb0xJTEJDWWFPSHZoWWEtTkd6UDBMYzkzcmhKam9sblU4dHNVX0o0bUtSLUpraXBua0V4NFZtVENnaXRsVGVkVm9hWFFvQlNYc21rV2xxRl0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h3 id="102">10.2 チェックインのリアルタイム集計<a class="headerlink" href="#102" title="Permanent link">&para;</a></h3>
<p><strong>ソースファイル</strong>: <code>app/fsharp/src/Ch10/ConcurrentProcessing.fs</code></p>
<p>都市へのチェックインをリアルタイムで集計し、ランキングを更新する例を見ていきます。</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">City</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">}</span>
<span class="k">type</span><span class="w"> </span><span class="nc">CityStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">City</span><span class="o">:</span><span class="w"> </span><span class="n">City</span><span class="o">;</span><span class="w"> </span><span class="n">CheckIns</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">}</span>

<span class="c1">// チェックインのシーケンス</span>
<span class="k">let</span><span class="w"> </span><span class="nv">checkIns</span><span class="o">:</span><span class="w"> </span><span class="n">City</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">seq</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">100000</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="k">yield</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Sydney&quot;</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="k">yield</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Dublin&quot;</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="k">yield</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cape Town&quot;</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="k">yield</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lima&quot;</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="k">yield</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Singapore&quot;</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<h4 id="3">トップ3都市の計算（純粋関数）<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">topCities</span><span class="w"> </span><span class="o">(</span><span class="n">n</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">cityCheckIns</span><span class="o">:</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="o">,</span><span class="w"> </span><span class="n">int</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">CityStats</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">cityCheckIns</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Map</span><span class="p">.</span><span class="n">toList</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="o">(</span><span class="n">city</span><span class="o">,</span><span class="w"> </span><span class="n">checkIns</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="n">City</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">city</span><span class="o">;</span><span class="w"> </span><span class="n">CheckIns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkIns</span><span class="w"> </span><span class="o">})</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">sortByDescending</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">stats</span><span class="o">.</span><span class="n">CheckIns</span><span class="o">)</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">truncate</span><span class="w"> </span><span class="n">n</span>
</code></pre></div>
<h3 id="103-ref-">10.3 Ref - スレッドセーフな共有状態<a class="headerlink" href="#103-ref-" title="Permanent link">&para;</a></h3>
<p><strong>Ref</strong> は、複数の並行処理から安全にアクセスできるスレッドセーフな参照です。F# では <code>lock</code> を使って実装します。</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">Ref</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="o">(</span><span class="n">initialValue</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">mutable</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initialValue</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">lockObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">obj</span><span class="bp">()</span>

<span class="w">    </span><span class="sd">/// 現在の値を取得</span>
<span class="w">    </span><span class="k">member</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="nf">Get</span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">lock</span><span class="w"> </span><span class="n">lockObj</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">value</span><span class="o">)</span>

<span class="w">    </span><span class="sd">/// 値を設定</span>
<span class="w">    </span><span class="k">member</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="nf">Set</span><span class="o">(</span><span class="n">newValue</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">unit</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">lock</span><span class="w"> </span><span class="n">lockObj</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">newValue</span><span class="o">)</span>

<span class="w">    </span><span class="sd">/// アトミックに更新</span>
<span class="w">    </span><span class="k">member</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="nf">Update</span><span class="o">(</span><span class="n">f</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">unit</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">lock</span><span class="w"> </span><span class="n">lockObj</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">value</span><span class="o">)</span>

<span class="w">    </span><span class="sd">/// 初期値で Ref を作成</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">member</span><span class="w"> </span><span class="n">Of</span><span class="o">(</span><span class="n">initialValue</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Ref</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">Ref</span><span class="o">(</span><span class="n">initialValue</span><span class="o">)</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI5OHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MzYwcHg7aGVpZ2h0OjI5OHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDM2MCAyOTgiIHdpZHRoPSIzNjBweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIFJlZiA/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9IlJlZiAuLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl9SZWYgLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI4MC44OCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE3NCIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjczLjI0MDEiIHg9IjYyLjM4IiB5PSIyNi45OTUxIj5SZWYgJiMxMjM5ODsmIzI1ODA1OyYjMjAzMTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IGNyZWF0ZS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJjcmVhdGUiIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X2NyZWF0ZSI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iODMuNDk5IiB4PSI1Ny4yNSIgeT0iNDciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My40OTkiIHg9IjY3LjI1IiB5PSI2Mi45OTUxIj5SZWYuT2YoMCk8L3RleHQ+PC9nPjwhLS1lbnRpdHkgdXBkYXRlLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9InVwZGF0ZSIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJlbnRpdHlfdXBkYXRlIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNDEuMzg1NyIgeD0iMjguMzEiIHk9IjE0Ni4zIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIxLjM4NTciIHg9IjM4LjMxIiB5PSIxNjIuMjk1MSI+cmVmLlVwZGF0ZSgoKykgMyk8L3RleHQ+PC9nPjwhLS1lbnRpdHkgZ2V0LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImdldCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfZ2V0Ij48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI3OS42MjMiIHg9IjU5LjE5IiB5PSIyNTQuNTgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1OS42MjMiIHg9IjY5LjE5IiB5PSIyNzAuNTc1MSI+cmVmLkdldCgpPC90ZXh0PjwvZz48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR01OOCIgZGF0YS1zb3VyY2UtbGluZT0iMTMiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iZW50aXR5X0dNTjgiPjxwYXRoIGQ9Ik0yMDIuNSwyNDUuNiBMMjAyLjUsMjg1Ljg2NTYgQTAsMCAwIDAgMCAyMDIuNSwyODUuODY1NiBMMzUzLjUwMDIsMjg1Ljg2NTYgQTAsMCAwIDAgMCAzNTMuNTAwMiwyODUuODY1NiBMMzUzLjUwMDIsMjU1LjYgTDM0My41MDAyLDI0NS42IEwyNDkuMTYsMjQ1LjYgTDExNi44MiwxNjkuMDMgTDI0MS4xNiwyNDUuNiBMMjAyLjUsMjQ1LjYgQTAsMCAwIDAgMCAyMDIuNSwyNDUuNiIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0zNDMuNTAwMiwyNDUuNiBMMzQzLjUwMDIsMjU1LjYgTDM1My41MDAyLDI1NS42IEwzNDMuNTAwMiwyNDUuNiIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyOS4yMTMiIHg9IjIwOC41IiB5PSIyNjIuNjY2OSI+VXBkYXRlICYjMTIzOTk7JiMxMjQ1MDsmIzEyNDg4OyYjMTI1MTE7JiMxMjQ4MzsmIzEyNDYzOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzAuMDAwMiIgeD0iMjA4LjUiIHk9IjI3Ny43OTk3Ij4mIzIwMTgyOyYjMTIzOTg7JiMyMDk2NjsmIzI5NzAyOyYjMTIzOTI7JiMzMTQ3ODsmIzIxNTEyOyYjMTIzNzU7JiMxMjM5NDsmIzEyMzU2OzwvdGV4dD48L2c+PCEtLWxpbmsgY3JlYXRlIHRvIHVwZGF0ZS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJjcmVhdGUiIGRhdGEtZW50aXR5LTI9InVwZGF0ZSIgZGF0YS1zb3VyY2UtbGluZT0iOCIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rX2NyZWF0ZV91cGRhdGUiPjxwYXRoIGQ9Ik05OSw2OS41NyBDOTksODguMTkgOTksMTIxLjAzIDk5LDEzOS44MiIgZmlsbD0ibm9uZSIgaWQ9ImNyZWF0ZS10by11cGRhdGUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9Ijk5LDE0NS44MiwxMDMsMTM2LjgyLDk5LDE0MC44Miw5NSwxMzYuODIsOTksMTQ1LjgyIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjYiIHg9IjEwMCIgeT0iMTEyLjM2NjkiPiYjMjAzMTY7JiMyNTEwNDs8L3RleHQ+PC9nPjwhLS1saW5rIHVwZGF0ZSB0byBnZXQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0idXBkYXRlIiBkYXRhLWVudGl0eS0yPSJnZXQiIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJsbms3IiBpZD0ibGlua191cGRhdGVfZ2V0Ij48cGF0aCBkPSJNOTksMTY5LjAzIEM5OSwxODkuNCA5OSwyMjcuODYgOTksMjQ4LjIiIGZpbGw9Im5vbmUiIGlkPSJ1cGRhdGUtdG8tZ2V0IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSI5OSwyNTQuMiwxMDMsMjQ1LjIsOTksMjQ5LjIsOTUsMjQ1LjIsOTksMjU0LjIiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNiIgeD0iMTAwIiB5PSIyMTEuNjY2OSI+JiMyNjM1NjsmIzI2MDMyOzwvdGV4dD48L2c+PCEtLVNSQz1bS29wOUlDckRMSVo4SVNwQ3UtOGdJYXFrSVNuQnBxYkxLMGZBSkxEdXRCWmtzVUpVOXRsZEEyYktTb0tkNWdNMFhWTnlxcEdDRDlLSzRlaUxhZWpJNHFqSWVMOTVHQWRHV1hJV1c4UTZqZ1EyQ0tIOUFMVzRJT2J4UWVhNkgyZXpqT0lCMnNBNFdnd2s3TElmV2ZLMnFDUGQ3SEV1ZTdvRzU1MGZLRnBQeDJ0RmZjdFdna05Zb2lpN0lZSmJidkphdm9oYWZ5NGlXVFdFVEZSd25xc0I3WlR0RjZ3VV94WXYtTjdKVWd1ZGt3UzFGVkVxVlRkcDJNc0Y2clN5Tnh0andPSUVudXRKN3BVa1VqcE9tZk1RYnc4MENYODBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h4 id="ref">Ref の主要メソッド<a class="headerlink" href="#ref" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>メソッド</th>
<th>説明</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ref.Of(initial)</code></td>
<td>初期値で Ref を作成</td>
<td><code>Ref.Of(0)</code></td>
</tr>
<tr>
<td><code>ref.Get()</code></td>
<td>現在の値を取得</td>
<td><code>counter.Get()</code></td>
</tr>
<tr>
<td><code>ref.Set(value)</code></td>
<td>値を設定</td>
<td><code>counter.Set(10)</code></td>
</tr>
<tr>
<td><code>ref.Update(f)</code></td>
<td>アトミックに更新</td>
<td><code>counter.Update((+) 1)</code></td>
</tr>
<tr>
<td><code>ref.GetAndUpdate(f)</code></td>
<td>更新して古い値を返す</td>
<td><code>counter.GetAndUpdate((+) 1)</code></td>
</tr>
<tr>
<td><code>ref.UpdateAndGet(f)</code></td>
<td>更新して新しい値を返す</td>
<td><code>counter.UpdateAndGet((+) 1)</code></td>
</tr>
<tr>
<td><code>ref.Modify(f)</code></td>
<td>更新して結果を返す</td>
<td><code>counter.Modify(fun n -&gt; (n + 1, n * 2))</code></td>
</tr>
</tbody>
</table>
<h4 id="_1">使用例<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">example</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Ref</span><span class="p">.</span><span class="n">Of</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
<span class="w">    </span><span class="n">counter</span><span class="o">.</span><span class="n">Update</span><span class="o">((+)</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w">  </span><span class="c1">// アトミックに更新</span>
<span class="w">    </span><span class="n">counter</span><span class="o">.</span><span class="n">Get</span><span class="bp">()</span><span class="w">           </span><span class="c1">// 3</span>
</code></pre></div>
<h3 id="104-parsequence-">10.4 parSequence - 並列実行<a class="headerlink" href="#104-parsequence-" title="Permanent link">&para;</a></h3>
<p>F# では <code>Async.Parallel</code> を使って複数の Async を並列実行できます。</p>
<div class="highlight"><pre><span></span><code><span class="sd">/// Async のリストを並列実行</span>
<span class="k">let</span><span class="w"> </span><span class="nv">parSequence</span><span class="w"> </span><span class="o">(</span><span class="n">asyncList</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="kt">list</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="k">let!</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">Parallel</span><span class="w"> </span><span class="n">asyncList</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Array</span><span class="p">.</span><span class="n">toList</span>
<span class="w">    </span><span class="o">}</span>

<span class="c1">// 使用例</span>
<span class="k">let</span><span class="w"> </span><span class="nv">parallel</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">}</span>
<span class="w">      </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">}</span>
<span class="w">      </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">]</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">parSequence</span>

<span class="k">parallel</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">RunSynchronously</span><span class="w">  </span><span class="c1">// [1; 2; 3]</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjM1N3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTEyNXB4O2hlaWdodDozNTdweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMTI1IDM1NyIgd2lkdGg9IjExMjVweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIHNlcXVlbmNlIHZzIHBhclNlcXVlbmNlLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJzZXF1ZW5jZSB2cyBwYXJTZXF1ZW5jZSIgZGF0YS1zb3VyY2UtbGluZT0iMyIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJjbHVzdGVyX3NlcXVlbmNlIHZzIHBhclNlcXVlbmNlIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjMzOS43MyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjQ5NSIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIwNS40NzQ2IiB4PSIxNTYuNzYyNyIgeT0iMjYuOTk1MSI+c2VxdWVuY2UgdnMgcGFyU2VxdWVuY2U8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHNlcS0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0ic2VxIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImNsdXN0ZXJfc2VxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI1Ni43MyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE0NyIgeD0iNDQiIHk9IjYzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzMS4wNzIiIHg9IjUxLjk2NCIgeT0iNzcuOTk1MSI+c2VxdWVuY2UmIzY1Mjg4OyYjMzg5MTg7JiMyNzQyNTsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgcGFyLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwYXIiIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImNsdXN0ZXJfcGFyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE3My4wMiIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjI0NCIgeD0iMjMxIiB5PSI2MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTkuMTk1MSIgeD0iMjczLjQwMjUiIHk9Ijc3Ljk5NTEiPnBhclNlcXVlbmNlJiM2NTI4ODsmIzIwMDA2OyYjMjEwMTU7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgczEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iczEiIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X3MxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI3MC42MzM4IiB4PSI3Mi42OCIgeT0iMTA2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTAuNjMzOCIgeD0iODIuNjgiIHk9IjEyMS45OTUxIj5Bc3luYzE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgczItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iczIiIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5X3MyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI3MC42MzM4IiB4PSI3Mi42OCIgeT0iMTg5LjcyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTAuNjMzOCIgeD0iODIuNjgiIHk9IjIwNS43MTUxIj5Bc3luYzI8L3RleHQ+PC9nPjwhLS1lbnRpdHkgczMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iczMiIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5X3MzIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI3MC42MzM4IiB4PSI3Mi42OCIgeT0iMjczLjQzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTAuNjMzOCIgeD0iODIuNjgiIHk9IjI4OS40MjUxIj5Bc3luYzM8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcDEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icDEiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV9wMSI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNzAuNjMzOCIgeD0iMjU0LjY4IiB5PSIxMDYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1MC42MzM4IiB4PSIyNjQuNjgiIHk9IjEyMS45OTUxIj5Bc3luYzE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcDItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icDIiIGRhdGEtc291cmNlLWxpbmU9IjE0IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9wMiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNzAuNjMzOCIgeD0iMzYwLjY4IiB5PSIxMDYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1MC42MzM4IiB4PSIzNzAuNjgiIHk9IjEyMS45OTUxIj5Bc3luYzI8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcDMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icDMiIGRhdGEtc291cmNlLWxpbmU9IjE1IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9wMyI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNzAuNjMzOCIgeD0iMjU0LjY4IiB5PSIxODkuNzIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1MC42MzM4IiB4PSIyNjQuNjgiIHk9IjIwNS43MTUxIj5Bc3luYzM8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHTU4xMyIgZGF0YS1zb3VyY2UtbGluZT0iMjAiIGRhdGEtdWlkPSJlbnQwMDE0IiBpZD0iZW50aXR5X0dNTjEzIj48cGF0aCBkPSJNNTIzLjI0LDE4OC4zIEw1MjMuMjQsMjEzLjQzMjggTDc5NC43NjMsMjEzLjQzMjggTDc5NC43NjMsMTk4LjMgTDc4NC43NjMsMTg4LjMgTDUyMy4yNCwxODguMyIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik03ODQuNzYzLDE4OC4zIEw3ODQuNzYzLDE5OC4zIEw3OTQuNzYzLDE5OC4zIEw3ODQuNzYzLDE4OC4zIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjUwLjUyMyIgeD0iNTI5LjI0IiB5PSIyMDUuMzY2OSI+JiMyMTUxMjsmIzM1MzM2OyYjMjYxNzg7JiMzODI5MTsgPSBBc3luYzEgKyBBc3luYzIgKyBBc3luYzM8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHTU4xNiIgZGF0YS1zb3VyY2UtbGluZT0iMjQiIGRhdGEtdWlkPSJlbnQwMDE3IiBpZD0iZW50aXR5X0dNTjE2Ij48cGF0aCBkPSJNODI5LjksMTg4LjMgTDgyOS45LDIxMy40MzI4IEwxMTE4LjEwNDcsMjEzLjQzMjggTDExMTguMTA0NywxOTguMyBMMTEwOC4xMDQ3LDE4OC4zIEw4MjkuOSwxODguMyIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0xMTA4LjEwNDcsMTg4LjMgTDExMDguMTA0NywxOTguMyBMMTExOC4xMDQ3LDE5OC4zIEwxMTA4LjEwNDcsMTg4LjMiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNjcuMjA0NyIgeD0iODM1LjkiIHk9IjIwNS4zNjY5Ij4mIzIxNTEyOyYjMzUzMzY7JiMyNjE3ODsmIzM4MjkxOyAmIzg3NzY7IG1heChBc3luYzEsIEFzeW5jMiwgQXN5bmMzKTwvdGV4dD48L2c+PCEtLWxpbmsgczEgdG8gczItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iczEiIGRhdGEtZW50aXR5LTI9InMyIiBkYXRhLXNvdXJjZS1saW5lPSI4IiBkYXRhLXVpZD0ibG5rNyIgaWQ9ImxpbmtfczFfczIiPjxwYXRoIGQ9Ik0xMDgsMTI4LjUgQzEwOCwxNDQuMTMgMTA4LDE2Ny42MSAxMDgsMTgzLjM0IiBmaWxsPSJub25lIiBpZD0iczEtdG8tczIiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjEwOCwxODkuMzQsMTEyLDE4MC4zNCwxMDgsMTg0LjM0LDEwNCwxODAuMzQsMTA4LDE4OS4zNCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBzMiB0byBzMy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJzMiIgZGF0YS1lbnRpdHktMj0iczMiIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJsbms4IiBpZD0ibGlua19zMl9zMyI+PHBhdGggZD0iTTEwOCwyMTIuMjIgQzEwOCwyMjcuODUgMTA4LDI1MS4zMiAxMDgsMjY3LjA2IiBmaWxsPSJub25lIiBpZD0iczItdG8tczMiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjEwOCwyNzMuMDYsMTEyLDI2NC4wNiwxMDgsMjY4LjA2LDEwNCwyNjQuMDYsMTA4LDI3My4wNiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBzZXEgdG8gR01OMTMtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0ic2VxIiBkYXRhLWVudGl0eS0yPSJHTU4xMyIgZGF0YS1zb3VyY2UtbGluZT0iMjAiIGRhdGEtdWlkPSJsbmsxNSIgaWQ9Imxpbmtfc2VxX0dNTjEzIj48cGF0aCBkPSJNMTkxLjA5NDQsMTE5LjY0NjQgQzE5MS4xNTQ2LDExOS42NTc1IDE5MS4yMTUsMTE5LjY2ODYgMTkxLjI3NTcsMTE5LjY3OTggQzE5MS41MTg0LDExOS43MjQ0IDE5MS43NjU2LDExOS43Njk5IDE5Mi4wMTcsMTE5LjgxNjEgQzE5My4wMjI3LDEyMC4wMDExIDE5NC4wOTY4LDEyMC4xOTg1IDE5NS4yMzA5LDEyMC40MDY2IEMxOTcuNDk5MSwxMjAuODIzIDIwMC4wMDc1LDEyMS4yODI1IDIwMi42OSwxMjEuNzcyNSBDMjEzLjQyLDEyMy43MzI1IDIyNi45MzUsMTI2LjE4IDIzOSwxMjguMyBDMzYxLjAyLDE0OS43NSA1MDMuMTcsMTczLjc3IDU4Ni44NywxODcuODEiIGZpbGw9Im5vbmUiIGlkPSJzZXEtR01OMTMiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48L2c+PCEtLWxpbmsgcGFyIHRvIEdNTjE2LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InBhciIgZGF0YS1lbnRpdHktMj0iR01OMTYiIGRhdGEtc291cmNlLWxpbmU9IjI0IiBkYXRhLXVpZD0ibG5rMTgiIGlkPSJsaW5rX3Bhcl9HTU4xNiI+PHBhdGggZD0iTTQ3NS4xNjcyLDExOS40NzE2IEM0NzUuMzczNywxMTkuNTA0OSA0NzUuNTg0LDExOS41Mzg4IDQ3NS43OTgsMTE5LjU3MzIgQzQ3Ny41MDk1LDExOS44NDkxIDQ3OS40NTYxLDEyMC4xNjI4IDQ4MS42MjQ1LDEyMC41MTIyIEM0OTAuMjk4MiwxMjEuOTEwMSA1MDIuNTIyMywxMjMuODgwMiA1MTcuNDYxNiwxMjYuMjg4IEM1NDcuMzQsMTMxLjEwMzQgNTg4LjA3ODgsMTM3LjY2OTQgNjMyLjk5NSwxNDQuOTA4OCBDNzIyLjgyNzUsMTU5LjM4NzUgODI5LjM3LDE3Ni41NiA4OTkuMTYsMTg3LjgxIiBmaWxsPSJub25lIiBpZD0icGFyLUdNTjE2IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PC9nPjwhLS1TUkM9W0tvcDlJQ3JETElaOElTcEN1LThnSWFxa0lTbkJwcWJMSzJmRUJJbkRwS2pFTElXaExZWDhCMGc2U2ZLS2doNmZVaC1kdS1NMmpjVGg1aHhWcXdjYWE1WWkwOUcwZ2FuRUI0ZkhLNzhpaGluQkRlRzg2b0FCNks3NFo5MzVaMjVZbmJwNVhXZ3drZE9Xc004WjJDa09nblI1WUtaRTBqaF9QQ1VvZm50Sk9WTzN2UjNQTnUzNV9XOGl6WFUweDBCUWJmVFZhZ2dHYjV6SWFmLWhhOXk2eVhOTnFtYVRCclBxRjlsUHo3QlFQMExSMU9aWDJqZUdYWDZDT1NvTGNmVVkwREFFT0daR1FRWTZGRWhpS0NYRGhEMjA2QUszREdiQTZzbDJKRzgwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h4 id="async">複数の Async を並列実行<a class="headerlink" href="#async" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="sd">/// 2つの Async を並列実行</span>
<span class="k">let</span><span class="w"> </span><span class="nv">parTuple2</span><span class="w"> </span><span class="o">(</span><span class="n">async1</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">(</span><span class="n">async2</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="k">let!</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">Parallel</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">let!</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async1</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">let!</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async2</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">(</span><span class="n">unbox</span><span class="w"> </span><span class="n">results</span><span class="o">.[</span><span class="mi">0</span><span class="o">],</span><span class="w"> </span><span class="n">unbox</span><span class="w"> </span><span class="n">results</span><span class="o">.[</span><span class="mi">1</span><span class="o">])</span>
<span class="w">    </span><span class="o">}</span>

<span class="sd">/// 3つの Async を並列実行</span>
<span class="k">let</span><span class="w"> </span><span class="nv">parTuple3</span><span class="w"> </span><span class="o">(</span><span class="n">async1</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">(</span><span class="n">async2</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">(</span><span class="n">async3</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">c</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">&#39;</span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">&#39;</span><span class="n">c</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="k">let!</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">Parallel</span><span class="w"> </span><span class="o">[</span>
<span class="w">            </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">let!</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async1</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">let!</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async2</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">}</span>
<span class="w">            </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">let!</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async3</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">(</span><span class="n">unbox</span><span class="w"> </span><span class="n">results</span><span class="o">.[</span><span class="mi">0</span><span class="o">],</span><span class="w"> </span><span class="n">unbox</span><span class="w"> </span><span class="n">results</span><span class="o">.[</span><span class="mi">1</span><span class="o">],</span><span class="w"> </span><span class="n">unbox</span><span class="w"> </span><span class="n">results</span><span class="o">.[</span><span class="mi">2</span><span class="o">])</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<h3 id="105">10.5 サイコロを並行して振る<a class="headerlink" href="#105" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">private</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Random</span><span class="bp">()</span>

<span class="k">let</span><span class="w"> </span><span class="nv">castTheDie</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">random</span><span class="o">.</span><span class="n">Next</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">7</span><span class="o">)</span><span class="w"> </span><span class="o">}</span>

<span class="sd">/// N 個のサイコロを並行して振る</span>
<span class="k">let</span><span class="w"> </span><span class="nv">castDiceConcurrently</span><span class="w"> </span><span class="o">(</span><span class="n">n</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="w"> </span><span class="kt">list</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">[</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="n">n</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">castTheDie</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">]</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">parSequence</span>

<span class="sd">/// N 個のサイコロを並行して振り、合計を返す</span>
<span class="k">let</span><span class="w"> </span><span class="nv">castDiceAndSum</span><span class="w"> </span><span class="o">(</span><span class="n">n</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="k">let!</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">castDiceConcurrently</span><span class="w"> </span><span class="n">n</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">sum</span><span class="w"> </span><span class="n">results</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<h3 id="106-fiber-">10.6 Fiber - キャンセル可能な非同期タスク<a class="headerlink" href="#106-fiber-" title="Permanent link">&para;</a></h3>
<p><strong>Fiber</strong> は、バックグラウンドで実行されるキャンセル可能な非同期タスクです。</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">Fiber</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="sd">/// タスクの結果を待機</span>
<span class="w">    </span><span class="n">Join</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span>
<span class="w">    </span><span class="sd">/// タスクをキャンセル</span>
<span class="w">    </span><span class="n">Cancel</span><span class="o">:</span><span class="w"> </span><span class="kt">unit</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">unit</span>
<span class="o">}</span>

<span class="sd">/// Async を Fiber として起動（バックグラウンドで実行）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">start</span><span class="w"> </span><span class="o">(</span><span class="n">computation</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Fiber</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">cts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CancellationTokenSource</span><span class="bp">()</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">tcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TaskCompletionSource</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="bp">()</span>

<span class="w">    </span><span class="nn">Async</span><span class="p">.</span><span class="n">Start</span><span class="o">(</span>
<span class="w">        </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="k">try</span>
<span class="w">                </span><span class="k">let!</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computation</span>
<span class="w">                </span><span class="n">tcs</span><span class="o">.</span><span class="n">SetResult</span><span class="o">(</span><span class="n">result</span><span class="o">)</span>
<span class="w">            </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="o">:?</span><span class="w"> </span><span class="n">OperationCanceledException</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">tcs</span><span class="o">.</span><span class="n">SetCanceled</span><span class="bp">()</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">tcs</span><span class="o">.</span><span class="n">SetException</span><span class="o">(</span><span class="n">ex</span><span class="o">)</span>
<span class="w">        </span><span class="o">},</span>
<span class="w">        </span><span class="n">cts</span><span class="o">.</span><span class="n">Token</span><span class="o">)</span>

<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="n">Join</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">AwaitTask</span><span class="w"> </span><span class="n">tcs</span><span class="o">.</span><span class="n">Task</span>
<span class="w">        </span><span class="n">Cancel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cts</span><span class="o">.</span><span class="n">Cancel</span><span class="bp">()</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjMxMnB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MzYxcHg7aGVpZ2h0OjMxMnB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDM2MSAzMTIiIHdpZHRoPSIzNjFweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIEZpYmVyID8/Py0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iRmliZXIgLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfRmliZXIgLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE3Mi41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM0MyIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijg3LjY1NyIgeD0iMTM5LjY3MTUiIHk9IjI2Ljk5NTEiPkZpYmVyICYjMTIzOTg7JiMyMTIwNTsmIzIwMzE2OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgb3BzLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJvcHMiIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0iZW50MDAwOCIgaWQ9ImNsdXN0ZXJfb3BzIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjczLjMiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyNjMiIHg9IjgwIiB5PSIyMzMuNTkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzMuNjU3MSIgeD0iMTc0LjY3MTQiIHk9IjI0OC41ODUxIj5GaWJlciAmIzI1ODA1OyYjMjAzMTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IHN0YXJ0LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9InN0YXJ0IiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImVudGl0eV9zdGFydCI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTQ1LjYwMzUiIHg9IjcwLjIiIHk9IjQ3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1LjYwMzUiIHg9IjgwLjIiIHk9IjYyLjk5NTEiPnN0YXJ0IGNvbXB1dGF0aW9uPC90ZXh0PjwvZz48IS0tZW50aXR5IHJldHVybi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJyZXR1cm4iIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X3JldHVybiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTAxLjY0ODMiIHg9IjI4LjE4IiB5PSIxNDYuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgxLjY0ODMiIHg9IjM4LjE4IiB5PSIxNjIuMjk1MSI+RmliZXIgJiMxMjQzNDsmIzM2ODIwOyYjMTIzNzc7PC90ZXh0PjwvZz48IS0tZW50aXR5IGJnLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImJnIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwNSIgaWQ9ImVudGl0eV9iZyI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTczLjk5OTMiIHg9IjE2NSIgeT0iMTQ2LjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iMTc1IiB5PSIxNjIuMjk1MSI+JiMxMjQ5NjsmIzEyNDgzOyYjMTI0NjM7JiMxMjQ2NDsmIzEyNTIxOyYjMTI0NTQ7JiMxMjUzMTsmIzEyNDg5OyYjMTIzOTE7JiMyMzQ1NTsmIzM0ODkyOzwvdGV4dD48L2c+PCEtLWVudGl0eSBqb2luLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImpvaW4iIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImVudGl0eV9qb2luIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI4MS45ODE0IiB4PSI5Ni4wMSIgeT0iMjY4LjU5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuOTgxNCIgeD0iMTA2LjAxIiB5PSIyODQuNTg1MSI+ZmliZXIuSm9pbjwvdGV4dD48L2c+PCEtLWVudGl0eSBjYW5jZWwtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iY2FuY2VsIiBkYXRhLXNvdXJjZS1saW5lPSIxNCIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJlbnRpdHlfY2FuY2VsIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMTQuODc2IiB4PSIyMTIuNTYiIHk9IjI2OC41OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk0Ljg3NiIgeD0iMjIyLjU2IiB5PSIyODQuNTg1MSI+ZmliZXIuQ2FuY2VsKCk8L3RleHQ+PC9nPjwhLS1saW5rIHN0YXJ0IHRvIHJldHVybi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJzdGFydCIgZGF0YS1lbnRpdHktMj0icmV0dXJuIiBkYXRhLXNvdXJjZS1saW5lPSI4IiBkYXRhLXVpZD0ibG5rNiIgaWQ9Imxpbmtfc3RhcnRfcmV0dXJuIj48cGF0aCBkPSJNMTM2LjE1LDY5LjU2IEMxMjMuOSw4OC4xOSAxMDEuNjQ4NiwxMjIuMDE4MSA4OS4yODg2LDE0MC43OTgxIiBmaWxsPSJub25lIiBpZD0ic3RhcnQtdG8tcmV0dXJuIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSI4NS45OSwxNDUuODEsOTQuMjc5MiwxNDAuNDkxMiw4OC43Mzg4LDE0MS42MzM0LDg3LjU5NjYsMTM2LjA5MzEsODUuOTksMTQ1LjgxIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjUuMDAwMSIgeD0iMTE1LjgzIiB5PSIxMTIuMzY2OSI+JiMxMjM3NzsmIzEyMzY4OyYjMTIzOTU7JiMyNTE0NzsmIzEyNDI3OzwvdGV4dD48L2c+PCEtLWxpbmsgc3RhcnQgdG8gYmctLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0ic3RhcnQiIGRhdGEtZW50aXR5LTI9ImJnIiBkYXRhLXNvdXJjZS1saW5lPSI5IiBkYXRhLXVpZD0ibG5rNyIgaWQ9Imxpbmtfc3RhcnRfYmciPjxwYXRoIGQ9Ik0xNTUuNDgsNjkuNTkgQzE2NS4wMiw3Ny42MiAxNzguNDQsODkuMDQgMTkwLDk5LjMgQzIwOC4xOCwxMTUuNDMgMjI0LjQ3NDIsMTMwLjU2NDggMjM2Ljc2NDIsMTQyLjA5NDgiIGZpbGw9Im5vbmUiIGlkPSJzdGFydC10by1iZyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMjQxLjE0LDE0Ni4yLDIzNy4zMTMxLDEzNy4xMjUsMjM3LjQ5MzUsMTQyLjc3OSwyMzEuODM5NSwxNDIuOTU5NCwyNDEuMTQsMTQ2LjIiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1Mi4wMDAxIiB4PSIyMDguMjEiIHk9IjExMi4zNjY5Ij4mIzIwMDA2OyYjMzQ4OTI7JiMyMzQ1NTsmIzM0ODkyOzwvdGV4dD48L2c+PCEtLWxpbmsgYmcgdG8gam9pbi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJiZyIgZGF0YS1lbnRpdHktMj0iam9pbiIgZGF0YS1zb3VyY2UtbGluZT0iMTciIGRhdGEtdWlkPSJsbmsxMSIgaWQ9ImxpbmtfYmdfam9pbiI+PHBhdGggZD0iTTIyOC41OSwxNjkuMDcgQzIxNC4yMSwxNzYuNDMgMTk2LjA5LDE4Ny4yOCAxODMsMjAwLjU5IEMxNjIuOCwyMjEuMTMgMTUwLjMxMTEsMjQ2LjcxNTYgMTQzLjUwMTEsMjYyLjc4NTYiIGZpbGw9Im5vbmUiIGlkPSJiZy10by1qb2luIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxNDEuMTYsMjY4LjMxLDE0OC4zNTQ2LDI2MS41ODQxLDE0My4xMTA5LDI2My43MDYzLDE0MC45ODg3LDI1OC40NjI2LDE0MS4xNiwyNjguMzEiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS4wMDAxIiB4PSIxODQiIHk9IjIxMy42NTY5Ij4mIzMyMDgwOyYjMjY1MjQ7JiMxMjQzNDsmIzI0NDUzOyYjMjcyMzE7PC90ZXh0PjwvZz48IS0tbGluayBiZyB0byBjYW5jZWwtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iYmciIGRhdGEtZW50aXR5LTI9ImNhbmNlbCIgZGF0YS1zb3VyY2UtbGluZT0iMTgiIGRhdGEtdWlkPSJsbmsxMiIgaWQ9ImxpbmtfYmdfY2FuY2VsIj48cGF0aCBkPSJNMjUzLjUzLDE2OC43IEMyNTYuOTIsMTkxLjMxIDI2NC4xMDE2LDIzOS4zMjYxIDI2Ny41MzE2LDI2Mi4yMzYxIiBmaWxsPSJub25lIiBpZD0iYmctdG8tY2FuY2VsIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIyNjguNDIsMjY4LjE3LDI3MS4wNDMzLDI1OC42NzY5LDI2Ny42Nzk3LDI2My4yMjUxLDI2My4xMzE1LDI1OS44NjE1LDI2OC40MiwyNjguMTciIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5MS4wMDAxIiB4PSIyNjEuNDYiIHk9IjIxMy42NTY5Ij4mIzEyNDYxOyYjMTI1MTU7JiMxMjUzMTsmIzEyNDc1OyYjMTI1MjM7JiMyMTQ4NzsmIzMzMDIxOzwvdGV4dD48L2c+PCEtLVNSQz1bUk9fRElXQ241OE50VU9ldUFyc3EzLTMyWlUzMmp5WWFTSG9QcFdvUFQyS2thWTBlTEhweU1ISUFIT0hBQVJQMjRPSElWUFpSNlVTbkozQVpBQlpCcEpkdGRGampZNEZNUEpZREkxV1puMWFMOTB1WVhoc3pxNlNTV3ZtTF9SbHJRa1pYT3FHOXhzMGw0dUdCSjlEa3NYRDRYNGRpT1A5WHp6aXVjYkxyTk50U1dYbXVkSkZIdXQ1WjA5czNyZzNjZTV2MEpxMkRHSXowZHVEeUFjUVp3azcyaFZXMUdkTFBneE5KMUUxalN6ODBQMHZvTWZ1akdWTF9NVnAwb0VrdGlHY2VPejM5RnFaYnBRTlpDR3I5Y2xyVzdMWW5sUC00RFMtSFVWbkhUYWJDTVJJdnZMSmcxWGpsRWNzcmpQbG9welV5bDF5UXlrQnpqOW9DbGpOUVJjek5wdzBWQlFuUVdmdU1MX0RBaHh1MF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h4 id="foreverm-">foreverM - 永遠に繰り返す<a class="headerlink" href="#foreverm-" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="sd">/// 永遠に繰り返す</span>
<span class="k">let</span><span class="w"> </span><span class="nv">foreverM</span><span class="w"> </span><span class="o">(</span><span class="n">action</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="kt">unit</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="kt">unit</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="k">do</span><span class="o">!</span><span class="w"> </span><span class="n">action</span>
<span class="w">            </span><span class="k">return</span><span class="o">!</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="bp">()</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">    </span><span class="n">loop</span><span class="w"> </span><span class="bp">()</span>
</code></pre></div>
<h3 id="107">10.7 チェックイン処理の並行版<a class="headerlink" href="#107" title="Permanent link">&para;</a></h3>
<p>チェックインの保存とランキングの更新を並行して実行します。</p>
<h4 id="_2">チェックインの保存<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">storeCheckIn</span><span class="w"> </span><span class="o">(</span><span class="n">storedCheckIns</span><span class="o">:</span><span class="w"> </span><span class="n">Ref</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="o">,</span><span class="w"> </span><span class="n">int</span><span class="o">&gt;&gt;)</span><span class="w"> </span><span class="o">(</span><span class="n">city</span><span class="o">:</span><span class="w"> </span><span class="n">City</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">unit</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">storedCheckIns</span><span class="o">.</span><span class="n">Update</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="nn">Map</span><span class="p">.</span><span class="n">tryFind</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="k">with</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Map</span><span class="p">.</span><span class="n">add</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="o">(</span><span class="n">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="n">map</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Map</span><span class="p">.</span><span class="n">add</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">map</span><span class="o">)</span>
</code></pre></div>
<h4 id="_3">ランキングの継続的な更新<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">updateRanking</span>
<span class="w">    </span><span class="o">(</span><span class="n">storedCheckIns</span><span class="o">:</span><span class="w"> </span><span class="n">Ref</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="o">,</span><span class="w"> </span><span class="n">int</span><span class="o">&gt;&gt;)</span>
<span class="w">    </span><span class="o">(</span><span class="n">storedRanking</span><span class="o">:</span><span class="w"> </span><span class="n">Ref</span><span class="o">&lt;</span><span class="n">CityStats</span><span class="w"> </span><span class="kt">list</span><span class="o">&gt;)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="kt">unit</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">checkIns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storedCheckIns</span><span class="o">.</span><span class="n">Get</span><span class="bp">()</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">ranking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">topCities</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">checkIns</span>
<span class="w">        </span><span class="n">storedRanking</span><span class="o">.</span><span class="n">Set</span><span class="o">(</span><span class="n">ranking</span><span class="o">)</span>
<span class="w">    </span><span class="o">}</span>

<span class="sd">/// ランキングを継続的に更新</span>
<span class="k">let</span><span class="w"> </span><span class="nv">updateRankingForever</span>
<span class="w">    </span><span class="o">(</span><span class="n">storedCheckIns</span><span class="o">:</span><span class="w"> </span><span class="n">Ref</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="o">,</span><span class="w"> </span><span class="n">int</span><span class="o">&gt;&gt;)</span>
<span class="w">    </span><span class="o">(</span><span class="n">storedRanking</span><span class="o">:</span><span class="w"> </span><span class="n">Ref</span><span class="o">&lt;</span><span class="n">CityStats</span><span class="w"> </span><span class="kt">list</span><span class="o">&gt;)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="kt">unit</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">foreverM</span><span class="w"> </span><span class="o">(</span><span class="n">updateRanking</span><span class="w"> </span><span class="n">storedCheckIns</span><span class="w"> </span><span class="n">storedRanking</span><span class="o">)</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjIwNHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTA0OXB4O2hlaWdodDoyMDRweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMDQ5IDIwNCIgd2lkdGg9IjEwNDlweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl8uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE0MC4zIiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTAzMSIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjQ3OC41MDAyIiB5PSIyNi45OTUxIj4mIzIwMDA2OyYjMzQ4OTI7JiMyMDk2NjsmIzI5NzAyOyYjMTIzOTg7JiMyNzA4MzsmIzM2ODk2OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgY2hlY2tpbi0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iY2hlY2tpbiIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX2NoZWNraW4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iNzMuMyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjQwMSIgeD0iMzYiIHk9IjU1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIxODAuNTAwMiIgeT0iNjkuOTk1MSI+JiMxMjQ4MTsmIzEyNDU1OyYjMTI0ODM7JiMxMjQ2MzsmIzEyNDUyOyYjMTI1MzE7JiMyMDk2NjsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgcmFua2luZy0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0icmFua2luZyIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJjbHVzdGVyX3JhbmtpbmciPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iNzMuMyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjU1OCIgeD0iNDYxIiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSI2OTEuMDAwMiIgeT0iNjkuOTk1MSI+JiMxMjUyMTsmIzEyNTMxOyYjMTI0NjE7JiMxMjUzMTsmIzEyNDY0OyYjMjYzNTY7JiMyNjAzMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/Pz8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0iZW50MDAwNCIgaWQ9ImVudGl0eV8uLi4uLi4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyNDMuOTk5IiB4PSI1MiIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjMuOTk5IiB4PSI2MiIgeT0iMTA1Ljk5NTEiPiYjMTI0NzE7JiMxMjU0MDsmIzEyNDY1OyYjMTI1MzE7JiMxMjQ3MzsmIzEyMzYzOyYjMTI0MjU7JiMxMjQ4MTsmIzEyNDU1OyYjMTI0ODM7JiMxMjQ2MzsmIzEyNDUyOyYjMTI1MzE7JiMxMjQzNDsmIzIxNDYzOyYjMjA0NDk7PC90ZXh0PjwvZz48IS0tZW50aXR5IFJlZiA/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUmVmIC4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfUmVmIC4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iODkuNzE5NSIgeD0iMzMxLjE0IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5LjcxOTUiIHg9IjM0MS4xNCIgeT0iMTA1Ljk5NTEiPlJlZiAmIzEyMzk1OyYjMjA0NDU7JiMyMzM4NDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVmID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUmVmIC4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEwIiBkYXRhLXVpZD0iZW50MDAwNyIgaWQ9ImVudGl0eV9SZWYgLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTg3LjcxOTEiIHg9IjQ3Ny4xNCIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNjcuNzE5MSIgeD0iNDg3LjE0IiB5PSIxMDUuOTk1MSI+UmVmICYjMTIzNjM7JiMxMjQyNTsmIzEyNDg3OyYjMTI1NDA7JiMxMjQ3OTsmIzEyNDM0OyYjMzU1MDE7JiMxMjQxNTsmIzIxNDYyOyYjMTI0MjY7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfLi4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEzMS45OTk1IiB4PSI3MDAiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjcxMCIgeT0iMTA1Ljk5NTEiPiYjMTI1MjE7JiMxMjUzMTsmIzEyNDYxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyNDM0OyYjMzUzMzY7JiMzMTYzOTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/IFJlZiA/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uIFJlZiAuLi4iIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImVudGl0eV8uLi4gUmVmIC4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTM2LjE2OTYiIHg9Ijg2Ni45MiIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTYuMTY5NiIgeD0iODc2LjkyIiB5PSIxMDUuOTk1MSI+JiMzMjA4MDsmIzI2NTI0OyYjMTI0MzQ7IFJlZiAmIzEyMzk1OyYjMjA0NDU7JiMyMzM4NDs8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHTU4xMCIgZGF0YS1zb3VyY2UtbGluZT0iMTciIGRhdGEtdWlkPSJlbnQwMDExIiBpZD0iZW50aXR5X0dNTjEwIj48cGF0aCBkPSJNODI5LjM2LDE3Mi4zIEw4MjkuMzYsMTk3LjQzMjggQTAsMCAwIDAgMCA4MjkuMzYsMTk3LjQzMjggTDEwNDAuNjMxMiwxOTcuNDMyOCBBMCwwIDAgMCAwIDEwNDAuNjMxMiwxOTcuNDMyOCBMMTA0MC42MzEyLDE4Mi4zIEwxMDMwLjYzMTIsMTcyLjMgTDkzOSwxNzIuMyBMOTM1LDExMi41IEw5MzEsMTcyLjMgTDgyOS4zNiwxNzIuMyBBMCwwIDAgMCAwIDgyOS4zNiwxNzIuMyIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0xMDMwLjYzMTIsMTcyLjMgTDEwMzAuNjMxMiwxODIuMyBMMTA0MC42MzEyLDE4Mi4zIEwxMDMwLjYzMTIsMTcyLjMiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOTAuMjcxMiIgeD0iODM1LjM2IiB5PSIxODkuMzY2OSI+MiYjMTIzODg7JiMxMjM5ODsmIzIwOTY2OyYjMjk3MDI7JiMxMjM2NDsmIzIwMDA2OyYjMzQ4OTI7JiMxMjM3NTsmIzEyMzkwOyYjMjM0NTU7JiMzNDg5MjsmIzEyMzczOyYjMTI0Mjg7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1TUkM9W1BQMWhJaUQwN0NJX3hvZE03QzZaVThFT2hjc250S1pDRG43U1Z5MmcyUkc4amVCRkdhYnphNVhIS0s3OE9JUUZVV2t0WUg2ck52UGJUc1AtbXdvdUJUNExWQWpaallMWlpoMVNLcE94V1hsZk1wV1YxcmFsQjBSeEs3NC16Sl90aFdzLXlyaTNKdTZjeTNwRzBzVzJ4d2RJNnpwU3ZiUEJNOWpqZ0hzTXdKSXFjNXhYVk8wVWpHcHEza00zM2ZTSkdDVFBWdkdjTy1GUmpvT3NFREh6Y2JuYXFRZDFUamRWMWhVYjlvaEZNTnhzZDB6ZDlUdW5mUU90Vl8xTEpDTmliS0tJWlBoVkhMMTlyWC0yWmNoV2x5bzV3a1FXWTRWclZfNG9vMl9GekpEVmdnUkJJVGlMVkRyc05SbEJMZzRjVWhqd25BM1E1NmU0NU1SbkxOYV8wR0tXZG1kUHUwbGw1bTAwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="108">10.8 呼び出し元に制御を返す<a class="headerlink" href="#108" title="Permanent link">&para;</a></h3>
<p>バックグラウンドで処理を続けつつ、呼び出し元に制御を返す設計ができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">ProcessingCheckIns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="sd">/// 現在のランキングを取得</span>
<span class="w">    </span><span class="n">CurrentRanking</span><span class="o">:</span><span class="w"> </span><span class="kt">unit</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">CityStats</span><span class="w"> </span><span class="kt">list</span>
<span class="w">    </span><span class="sd">/// 処理を停止</span>
<span class="w">    </span><span class="n">Stop</span><span class="o">:</span><span class="w"> </span><span class="kt">unit</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">unit</span>
<span class="o">}</span>

<span class="k">let</span><span class="w"> </span><span class="nv">startCheckInProcessing</span><span class="w"> </span><span class="o">(</span><span class="n">checkIns</span><span class="o">:</span><span class="w"> </span><span class="n">City</span><span class="w"> </span><span class="n">seq</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ProcessingCheckIns</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">storedCheckIns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Ref</span><span class="p">.</span><span class="n">Of</span><span class="o">(</span><span class="nn">Map</span><span class="p">.</span><span class="n">empty</span><span class="o">&lt;</span><span class="n">City</span><span class="o">,</span><span class="w"> </span><span class="n">int</span><span class="o">&gt;)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">storedRanking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Ref</span><span class="p">.</span><span class="n">Of</span><span class="o">(</span><span class="bp">[]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">CityStats</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">cts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CancellationTokenSource</span><span class="bp">()</span>

<span class="w">    </span><span class="c1">// チェックイン処理を開始</span>
<span class="w">    </span><span class="nn">Async</span><span class="p">.</span><span class="n">Start</span><span class="o">(</span>
<span class="w">        </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">checkIns</span><span class="w"> </span><span class="k">do</span>
<span class="w">                </span><span class="n">storeCheckIn</span><span class="w"> </span><span class="n">storedCheckIns</span><span class="w"> </span><span class="n">city</span>
<span class="w">        </span><span class="o">},</span>
<span class="w">        </span><span class="n">cts</span><span class="o">.</span><span class="n">Token</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// ランキング更新を開始</span>
<span class="w">    </span><span class="nn">Async</span><span class="p">.</span><span class="n">Start</span><span class="o">(</span>
<span class="w">        </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">cts</span><span class="o">.</span><span class="n">Token</span><span class="o">.</span><span class="n">IsCancellationRequested</span><span class="w"> </span><span class="k">do</span>
<span class="w">                </span><span class="k">do</span><span class="o">!</span><span class="w"> </span><span class="n">updateRanking</span><span class="w"> </span><span class="n">storedCheckIns</span><span class="w"> </span><span class="n">storedRanking</span>
<span class="w">                </span><span class="k">do</span><span class="o">!</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">Sleep</span><span class="w"> </span><span class="mi">10</span>
<span class="w">        </span><span class="o">},</span>
<span class="w">        </span><span class="n">cts</span><span class="o">.</span><span class="n">Token</span><span class="o">)</span>

<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="n">CurrentRanking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">storedRanking</span><span class="o">.</span><span class="n">Get</span><span class="bp">()</span>
<span class="w">        </span><span class="n">Stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cts</span><span class="o">.</span><span class="n">Cancel</span><span class="bp">()</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<h4 id="_4">使用例<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">example</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">cities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Tokyo&quot;</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Sydney&quot;</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Tokyo&quot;</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;London&quot;</span><span class="w"> </span><span class="o">}</span>
<span class="w">        </span><span class="o">{</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Tokyo&quot;</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">]</span>

<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">processing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startCheckInProcessing</span><span class="w"> </span><span class="n">cities</span>

<span class="w">    </span><span class="c1">// 少し待ってからランキングを取得</span>
<span class="w">    </span><span class="nn">System</span><span class="p">.</span><span class="nn">Threading</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">ranking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processing</span><span class="o">.</span><span class="n">CurrentRanking</span><span class="bp">()</span>
<span class="w">    </span><span class="n">printfn</span><span class="w"> </span><span class="s">&quot;%A&quot;</span><span class="w"> </span><span class="n">ranking</span>

<span class="w">    </span><span class="c1">// 処理を停止</span>
<span class="w">    </span><span class="n">processing</span><span class="o">.</span><span class="n">Stop</span><span class="bp">()</span>
</code></pre></div>
<h3 id="109-mailboxprocessoragent">10.9 MailboxProcessor（Agent）による並行処理<a class="headerlink" href="#109-mailboxprocessoragent" title="Permanent link">&para;</a></h3>
<p>F# では、<strong>MailboxProcessor</strong>（別名 Agent）を使ったメッセージパッシング方式の並行処理が一般的です。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI5OHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NTc3cHg7aGVpZ2h0OjI5OHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDU3NyAyOTgiIHdpZHRoPSI1NzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIE1haWxib3hQcm9jZXNzb3IgKEFnZW50KS0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iTWFpbGJveFByb2Nlc3NvciAuQWdlbnQuIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfTWFpbGJveFByb2Nlc3NvciAuQWdlbnQuIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI4MC44OCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM1MiIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIwNC4wOTM4IiB4PSI4NS45NTMxIiB5PSIyNi45OTUxIj5NYWlsYm94UHJvY2Vzc29yIChBZ2VudCk8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcXVldWUtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icXVldWUiIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X3F1ZXVlIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzEuOTk5NSIgeD0iNjgiIHk9IjQ3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9Ijc4IiB5PSI2Mi45OTUxIj4mIzEyNTEzOyYjMTI0ODM7JiMxMjQ3NTsmIzEyNTQwOyYjMTI0NzI7JiMxMjQ2MTsmIzEyNTE3OyYjMTI1NDA7PC90ZXh0PjwvZz48IS0tZW50aXR5IGxvb3AtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0ibG9vcCIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJlbnRpdHlfbG9vcCI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTMxLjk5OTUiIHg9IjEyNSIgeT0iMjU0LjU4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjEzNSIgeT0iMjcwLjU3NTEiPiYjMjkzNjY7JiMyNDkwNzsmIzEyNDM0OyYjMjUzNDU7JiMxMjM4ODsmIzEyNTIzOyYjMTI1NDA7JiMxMjUwMzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcHJvY2Vzcy0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJwcm9jZXNzIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwNSIgaWQ9ImVudGl0eV9wcm9jZXNzIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMTcuOTk5NiIgeD0iMjMwIiB5PSIxNDYuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjI0MCIgeT0iMTYyLjI5NTEiPiYjMTI1MTM7JiMxMjQ4MzsmIzEyNDc1OyYjMTI1NDA7JiMxMjQ3MjsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR01OOSIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGRhdGEtdWlkPSJlbnQwMDEwIiBpZD0iZW50aXR5X0dNTjkiPjxwYXRoIGQ9Ik0zODAsMjQ1LjYgTDM4MCwyODUuODY1NiBBMCwwIDAgMCAwIDM4MCwyODUuODY1NiBMNTcwLjAwMDIsMjg1Ljg2NTYgQTAsMCAwIDAgMCA1NzAuMDAwMiwyODUuODY1NiBMNTcwLjAwMDIsMjU1LjYgTDU2MC4wMDAyLDI0NS42IEw0NDQuODgsMjQ1LjYgTDMwNy41MSwxNjkuMDMgTDQzNi44OCwyNDUuNiBMMzgwLDI0NS42IEEwLDAgMCAwIDAgMzgwLDI0NS42IiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTU2MC4wMDAyLDI0NS42IEw1NjAuMDAwMiwyNTUuNiBMNTcwLjAwMDIsMjU1LjYgTDU2MC4wMDAyLDI0NS42IiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTUxLjI3MTIiIHg9IjM4NiIgeT0iMjYyLjY2NjkiPjEmIzEyMzg4OyYjMTIzOTg7JiMxMjQ3MzsmIzEyNTI0OyYjMTI0ODM7JiMxMjQ4OTsmIzEyMzkxOyYjMzg5MTg7JiMyNzQyNTsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2OS4wMDAyIiB4PSIzODYiIHk9IjI3Ny43OTk3Ij4mIzEyNDczOyYjMTI1MjQ7JiMxMjQ4MzsmIzEyNDg5OyYjMTI0NzU7JiMxMjU0MDsmIzEyNTAxOyYjMTIzNjQ7JiMyMDQ0NTsmIzM1Mzg4OyYjMTIzNzM7JiMxMjQyODsmIzEyNDI3OzwvdGV4dD48L2c+PCEtLWxpbmsgcXVldWUgdG8gcHJvY2Vzcy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJxdWV1ZSIgZGF0YS1lbnRpdHktMj0icHJvY2VzcyIgZGF0YS1zb3VyY2UtbGluZT0iOCIgZGF0YS11aWQ9ImxuazYiIGlkPSJsaW5rX3F1ZXVlX3Byb2Nlc3MiPjxwYXRoIGQ9Ik0xNTAuODgsNjkuNzUgQzE4MC43LDg4LjQ3IDIzNy4yNTg1LDEyMy45Njk2IDI2Ny4wNTg1LDE0Mi42Nzk2IiBmaWxsPSJub25lIiBpZD0icXVldWUtdG8tcHJvY2VzcyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMjcyLjE0LDE0NS44NywyNjYuNjQ0NywxMzcuNjk2NywyNjcuOTA1NCwxNDMuMjExMywyNjIuMzkwOSwxNDQuNDcyLDI3Mi4xNCwxNDUuODciIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjIxLjc4IiB5PSIxMTIuMzY2OSI+JiMxMjUxMzsmIzEyNDgzOyYjMTI0NzU7JiMxMjU0MDsmIzEyNDcyOyYjMTI0MzQ7JiMyMTQ2MzsmIzIwNDQ5OzwvdGV4dD48L2c+PCEtLWxpbmsgcHJvY2VzcyB0byBsb29wLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InByb2Nlc3MiIGRhdGEtZW50aXR5LTI9Imxvb3AiIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJsbms3IiBpZD0ibGlua19wcm9jZXNzX2xvb3AiPjxwYXRoIGQ9Ik0yNzkuMjUsMTY5LjAzIEMyNjAuNDYsMTg5LjQgMjIzLjUzNjcsMjI5LjQ0ODQgMjA0Ljc4NjcsMjQ5Ljc4ODQiIGZpbGw9Im5vbmUiIGlkPSJwcm9jZXNzLXRvLWxvb3AiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjIwMC43MiwyNTQuMiwyMDkuNzYxMSwyNTAuMjkzOCwyMDQuMTA4OSwyNTAuNTIzNywyMDMuODc5LDI0NC44NzE1LDIwMC43MiwyNTQuMiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY1LjAwMDEiIHg9IjI1Mi42NiIgeT0iMjExLjY2NjkiPiYjMjkzNjY7JiMyNDkwNzsmIzEyNDM0OyYjMjYzNTY7JiMyNjAzMjs8L3RleHQ+PC9nPjwhLS1saW5rIGxvb3AgdG8gcXVldWUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0ibG9vcCIgZGF0YS1lbnRpdHktMj0icXVldWUiIGRhdGEtc291cmNlLWxpbmU9IjEwIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfbG9vcF9xdWV1ZSI+PHBhdGggZD0iTTE3MC40NCwyNTQuMDkgQzE0NC4wMiwyMzkuMDkgOTkuMzUsMjA5LjAxIDgxLDE2OC42IEM2NC4zMywxMzEuODggOTcuNzA5NCw5My4xODI4IDExNy45Mjk0LDczLjc5MjgiIGZpbGw9Im5vbmUiIGlkPSJsb29wLXRvLXF1ZXVlIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMjIuMjYsNjkuNjQsMTEyLjk5NTYsNzIuOTgyMiwxMTguNjUxMiw3My4xMDA3LDExOC41MzI3LDc4Ljc1NjMsMTIyLjI2LDY5LjY0IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMwLjAwMDIiIHg9IjgyIiB5PSIxNjIuMDE2OSI+JiMyNzQyNTsmIzEyMzk4OyYjMTI1MTM7JiMxMjQ4MzsmIzEyNDc1OyYjMTI1NDA7JiMxMjQ3MjsmIzEyNDM0OyYjMjQ0NTM7JiMyNzIzMTs8L3RleHQ+PC9nPjwhLS1TUkM9W1JPX0ZJaUQwNDhWbHluSFpKZGhlbU1pRldXeVctMGZma2pIMmtYa0pCR1pZT05UZkhIakcyaEs3NEd0dTV3anVhNUFuczhVUERqTXRDOWpPSEVuamNGZGNjei1pbzF0TU8xWnVSZnEzWENvSkJnX3YzOXFqai12Tm5EdnNBM21NSElCNHJTcVF1dEJEbU50bXRCMkEzZmM0WjI3ekpjUENVYUp3WVNuRExabGVIaFpSUDR0czB5d0ZYc2NoR3hnUm5laEtEUGI3a3M3d0VVV0I0SW1OcFd2bHZ3Vmo3MGdBNTAydjVha2JaS0tCb19XbEh0VHNxZnpFNGJXVzVoVGRDbE90b2xiaFVsTzJVVGxFMnQ0UHFxNTJ3ZGM5eWdFTEZicDIwRzBOYWM1NUkyYVFpNnhWb04zekhjUFdEeW1IZ1JrbGd0UWNBVUIzZHJhWEQzckl5TkhveU5hXzlqS1o3UEZrMEVETGpFZmxdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h4 id="_5">カウンターエージェント<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">CounterMessage</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Increment</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Decrement</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GetValue</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">AsyncReplyChannel</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Reset</span>

<span class="k">let</span><span class="w"> </span><span class="nv">createCounter</span><span class="w"> </span><span class="o">(</span><span class="n">initialValue</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MailboxProcessor</span><span class="o">&lt;</span><span class="n">CounterMessage</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nn">MailboxProcessor</span><span class="p">.</span><span class="n">Start</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">inbox</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="k">let!</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inbox</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">Increment</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">return</span><span class="o">!</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="o">(</span><span class="n">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">Decrement</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">return</span><span class="o">!</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="o">(</span><span class="n">count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">GetValue</span><span class="w"> </span><span class="n">replyChannel</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">replyChannel</span><span class="o">.</span><span class="n">Reply</span><span class="o">(</span><span class="n">count</span><span class="o">)</span>
<span class="w">                    </span><span class="k">return</span><span class="o">!</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">count</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">Reset</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">return</span><span class="o">!</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">initialValue</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="n">loop</span><span class="w"> </span><span class="n">initialValue</span><span class="o">)</span>
</code></pre></div>
<h4 id="_6">カウンターの使用<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createCounter</span><span class="w"> </span><span class="mi">0</span>

<span class="c1">// インクリメント（Fire-and-forget）</span>
<span class="n">counter</span><span class="o">.</span><span class="n">Post</span><span class="o">(</span><span class="n">Increment</span><span class="o">)</span>
<span class="n">counter</span><span class="o">.</span><span class="n">Post</span><span class="o">(</span><span class="n">Increment</span><span class="o">)</span>

<span class="c1">// 値を取得（同期）</span>
<span class="k">let</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="o">.</span><span class="n">PostAndReply</span><span class="o">(</span><span class="n">GetValue</span><span class="o">)</span><span class="w">  </span><span class="c1">// 2</span>

<span class="c1">// デクリメント</span>
<span class="n">counter</span><span class="o">.</span><span class="n">Post</span><span class="o">(</span><span class="n">Decrement</span><span class="o">)</span>
<span class="k">let</span><span class="w"> </span><span class="nv">newValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="o">.</span><span class="n">PostAndReply</span><span class="o">(</span><span class="n">GetValue</span><span class="o">)</span><span class="w">  </span><span class="c1">// 1</span>
</code></pre></div>
<h4 id="_7">チェックインエージェント<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">CheckInMessage</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">AddCheckIn</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">City</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GetStats</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">AsyncReplyChannel</span><span class="o">&lt;</span><span class="n">CityStats</span><span class="w"> </span><span class="kt">list</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GetTotal</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">AsyncReplyChannel</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span>

<span class="k">let</span><span class="w"> </span><span class="nv">createCheckInAgent</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MailboxProcessor</span><span class="o">&lt;</span><span class="n">CheckInMessage</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nn">MailboxProcessor</span><span class="p">.</span><span class="n">Start</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">inbox</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="o">(</span><span class="n">checkIns</span><span class="o">:</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="o">,</span><span class="w"> </span><span class="n">int</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="k">let!</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inbox</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">AddCheckIn</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">newCheckIns</span><span class="w"> </span><span class="o">=</span>
<span class="w">                        </span><span class="k">match</span><span class="w"> </span><span class="nn">Map</span><span class="p">.</span><span class="n">tryFind</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="n">checkIns</span><span class="w"> </span><span class="k">with</span>
<span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Map</span><span class="p">.</span><span class="n">add</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="o">(</span><span class="n">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="n">checkIns</span>
<span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Map</span><span class="p">.</span><span class="n">add</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">checkIns</span>
<span class="w">                    </span><span class="k">return</span><span class="o">!</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">newCheckIns</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">GetStats</span><span class="w"> </span><span class="n">replyChannel</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">topCities</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">checkIns</span>
<span class="w">                    </span><span class="n">replyChannel</span><span class="o">.</span><span class="n">Reply</span><span class="o">(</span><span class="n">stats</span><span class="o">)</span>
<span class="w">                    </span><span class="k">return</span><span class="o">!</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">checkIns</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">GetTotal</span><span class="w"> </span><span class="n">replyChannel</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">let</span><span class="w"> </span><span class="nv">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkIns</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Map</span><span class="p">.</span><span class="n">toList</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">sumBy</span><span class="w"> </span><span class="n">snd</span>
<span class="w">                    </span><span class="n">replyChannel</span><span class="o">.</span><span class="n">Reply</span><span class="o">(</span><span class="n">total</span><span class="o">)</span>
<span class="w">                    </span><span class="k">return</span><span class="o">!</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">checkIns</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="n">loop</span><span class="w"> </span><span class="nn">Map</span><span class="p">.</span><span class="n">empty</span><span class="o">)</span>
</code></pre></div>
<h3 id="1010">10.10 並列処理ユーティリティ<a class="headerlink" href="#1010" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">/// リストの各要素に関数を並列適用</span>
<span class="k">let</span><span class="w"> </span><span class="nv">parMap</span><span class="w"> </span><span class="o">(</span><span class="n">f</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">&#39;</span><span class="n">b</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kt">list</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">b</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="kt">list</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">})</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">parSequence</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">RunSynchronously</span>

<span class="sd">/// 条件を満たす要素を並列でフィルタ</span>
<span class="k">let</span><span class="w"> </span><span class="nv">parFilter</span><span class="w"> </span><span class="o">(</span><span class="n">predicate</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kt">list</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="kt">list</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="w"> </span><span class="n">predicate</span><span class="w"> </span><span class="n">x</span><span class="o">)</span><span class="w"> </span><span class="o">})</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">parSequence</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">RunSynchronously</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="n">snd</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="n">fst</span>

<span class="sd">/// 並列で集約</span>
<span class="k">let</span><span class="w"> </span><span class="nv">parReduce</span><span class="w"> </span><span class="o">(</span><span class="n">combine</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kt">list</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="k">with</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">reduceLevel</span><span class="w"> </span><span class="o">(</span><span class="n">items</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">items</span><span class="w"> </span><span class="k">with</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="bp">[]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;Unexpected empty list&quot;</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="o">[</span><span class="n">x</span><span class="o">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span>
<span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">items</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">chunkBySize</span><span class="w"> </span><span class="mi">2</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">match</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="k">with</span>
<span class="w">                    </span><span class="o">|</span><span class="w"> </span><span class="o">[</span><span class="n">a</span><span class="o">;</span><span class="w"> </span><span class="n">b</span><span class="o">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">combine</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="o">|</span><span class="w"> </span><span class="o">[</span><span class="n">a</span><span class="o">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">}</span>
<span class="w">                    </span><span class="o">|</span><span class="w"> </span><span class="o">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">failwith</span><span class="w"> </span><span class="s">&quot;Unexpected chunk size&quot;</span><span class="o">)</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">parSequence</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">RunSynchronously</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">reduceLevel</span>
<span class="w">        </span><span class="n">Some</span><span class="w"> </span><span class="o">(</span><span class="n">reduceLevel</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span>
</code></pre></div>
<h3 id="1011">10.11 タイムアウト付き実行<a class="headerlink" href="#1011" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">/// タイムアウト付きで Async を実行</span>
<span class="k">let</span><span class="w"> </span><span class="nv">withTimeout</span><span class="w"> </span><span class="o">(</span><span class="n">timeoutMs</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">computation</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="n">option</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="k">let!</span><span class="w"> </span><span class="nv">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">StartChild</span><span class="o">(</span><span class="n">computation</span><span class="o">,</span><span class="w"> </span><span class="n">timeoutMs</span><span class="o">)</span>
<span class="w">        </span><span class="k">try</span>
<span class="w">            </span><span class="k">let!</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">child</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">result</span>
<span class="w">        </span><span class="k">with</span><span class="w"> </span><span class="o">:?</span><span class="w"> </span><span class="n">TimeoutException</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">None</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<h3 id="1012">10.12 偶数カウント（並行版）<a class="headerlink" href="#1012" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="sd">/// 並行して実行し、偶数の数をカウント</span>
<span class="k">let</span><span class="w"> </span><span class="nv">countEvens</span><span class="w"> </span><span class="o">(</span><span class="n">asyncInts</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Ref</span><span class="p">.</span><span class="n">Of</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">tasks</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">asyncInts</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">asyncInt</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">                    </span><span class="k">let!</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asyncInt</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="n">counter</span><span class="o">.</span><span class="n">Update</span><span class="o">((+)</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="w">                </span><span class="o">})</span>
<span class="w">        </span><span class="k">do</span><span class="o">!</span><span class="w"> </span><span class="n">parSequence</span><span class="w"> </span><span class="n">tasks</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">Ignore</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">counter</span><span class="o">.</span><span class="n">Get</span><span class="bp">()</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>
<hr />
<h2 id="scala">Scala との比較<a class="headerlink" href="#scala" title="Permanent link">&para;</a></h2>
<h3 id="ref_1">Ref の比較<a class="headerlink" href="#ref_1" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Scala (Cats Effect)</th>
<th>F#</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ref.of[IO, A](initial)</code></td>
<td><code>Ref.Of(initial)</code></td>
<td>初期値で Ref を作成</td>
</tr>
<tr>
<td><code>ref.get</code></td>
<td><code>ref.Get()</code></td>
<td>現在の値を取得</td>
</tr>
<tr>
<td><code>ref.set(value)</code></td>
<td><code>ref.Set(value)</code></td>
<td>値を設定</td>
</tr>
<tr>
<td><code>ref.update(f)</code></td>
<td><code>ref.Update(f)</code></td>
<td>アトミックに更新</td>
</tr>
<tr>
<td><code>ref.modify(f)</code></td>
<td><code>ref.Modify(f)</code></td>
<td>更新して結果を返す</td>
</tr>
</tbody>
</table>
<h3 id="_8">並列実行の比較<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Scala (Cats Effect)</th>
<th>F#</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ios.parSequence</code></td>
<td><code>parSequence ios</code></td>
<td>並列実行</td>
</tr>
<tr>
<td><code>ios.sequence</code></td>
<td><code>sequence ios</code></td>
<td>順次実行</td>
</tr>
<tr>
<td><code>(io1, io2).parTupled</code></td>
<td><code>parTuple2 io1 io2</code></td>
<td>2つを並列実行</td>
</tr>
</tbody>
</table>
<h3 id="fiber">Fiber の比較<a class="headerlink" href="#fiber" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Scala (Cats Effect)</th>
<th>F#</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>io.start</code></td>
<td><code>start computation</code></td>
<td>Fiber を起動</td>
</tr>
<tr>
<td><code>fiber.join</code></td>
<td><code>fiber.Join</code></td>
<td>結果を待機</td>
</tr>
<tr>
<td><code>fiber.cancel</code></td>
<td><code>fiber.Cancel()</code></td>
<td>キャンセル</td>
</tr>
<tr>
<td><code>io.foreverM</code></td>
<td><code>foreverM io</code></td>
<td>永遠に繰り返す</td>
</tr>
</tbody>
</table>
<h3 id="agentactor">Agent（Actor）の比較<a class="headerlink" href="#agentactor" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Scala (Akka)</th>
<th>F#</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Actor</code></td>
<td><code>MailboxProcessor</code></td>
<td>メッセージベースの並行処理</td>
</tr>
<tr>
<td><code>actorRef ! message</code></td>
<td><code>agent.Post(message)</code></td>
<td>メッセージ送信（非同期）</td>
</tr>
<tr>
<td><code>actorRef ? message</code></td>
<td><code>agent.PostAndReply(f)</code></td>
<td>メッセージ送信（同期）</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_9">まとめ<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<h3 id="part-v_1">Part V で学んだこと<a class="headerlink" href="#part-v_1" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI0MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6Nzg2cHg7aGVpZ2h0OjI0MHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc4NiAyNDAiIHdpZHRoPSI3ODZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIFBhcnQgVjogPz8/Py0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iUGFydCBWLiAuLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfUGFydCBWLiAuLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyMi41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijc2OCIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNS40ODYxIiB4PSIzMzguMjU3IiB5PSIyNi45OTUxIj5QYXJ0IFY6ICYjMjAwMDY7JiMzNDg5MjsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBjaDEwLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJjaDEwIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImNsdXN0ZXJfY2gxMCI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIxNTUuNTkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI3MjAiIHg9IjM2IiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0Ny40ODIzIiB4PSIzNzIuMjU4OSIgeT0iNjkuOTk1MSI+JiMzMTUzMjsxMCYjMzE0NTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IFJlZj8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlJlZi4uLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0iZW50MDAwNCIgaWQ9ImVudGl0eV9SZWYuLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTk3LjI2ODkiIHg9IjUyLjM3IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE3Ny4yNjg5IiB4PSI2Mi4zNyIgeT0iMTA1Ljk5NTEiPlJlZiYjNjUyODg7JiMxMjQ3MzsmIzEyNTI0OyYjMTI0ODM7JiMxMjQ4OTsmIzEyNDc1OyYjMTI1NDA7JiMxMjUwMTsmIzIxNDQyOyYjMjkwMzE7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcGFyU2VxdWVuY2U/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icGFyU2VxdWVuY2UuLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5X3BhclNlcXVlbmNlLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxOTYuMjc4IiB4PSIyODQuODYiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTc2LjI3OCIgeD0iMjk0Ljg2IiB5PSIxMDUuOTk1MSI+cGFyU2VxdWVuY2UmIzY1Mjg4OyYjMjAwMDY7JiMyMTAxNTsmIzIzNDU1OyYjMzQ4OTI7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgRmliZXI/Pz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iRmliZXIuLi4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5X0ZpYmVyLi4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyMjMuMTk3NSIgeD0iNTE2LjQiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjAzLjE5NzUiIHg9IjUyNi40IiB5PSIxMDUuOTk1MSI+RmliZXImIzY1Mjg4OyYjMTI0NjE7JiMxMjUxNTsmIzEyNTMxOyYjMTI0NzU7JiMxMjUyMzsmIzIxNDg3OyYjMzMwMjE7JiMxMjQ3OTsmIzEyNDczOyYjMTI0NjM7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgZm9yZXZlck0/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJmb3JldmVyTS4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI4IiBkYXRhLXVpZD0iZW50MDAwNyIgaWQ9ImVudGl0eV9mb3JldmVyTS4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxOTQuNTk2MiIgeD0iNTMuNyIgeT0iMTcyLjI5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTc0LjU5NjIiIHg9IjYzLjciIHk9IjE4OC4yODUxIj5mb3JldmVyTSYjNjUyODg7JiMyNzcwNDsmIzMyMTU0OyYjMzAzNDA7JiMxMjM5NDsmIzIzNDU1OyYjMzQ4OTI7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgTWFpbGJveFByb2Nlc3Nvcj9BZ2VudD8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iTWFpbGJveFByb2Nlc3Nvci5BZ2VudC4iIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iZW50aXR5X01haWxib3hQcm9jZXNzb3IuQWdlbnQuIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyMTEuNTk3NSIgeD0iMjgzLjIiIHk9IjE3Mi4yOSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE5MS41OTc1IiB4PSIyOTMuMiIgeT0iMTg4LjI4NTEiPk1haWxib3hQcm9jZXNzb3ImIzY1Mjg4O0FnZW50JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1TUkM9W0tvcDlJQ3JETElaOElTcEN1LThnSWFxa0lTbkJwcWJMSzBmOEIyZkgyQkRJVUI5WnNPazVGS19SYnBzVnFBUWFLOHNpdkZjUURPTzZwclNsSzU5OEI1UDhwWjBxMDRlZDluUWJBMlc1ZlFRenR6Rm5rNmRkdS1Pclp2a1I3cFR0RmN4UV9SWHZwLUZjZ0tfeGN2d3RCZC1fZnJDOWdoT1dpSVd1alIwcURJeXY1UVc3UUR0SlprYkZyeXE3TWVnYW8ycXBBUks4UkVKUW55c0I3cFRsMWZrdC1jZF8tWFZEVW55dHhHVFByUkdVSUtEUVZiNWdNTWdIQnIzRmltcXhkYy1Sek5uTW8tRjZMSFc2LW9QY3ZZSmJMbUdLdklVZDVYVmRXLW5tSjRfREFtNGhnVU1nMUcwMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_10">主要コンポーネント<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ref&lt;'a&gt;</code></td>
<td>スレッドセーフな共有状態</td>
</tr>
<tr>
<td><code>parSequence</code></td>
<td>Async のリストを並列実行</td>
</tr>
<tr>
<td><code>Fiber</code></td>
<td>キャンセル可能な非同期タスク</td>
</tr>
<tr>
<td><code>start</code></td>
<td>Fiber をバックグラウンドで起動</td>
</tr>
<tr>
<td><code>foreverM</code></td>
<td>永遠に繰り返し実行</td>
</tr>
<tr>
<td><code>MailboxProcessor</code></td>
<td>メッセージベースの並行処理</td>
</tr>
</tbody>
</table>
<h3 id="_11">キーポイント<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Ref</strong>: 複数の並行処理から安全にアクセスできるスレッドセーフな参照</li>
<li><strong>parSequence</strong>: Async のリストを並列実行して結果を集約</li>
<li><strong>Fiber</strong>: バックグラウンドで実行されるキャンセル可能なタスク</li>
<li><strong>MailboxProcessor</strong>: F# ネイティブの Actor モデル実装</li>
<li><strong>Async.Parallel</strong>: 組み込みの並列実行機能</li>
</ol>
<h3 id="_12">設計パターン<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI0MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTQ5NnB4O2hlaWdodDoyNDBweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxNDk2IDI0MCIgd2lkdGg9IjE0OTZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMyIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJjbHVzdGVyXy4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyMi41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE0NzgiIHg9IjEyIiB5PSIxMiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNjc0LjAwMDMiIHk9IjI2Ljk5NTEiPiYjMjAwMDY7JiMzNDg5MjsmIzIwOTY2OyYjMjk3MDI7JiMxMjM5ODsmIzM1MzczOyYjMzUzMzY7JiMxMjQ5NzsmIzEyNDc5OyYjMTI1NDA7JiMxMjUzMTs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHAxLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwMSIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX3AxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjczLjI5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMzM5IiB4PSIzNiIgeT0iNTUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMyLjIxMzQiIHg9IjEzOS4zOTMzIiB5PSI2OS45OTUxIj4mIzEyNDk3OyYjMTI0Nzk7JiMxMjU0MDsmIzEyNTMxOzE6ICYjMjAwMDY7JiMyMTAxNTsmIzM4NTk4OyYjMzIwMDQ7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBwMi0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0icDIiIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iY2x1c3Rlcl9wMiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSI3My4yOSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjMzMSIgeD0iMzk5IiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzIuMjEzNCIgeD0iNDk4LjM5MzMiIHk9IjY5Ljk5NTEiPiYjMTI0OTc7JiMxMjQ3OTsmIzEyNTQwOyYjMTI1MzE7MjogJiMyMDg0OTsmIzI2Mzc3OyYjMjkzNjY7JiMyNDkwNzs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHAzLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwMyIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iY2x1c3Rlcl9wMyI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSI3My4yOSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjQyOSIgeD0iNzU0IiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMTYuMjEzIiB4PSI4NjAuMzkzNSIgeT0iNjkuOTk1MSI+JiMxMjQ5NzsmIzEyNDc5OyYjMTI1NDA7JiMxMjUzMTszOiAmIzEyNTEzOyYjMTI0ODM7JiMxMjQ3NTsmIzEyNTQwOyYjMTI0NzI7JiMxMjQ5NzsmIzEyNDgzOyYjMTI0NzE7JiMxMjUzMTsmIzEyNDY0OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgcDQtLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InA0IiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImVudDAwMTIiIGlkPSJjbHVzdGVyX3A0Ij48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE1NS41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjI1OSIgeD0iMTIwNyIgeT0iNTUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjE2LjIxMyIgeD0iMTIyOC4zOTM1IiB5PSI2OS45OTUxIj4mIzEyNDk3OyYjMTI0Nzk7JiMxMjU0MDsmIzEyNTMxOzQ6ICYjMTI0OTY7JiMxMjQ4MzsmIzEyNDYzOyYjMTI0NjQ7JiMxMjUyMTsmIzEyNDU0OyYjMTI1MzE7JiMxMjQ4OTsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/PyBBc3luYyA/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4gQXN5bmMgLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5Xy4uLiBBc3luYyAuLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTgyLjYyNjUiIHg9IjUxLjY5IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2Mi42MjY1IiB4PSI2MS42OSIgeT0iMTA1Ljk5NTEiPiYjMzUwNzk7JiMyNTk2ODsmIzEyMzk4OyBBc3luYyAmIzEyNDM0OyYjMjAwMDY7JiMyMTAxNTsmIzIzNDU1OyYjMzQ4OTI7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwNSIgaWQ9ImVudGl0eV8uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iODkuOTk5NyIgeD0iMjY5IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjI3OSIgeT0iMTA1Ljk5NTEiPiYjMzIwODA7JiMyNjUyNDsmIzEyNDM0OyYjMzg1OTg7JiMzMjAwNDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVmID8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSZWYgLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfUmVmIC4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTMxLjcxOTQiIHg9IjQxNS4xNCIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuNzE5NCIgeD0iNDI1LjE0IiB5PSIxMDUuOTk1MSI+UmVmICYjMTIzOTE7JiMyOTM2NjsmIzI0OTA3OyYjMTI0MzQ7JiMyMDg0OTsmIzI2Mzc3OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iZW50aXR5Xy4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzEuOTk5NSIgeD0iNTgyIiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSI1OTIiIHk9IjEwNS45OTUxIj4mIzM1MDc5OyYjMjU5Njg7JiMxMjM5ODsmIzIwOTY2OyYjMjk3MDI7JiMxMjM2NDsmIzI2MzU2OyYjMjYwMzI7PC90ZXh0PjwvZz48IS0tZW50aXR5IE1haWxib3hQcm9jZXNzb3IgPz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ik1haWxib3hQcm9jZXNzb3IgLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxNSIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJlbnRpdHlfTWFpbGJveFByb2Nlc3NvciAuLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjIzMC42MDgiIHg9Ijc2OS43IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIxMC42MDgiIHg9Ijc3OS43IiB5PSIxMDUuOTk1MSI+TWFpbGJveFByb2Nlc3NvciAmIzEyMzkxOyYjMjkzNjY7JiMyNDkwNzsmIzEyNDM0OyYjMzE2NDk7JiMyOTcwMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjE2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV8uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTMxLjk5OTUiIHg9IjEwMzUiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjEwNDUiIHk9IjEwNS45OTUxIj4mIzEyNTEzOyYjMTI0ODM7JiMxMjQ3NTsmIzEyNTQwOyYjMTI0NzI7JiMxMjM5MTsmIzM2ODkwOyYjMjA0NDk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEZpYmVyID8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJGaWJlciAuLi4iIGRhdGEtc291cmNlLWxpbmU9IjIwIiBkYXRhLXVpZD0iZW50MDAxMyIgaWQ9ImVudGl0eV9GaWJlciAuLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEwMS42NDgzIiB4PSIxMjIzLjE4IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgxLjY0ODMiIHg9IjEyMzMuMTgiIHk9IjEwNS45OTUxIj5GaWJlciAmIzEyMzkxOyYjMzYyMTU7JiMyMTIwNTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjIxIiBkYXRhLXVpZD0iZW50MDAxNCIgaWQ9ImVudGl0eV8uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iODkuOTk5NyIgeD0iMTM2MCIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSIxMzcwIiB5PSIxMDUuOTk1MSI+JiMyMTA0NjsmIzI0NDgxOyYjMTI0MzQ7JiMzNjgyMDsmIzEyMzc3OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/Lz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjIyIiBkYXRhLXVpZD0iZW50MDAxNSIgaWQ9ImVudGl0eV8uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNTAuNzE2MiIgeD0iMTIyMi42NCIgeT0iMTcyLjI5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMwLjcxNjIiIHg9IjEyMzIuNjQiIHk9IjE4OC4yODUxIj4mIzI0NDYwOyYjMTIzOTE7JiMzMjA4MDsmIzI2NTI0OyYjMTI0MzQ7JiMyMTQ2MjsmIzI0NDcxOy8mIzIwNTcyOyYjMjc0OTA7PC90ZXh0PjwvZz48IS0tU1JDPVtWUDdESmk5MDU4TnRWT2duQnMzdU1SNXB1eXg0LTBRYkxZTDE4MnFCWkk2bjdWYUo0ajQ4SDI2UTZXRXUwMzdvYnNaV09JdXBCTV9YMzRDUjlEN2J0N0ZrRVRfRFJBTEZqNUNEZlU5QUIyNTlrZ1FjYlNIbk40Rm9WRDlveEpCOWp2bkEzaW9Vcy1jd2RHQldNeDFjV0J5MVZ5aGVPanNfQldLWVlBc0pHZHRIbzNjM0FuYWYxYWU1YzV6THo0Q2Frd3p2TWtzcEtCSFpkMlRLMURRVGk5RlVDLWtLTHBQZE1BNUZKSVFrS2dJQ3o1VFhDODk4emVDc1l5eHJZNlBCZVozZTVudmVIbVpDalgxUGVGM0FjcFpVaU1OUTZEMVFfeF8ySzBHMWpXNVppQnh1bjlmbWJKXzdKME1oQm4xMkZpQVU0ZWo3YXNWeFViQkwzMkVmXy05blVaT2h6ZFdzV3l0c3VsOW5GaEZfdW1icGRpZm94UHNyMHR1M2d5TDlTNTVTOU5aMkZpemtCQWVqOFRwWGM5SWdOWlNmWkNaS1BhWmt4MXhDMXR5eUJORFV4cUY4Sk9yQ3d6bDRSREJrMnlWQV8wMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<hr />
<h2 id="_13">演習問題<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<h3 id="1-ref">問題 1: Ref の基本<a class="headerlink" href="#1-ref" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。カウンターを 0 から始めて、3回インクリメントした結果を返します。</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">incrementThreeTimes</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">???</span>

<span class="c1">// 期待される動作</span>
<span class="n">incrementThreeTimes</span><span class="w"> </span><span class="bp">()</span><span class="w">  </span><span class="c1">// 3</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">incrementThreeTimes</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Ref</span><span class="p">.</span><span class="n">Of</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
<span class="w">    </span><span class="n">counter</span><span class="o">.</span><span class="n">Update</span><span class="o">((+)</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="w">    </span><span class="n">counter</span><span class="o">.</span><span class="n">Update</span><span class="o">((+)</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="w">    </span><span class="n">counter</span><span class="o">.</span><span class="n">Update</span><span class="o">((+)</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="w">    </span><span class="n">counter</span><span class="o">.</span><span class="n">Get</span><span class="bp">()</span>
</code></pre></div>

</details>

<h3 id="2">問題 2: 並列実行<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。3つの Async を並列実行し、結果の合計を返します。</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">sumParallel</span><span class="w"> </span><span class="o">(</span><span class="n">async1</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">(</span><span class="n">async2</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">(</span><span class="n">async3</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">???</span>

<span class="c1">// 期待される動作</span>
<span class="n">sumParallel</span><span class="w"> </span><span class="o">(</span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">})</span><span class="w"> </span><span class="o">(</span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">})</span><span class="w"> </span><span class="o">(</span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">})</span>
<span class="o">|&gt;</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">RunSynchronously</span><span class="w">  </span><span class="c1">// 6</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">sumParallel</span><span class="w"> </span><span class="o">(</span><span class="n">async1</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">(</span><span class="n">async2</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">(</span><span class="n">async3</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="k">let!</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">async1</span><span class="o">;</span><span class="w"> </span><span class="n">async2</span><span class="o">;</span><span class="w"> </span><span class="n">async3</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">parSequence</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">sum</span><span class="w"> </span><span class="n">results</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>

</details>

<h3 id="3_1">問題 3: 並行カウント<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。Async のリストを並行実行し、そのうち偶数を返した回数をカウントします。</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">countEvensInList</span><span class="w"> </span><span class="o">(</span><span class="n">asyncInts</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">???</span>

<span class="c1">// 使用例</span>
<span class="k">let</span><span class="w"> </span><span class="nv">asyncInts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">}</span>
<span class="o">]</span>
<span class="n">countEvensInList</span><span class="w"> </span><span class="n">asyncInts</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">RunSynchronously</span><span class="w">  </span><span class="c1">// 3</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">countEvensInList</span><span class="w"> </span><span class="o">(</span><span class="n">asyncInts</span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Async</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Ref</span><span class="p">.</span><span class="n">Of</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">tasks</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">asyncInts</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">asyncInt</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">                    </span><span class="k">let!</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asyncInt</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="n">counter</span><span class="o">.</span><span class="n">Update</span><span class="o">((+)</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="w">                </span><span class="o">})</span>
<span class="w">        </span><span class="k">do</span><span class="o">!</span><span class="w"> </span><span class="n">parSequence</span><span class="w"> </span><span class="n">tasks</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">Ignore</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">counter</span><span class="o">.</span><span class="n">Get</span><span class="bp">()</span>
<span class="w">    </span><span class="o">}</span>
</code></pre></div>

</details>

<h3 id="4-mailboxprocessor">問題 4: MailboxProcessor<a class="headerlink" href="#4-mailboxprocessor" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。メッセージを受け取ってリストに追加し、リストを取得できる Agent を作成します。</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">ListMessage</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GetAll</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">AsyncReplyChannel</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="kt">list</span><span class="o">&gt;</span>

<span class="k">let</span><span class="w"> </span><span class="nv">createListAgent</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MailboxProcessor</span><span class="o">&lt;</span><span class="n">ListMessage</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">???</span>

<span class="c1">// 期待される動作</span>
<span class="k">let</span><span class="w"> </span><span class="nv">agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createListAgent</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w"> </span><span class="bp">()</span>
<span class="n">agent</span><span class="o">.</span><span class="n">Post</span><span class="o">(</span><span class="n">Add</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="n">agent</span><span class="o">.</span><span class="n">Post</span><span class="o">(</span><span class="n">Add</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span>
<span class="n">agent</span><span class="o">.</span><span class="n">Post</span><span class="o">(</span><span class="n">Add</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span>
<span class="n">agent</span><span class="o">.</span><span class="n">PostAndReply</span><span class="o">(</span><span class="n">GetAll</span><span class="o">)</span><span class="w">  </span><span class="c1">// [1; 2; 3] または [3; 2; 1]</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="w"> </span><span class="nc">ListMessage</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">GetAll</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">AsyncReplyChannel</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="kt">list</span><span class="o">&gt;</span>

<span class="k">let</span><span class="w"> </span><span class="nv">createListAgent</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MailboxProcessor</span><span class="o">&lt;</span><span class="n">ListMessage</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nn">MailboxProcessor</span><span class="p">.</span><span class="n">Start</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="n">inbox</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">let</span><span class="w"> </span><span class="nv">rec</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="o">(</span><span class="n">items</span><span class="o">:</span><span class="w"> </span><span class="k">&#39;</span><span class="n">a</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="k">let!</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inbox</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">with</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">return</span><span class="o">!</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="o">(</span><span class="n">item</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">items</span><span class="o">)</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">GetAll</span><span class="w"> </span><span class="n">replyChannel</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">replyChannel</span><span class="o">.</span><span class="n">Reply</span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span><span class="w"> </span><span class="n">items</span><span class="o">)</span>
<span class="w">                    </span><span class="k">return</span><span class="o">!</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">items</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="n">loop</span><span class="w"> </span><span class="bp">[]</span><span class="o">)</span>
</code></pre></div>

</details>

<h3 id="5">問題 5: タイムアウト付き収集<a class="headerlink" href="#5" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。指定時間後に処理を停止し、それまでに蓄積された結果を返します。</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">collectFor</span><span class="w"> </span><span class="o">(</span><span class="n">durationMs</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">producer</span><span class="o">:</span><span class="w"> </span><span class="kt">unit</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">???</span>

<span class="c1">// 期待される動作</span>
<span class="c1">// 100msごとに乱数を生成して、1秒間収集</span>
<span class="c1">// 約10個の要素が返される</span>
<span class="n">collectFor</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="bp">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">random</span><span class="o">.</span><span class="n">Next</span><span class="o">(</span><span class="mi">100</span><span class="o">))</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="k">let</span><span class="w"> </span><span class="nv">collectFor</span><span class="w"> </span><span class="o">(</span><span class="n">durationMs</span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n">producer</span><span class="o">:</span><span class="w"> </span><span class="kt">unit</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">int</span><span class="o">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">collected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">Ref</span><span class="p">.</span><span class="n">Of</span><span class="o">(</span><span class="bp">[]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span><span class="nv">cts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CancellationTokenSource</span><span class="bp">()</span>

<span class="w">    </span><span class="c1">// 100msごとに値を追加するプログラム</span>
<span class="w">    </span><span class="nn">Async</span><span class="p">.</span><span class="n">Start</span><span class="o">(</span>
<span class="w">        </span><span class="n">async</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="k">do</span>
<span class="w">                </span><span class="k">do</span><span class="o">!</span><span class="w"> </span><span class="nn">Async</span><span class="p">.</span><span class="n">Sleep</span><span class="w"> </span><span class="mi">100</span>
<span class="w">                </span><span class="k">let</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="bp">()</span>
<span class="w">                </span><span class="n">collected</span><span class="o">.</span><span class="n">Update</span><span class="o">(</span><span class="k">fun</span><span class="w"> </span><span class="kt">list</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="kt">list</span><span class="o">)</span>
<span class="w">        </span><span class="o">},</span>
<span class="w">        </span><span class="n">cts</span><span class="o">.</span><span class="n">Token</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// 指定時間待機</span>
<span class="w">    </span><span class="nn">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="o">(</span><span class="n">durationMs</span><span class="o">)</span>

<span class="w">    </span><span class="c1">// キャンセル</span>
<span class="w">    </span><span class="n">cts</span><span class="o">.</span><span class="n">Cancel</span><span class="bp">()</span>

<span class="w">    </span><span class="c1">// 結果を取得（逆順にして返す）</span>
<span class="w">    </span><span class="n">collected</span><span class="o">.</span><span class="n">Get</span><span class="bp">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span>
</code></pre></div>

</details>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>