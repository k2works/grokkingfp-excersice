
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Scala、Java、F#、C#、Haskell、Clojure で学ぶ関数型プログラミング">
      
      
        <meta name="author" content="Project Team">
      
      
      
        <link rel="prev" href="../part-4/">
      
      
        <link rel="next" href="../part-6/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Part V - 並行処理 - Grokking Functional Programming</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#part-v" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Grokking Functional Programming" class="md-header__button md-logo" aria-label="Grokking Functional Programming" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Grokking Functional Programming
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Part V - 並行処理
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/grokkingfp-excersice" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    grokkingfp-excersice
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../scala/" class="md-tabs__link">
          
  
  
  Scala

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  Java

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../fsharp/" class="md-tabs__link">
          
  
  
  F#

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../csharp/" class="md-tabs__link">
          
  
  
  C#

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../haskell/" class="md-tabs__link">
          
  
  
  Haskell

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../clojure/" class="md-tabs__link">
          
  
  
  Clojure

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Grokking Functional Programming" class="md-nav__button md-logo" aria-label="Grokking Functional Programming" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Grokking Functional Programming
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/grokkingfp-excersice" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    grokkingfp-excersice
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Scala
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Scala
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO と副作用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Java
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Java
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO と副作用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      
        第10章: 並行・並列処理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第10章: 並行・並列処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 並行処理の課題
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 チェックインのリアルタイム集計
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.2 チェックインのリアルタイム集計">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#n" class="md-nav__link">
    <span class="md-ellipsis">
      
        トップ N 都市の計算（純粋関数）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.3 逐次処理の問題
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#104-ref-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.4 Ref - アトミックな共有状態
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.4 Ref - アトミックな共有状態">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ref" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ref の使用例
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ref_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ref の主要メソッド
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modify" class="md-nav__link">
    <span class="md-ellipsis">
      
        modify の使用例
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#105-parallelio-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.5 ParallelIO - 並列実行
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.5 ParallelIO - 並列実行">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        並列実行の効果
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#partraverse" class="md-nav__link">
    <span class="md-ellipsis">
      
        parTraverse
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#106" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.6 チェックイン処理の並行版
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.6 チェックイン処理の並行版">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        チェックインの保存
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        並行処理版
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#107-partuple-parmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.7 parTuple と parMap
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.7 parTuple と parMap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#partuple2-partuple3" class="md-nav__link">
    <span class="md-ellipsis">
      
        parTuple2 / parTuple3
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parmap2" class="md-nav__link">
    <span class="md-ellipsis">
      
        parMap2
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#108-race-timeout" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.8 race と timeout
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.8 race と timeout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#race-" class="md-nav__link">
    <span class="md-ellipsis">
      
        race - 競争
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timeout-" class="md-nav__link">
    <span class="md-ellipsis">
      
        timeout - タイムアウト
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#109-fiber-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.9 Fiber - 軽量スレッド
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.9 Fiber - 軽量スレッド">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fiber" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fiber の実装
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fiber_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fiber の起動とキャンセル
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fiber_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fiber の主要メソッド
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1010" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.10 呼び出し元に制御を返す
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1011-parfold-" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.11 parFold - 並列実行して集約
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1012-java-21-virtual-thread" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.12 Java 21 Virtual Thread の活用
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        まとめ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="まとめ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-v_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part V で学んだこと
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        主要コンポーネント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        キーポイント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        設計パターン
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scala" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scala との比較
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        演習問題
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="演習問題">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-ref" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 1: Ref の基本
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 2: 並列実行
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 3: 並行カウント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 4: タイムアウト付き実行
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      
        問題 5: 並行マップ更新
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    F#
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    F#
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - 非同期処理とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fsharp/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    C#
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    C#
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - 非同期処理とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csharp/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Haskell
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Haskell
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - IO とストリーム
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haskell/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Clojure
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Clojure
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I - 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II - 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III - nil 安全性
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV - 副作用とシーケンス
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V - 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clojure/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI - 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="part-v">Part V: 並行処理<a class="headerlink" href="#part-v" title="Permanent link">&para;</a></h1>
<p>本章では、関数型プログラミングにおける並行処理を学びます。Ref による安全な共有状態管理、Fiber による軽量スレッド、そして並列 IO 操作の構築方法を習得します。</p>
<hr />
<h2 id="10">第10章: 並行・並列処理<a class="headerlink" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="101">10.1 並行処理の課題<a class="headerlink" href="#101" title="Permanent link">&para;</a></h3>
<p>従来の並行処理には多くの課題があります:</p>
<ul>
<li>デッドロック</li>
<li>競合状態（Race Condition）</li>
<li>共有状態の管理の複雑さ</li>
<li>スレッドのオーバーヘッド</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQyN3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODY3cHg7aGVpZ2h0OjQyN3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDg2NyA0MjciIHdpZHRoPSI4NjdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl8uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjQwOS44OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijg0OSIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzNjYuNTAwMyIgeT0iMjYuOTk1MSI+JiMyNDQ2NzsmIzI2NDY5OyYjMTIzOTg7JiMyMDAwNjsmIzM0ODkyOyYjMjA5NjY7JiMyOTcwMjsmIzEyMzk4OyYjMjE4Mzk7JiMzODk4ODs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHByb2JsZW1zLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwcm9ibGVtcyIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX3Byb2JsZW1zIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyNS41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjMxMyIgeD0iNDQiIHk9IjYzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI3Ljk5OTkiIHg9IjE4Ni41MDAxIiB5PSI3Ny45OTUxIj4mIzIxODM5OyYjMzg5ODg7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBzb2x1dGlvbnMtLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InNvbHV0aW9ucyIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iY2x1c3Rlcl9zb2x1dGlvbnMiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMTkwLjU5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNDMyIiB4PSIzOTciIHk9IjE5OS4zIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjU2NC4wMDAyIiB5PSIyMTQuMjk1MSI+JiMzODMwNjsmIzI1OTY4OyYjMjI0MTE7JiMxMjM5ODsmIzM1Mjk5OyYjMjc3NzA7JiMzMTU3NDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJlbnRpdHlfLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMDMuOTk5NiIgeD0iNzUiIHk9IjEwNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjk5OTYiIHg9Ijg1IiB5PSIxMjEuOTk1MSI+JiMxMjQ4NzsmIzEyNDgzOyYjMTI0ODk7JiMxMjUyNTsmIzEyNDgzOyYjMTI0NjM7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNzUuOTk5OCIgeD0iMjE0IiB5PSIxMDYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIyMjQiIHk9IjEyMS45OTUxIj4mIzMxNDc4OyYjMjE1MTI7JiMyOTM2NjsmIzI0OTA3OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5Xy4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExNy45OTk2IiB4PSI2OCIgeT0iMjQyLjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ny45OTk2IiB4PSI3OCIgeT0iMjU4LjI5NTEiPiYjMjE0ODc7JiMyMjc5MzsmIzI5MzY2OyYjMjQ5MDc7JiMxMjM5ODsmIzIwODQ5OyYjMjYzNzc7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjgiIGRhdGEtdWlkPSJlbnQwMDA3IiBpZD0iZW50aXR5Xy4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTAzLjk5OTYiIHg9IjIyMSIgeT0iMjQyLjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSIyMzEiIHk9IjI1OC4yOTUxIj4mIzEyNDczOyYjMTI1MjQ7JiMxMjQ4MzsmIzEyNDg5OyYjMzE2NDk7JiMyOTcwMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDkiIGlkPSJlbnRpdHlfLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTU5Ljk5OTQiIHg9IjQyMSIgeT0iMjQyLjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzkuOTk5NCIgeD0iNDMxIiB5PSIyNTguMjk1MSI+JiMxMjQ1MjsmIzEyNTExOyYjMTI1MTc7JiMxMjU0MDsmIzEyNDc5OyYjMTI1MDI7JiMxMjUyMzsmIzEyNDg3OyYjMTI1NDA7JiMxMjQ3OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVmPz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IlJlZi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTMiIGRhdGEtdWlkPSJlbnQwMDEwIiBpZD0iZW50aXR5X1JlZi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTY5LjI2OSIgeD0iNjE2LjM3IiB5PSIyNDIuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0OS4yNjkiIHg9IjYyNi4zNyIgeT0iMjU4LjI5NTEiPlJlZiYjNjUyODg7JiMxMjQ1MDsmIzEyNDg4OyYjMTI1MTE7JiMxMjQ4MzsmIzEyNDYzOyYjMjE0NDI7JiMyOTAzMTsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSBGaWJlcj8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkZpYmVyLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjE0IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9GaWJlci4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNjcuMTk3OCIgeD0iNDIxLjQiIHk9IjM0My41OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0Ny4xOTc4IiB4PSI0MzEuNCIgeT0iMzU5LjU4NTEiPkZpYmVyJiM2NTI4ODsmIzM2NjA1OyYjMzczMjc7JiMxMjQ3MzsmIzEyNTI0OyYjMTI0ODM7JiMxMjQ4OTsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTUiIGRhdGEtdWlkPSJlbnQwMDEyIiBpZD0iZW50aXR5Xy4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMzEuOTk5NSIgeD0iNjI0IiB5PSIzNDMuNTkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuOTk5NSIgeD0iNjM0IiB5PSIzNTkuNTg1MSI+JiMyMzQ1OTsmIzM1MzI4OyYjMzAzNDA7JiMxMjM5NDsmIzIwMDA2OyYjMzQ4OTI7JiMyMDk2NjsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWxpbmsgcHJvYmxlbXMgdG8gc29sdXRpb25zLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InByb2JsZW1zIiBkYXRhLWVudGl0eS0yPSJzb2x1dGlvbnMiIGRhdGEtc291cmNlLWxpbmU9IjE5IiBkYXRhLXVpZD0ibG5rMTMiIGlkPSJsaW5rX3Byb2JsZW1zX3NvbHV0aW9ucyI+PHBhdGggZD0iTTM1Ny40Mzg3LDExOS4yOTg2IEMzNTcuNjk4OCwxMTkuMzM0MSAzNTcuOTY0NSwxMTkuMzcwMyAzNTguMjM1OCwxMTkuNDA3MyBDMzU5LjMyMTEsMTE5LjU1NTMgMzYwLjQ5NTgsMTE5LjcxNTUgMzYxLjc1NjYsMTE5Ljg4NzUgQzM2NC4yNzgzLDEyMC4yMzE0IDM2Ny4xNDQ0LDEyMC42MjI2IDM3MC4zMjg1LDEyMS4wNTc0IEMzODMuMDY0NiwxMjIuNzk2NyA0MDAuODg3LDEyNS4yMzQ3IDQyMi4wOTQ1LDEyOC4xNDY5IEM0NjQuNTA5NywxMzMuOTcxMyA1MjAuNDY1NiwxNDEuNjkyNSA1NzYuMzUzOCwxNDkuNTE1IEM2ODguMTMsMTY1LjE2IDc5OS42MzUsMTgxLjIxIDgwMiwxODMuMyBDODA0Ljg5NSwxODUuODUyNSA4MDcuMzY3NSwxODguODAwOCA4MDkuNDc3NCwxOTIuMDExNiBDODEwLjUzMjMsMTkzLjYxNyA4MTEuNDk2NiwxOTUuMjg4IDgxMi4zNzc3LDE5Ny4wMDc5IEM4MTIuNTk3OSwxOTcuNDM3OSA4MTIuODEzLDE5Ny44NzEgODEzLjAyMywxOTguMzA2OSBDODEzLjEyOCwxOTguNTI0OCA4MTMuMjMxNywxOTguNzQzNCA4MTMuMzM0MiwxOTguOTYyNyBDODEzLjM4NTQsMTk5LjA3MjQgODEwLjkyODEsMTkzLjczMTYgODEwLjk3ODcsMTkzLjg0MTYiIGZpbGw9Im5vbmUiIGlkPSJwcm9ibGVtcy10by1zb2x1dGlvbnMiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjgxMy40ODcsMTk5LjI5MjEsODEzLjM1ODMsMTg5LjQ0NDEsODExLjM5NjgsMTk0Ljc1LDgwNi4wOTA5LDE5Mi43ODg1LDgxMy40ODcsMTk5LjI5MjEiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iNzU0LjA2IiB5PSIxNzEuMzY2OSI+JiMzODMwNjsmIzI1OTY4OyYjMjI0MTE7JiMxMjQ1MDsmIzEyNTAzOyYjMTI1MjU7JiMxMjU0MDsmIzEyNDgxOzwvdGV4dD48L2c+PCEtLVNSQz1bTFAxOUppRDA0NE50RUtOWlZJeDBXWUs3dTBQRVEyMklDeVc5QXVJNGtwMkU4UDhaZUhXOUNTV1A0STRFc0tHQzFXdkpqRGpQdkdndWRHNWRyck5yZy1semxyS3hlYUxBQWZmUUE2S29FaXROckRBWEhlZDJsd18zLW51UV9relJGXzhRdEVnQnZhTFN5Zk9weW5lQUVUYUdCdmpnYkxKcVNhd1puTWVpb0Fsd0ZiNEdCMEgwaTE1NnlpNzZvZDhZWGJGVWg4bEJRTVhVaE5oUzZWRWtsVVo5US1PYWxCRE5Hc0psMjItQnR1SmxuSzFBdmRJM1VrUXNtek9oVnYyeHFRMEpKWng0bzRzdWdjTmprNU9lYnI5V2g4bG1ZRDEzMjkzejhCVzhtdUhNYmdrUlVfSFc3aklIakg3Z1lMbXd1MHVKdmMwVWhDYnMycGNnbnhoZXlzamNFTWRFYjhaeGRVWmZKRG9VZV82U0piTVFZNnNpYXlqY1RyQXVzLUpWYkFJdUlOOEM0OG1fXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="102">10.2 チェックインのリアルタイム集計<a class="headerlink" href="#102" title="Permanent link">&para;</a></h3>
<p><strong>ソースファイル</strong>: <code>app/java/src/main/java/ch10/CheckIns.java</code></p>
<p>都市へのチェックインをリアルタイムで集計し、ランキングを更新する例を見ていきます。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">record</span> <span class="nc">City</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">record</span> <span class="nc">CityStats</span><span class="p">(</span><span class="n">City</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">checkIns</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="c1">// サンプルのチェックインデータを生成</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">City</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">sampleCheckIns</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">repeatCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">City</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">City</span><span class="p">(</span><span class="s">&quot;Sydney&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">City</span><span class="p">(</span><span class="s">&quot;Dublin&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">City</span><span class="p">(</span><span class="s">&quot;Cape Town&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">City</span><span class="p">(</span><span class="s">&quot;Lima&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">City</span><span class="p">(</span><span class="s">&quot;Singapore&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">repeatCount</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cities</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="n">トップ N 都市の計算（純粋関数）<a class="headerlink" href="#n" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">CityStats</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">topCities</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cityCheckIns</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cityCheckIns</span><span class="p">.</span><span class="na">toList</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CityStats</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">_1</span><span class="p">(),</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">_2</span><span class="p">()))</span>
<span class="w">            </span><span class="p">.</span><span class="na">sortBy</span><span class="p">(</span><span class="n">stats</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">-</span><span class="n">stats</span><span class="p">.</span><span class="na">checkIns</span><span class="p">())</span><span class="w">  </span><span class="c1">// 降順</span>
<span class="w">            </span><span class="p">.</span><span class="na">take</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="103">10.3 逐次処理の問題<a class="headerlink" href="#103" title="Permanent link">&para;</a></h3>
<p>最初の実装は逐次処理で、シンプルですがパフォーマンスに問題があります。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">CityStats</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">processCheckInsSequential</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">City</span><span class="o">&gt;</span><span class="w"> </span><span class="n">checkIns</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">topN</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">delay</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cityCheckIns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkIns</span><span class="p">.</span><span class="na">foldLeft</span><span class="p">(</span>
<span class="w">                </span><span class="n">HashMap</span><span class="p">.</span><span class="o">&lt;</span><span class="n">City</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="n">empty</span><span class="p">(),</span>
<span class="w">                </span><span class="n">CheckIns</span><span class="p">::</span><span class="n">updateCheckIns</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">topCities</span><span class="p">(</span><span class="n">cityCheckIns</span><span class="p">,</span><span class="w"> </span><span class="n">topN</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">updateCheckIns</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">City</span><span class="w"> </span><span class="n">city</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">city</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="na">getOrElse</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQ3N3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MjIxcHg7aGVpZ2h0OjQ3N3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDIyMSA0NzciIHdpZHRoPSIyMjFweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl8uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjM3MS4xOCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE0NCIgeD0iNDAuNSIgeT0iMTIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iNjMuNTAwMiIgeT0iMjYuOTk1MSI+JiMzNjg4MDsmIzI3NDI1OyYjMjA5NjY7JiMyOTcwMjsmIzEyMzk4OyYjMjE4Mzk7JiMzODk4ODs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgYzEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iYzEiIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X2MxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMTIuOTA2OSIgeD0iNTYuMDUiIHk9IjQ3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTIuOTA2OSIgeD0iNjYuMDUiIHk9IjYyLjk5NTEiPiYjMTI0ODE7JiMxMjQ1NTsmIzEyNDgzOyYjMTI0NjM7JiMxMjQ1MjsmIzEyNTMxOzE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgYzItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iYzIiIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X2MyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMTIuOTA2OSIgeD0iNTYuMDUiIHk9IjE0Ni4yOSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkyLjkwNjkiIHg9IjY2LjA1IiB5PSIxNjIuMjg1MSI+JiMxMjQ4MTsmIzEyNDU1OyYjMTI0ODM7JiMxMjQ2MzsmIzEyNDUyOyYjMTI1MzE7MjwvdGV4dD48L2c+PCEtLWVudGl0eSBjMy0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJjMyIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfYzMiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExMi45MDY5IiB4PSI1Ni4wNSIgeT0iMjQ1LjU5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTIuOTA2OSIgeD0iNjYuMDUiIHk9IjI2MS41ODUxIj4mIzEyNDgxOyYjMTI0NTU7JiMxMjQ4MzsmIzEyNDYzOyYjMTI0NTI7JiMxMjUzMTszPC90ZXh0PjwvZz48IS0tZW50aXR5IGRvdHMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iZG90cyIgZGF0YS1zb3VyY2UtbGluZT0iNyIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJlbnRpdHlfZG90cyI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMzMuMzUwNiIgeD0iOTUuODIiIHk9IjM0NC44OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzLjM1MDYiIHg9IjEwNS44MiIgeT0iMzYwLjg4NTEiPi4uLjwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjEwIiBkYXRhLXNvdXJjZS1saW5lPSIxNSIgZGF0YS11aWQ9ImVudDAwMTEiIGlkPSJlbnRpdHlfR01OMTAiPjxwYXRoIGQ9Ik0xMSw0MzAuMTggTDExLDQ3MC40NDU2IEEwLDAgMCAwIDAgMTEsNDcwLjQ0NTYgTDIxNC4wMDAyLDQ3MC40NDU2IEEwLDAgMCAwIDAgMjE0LjAwMDIsNDcwLjQ0NTYgTDIxNC4wMDAyLDQ0MC4xOCBMMjA0LjAwMDIsNDMwLjE4IEwxMTYuNSw0MzAuMTggTDExMi41LDM2Ny42MiBMMTA4LjUsNDMwLjE4IEwxMSw0MzAuMTggQTAsMCAwIDAgMCAxMSw0MzAuMTgiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNMjA0LjAwMDIsNDMwLjE4IEwyMDQuMDAwMiw0NDAuMTggTDIxNC4wMDAyLDQ0MC4xOCBMMjA0LjAwMDIsNDMwLjE4IiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTgyLjAwMDIiIHg9IjE3IiB5PSI0NDcuMjQ2OSI+JiMyMTUwODsmIzEyNDgxOyYjMTI0NTU7JiMxMjQ4MzsmIzEyNDYzOyYjMTI0NTI7JiMxMjUzMTsmIzEyMzY0OyYjMjM0MzY7JiMyMDEwMjsmIzEyMzc3OyYjMTI0Mjc7JiMxMjQxNDsmIzEyMzkxOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzAuMDAwMiIgeD0iMTciIHk9IjQ2Mi4zNzk3Ij4mIzI3NDI1OyYjMTIzOTg7JiMyMDk2NjsmIzI5NzAyOyYjMTIzNjQ7JiMyMjk4NzsmIzEyNDE0OyYjMTI0MjU7JiMxMjM5NDsmIzEyMzU2OzwvdGV4dD48L2c+PCEtLWxpbmsgYzEgdG8gYzItLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iYzEiIGRhdGEtZW50aXR5LTI9ImMyIiBkYXRhLXNvdXJjZS1saW5lPSI5IiBkYXRhLXVpZD0ibG5rNyIgaWQ9ImxpbmtfYzFfYzIiPjxwYXRoIGQ9Ik0xMTIuNSw2OS41NiBDMTEyLjUsODguMTkgMTEyLjUsMTIxLjAyIDExMi41LDEzOS44MSIgZmlsbD0ibm9uZSIgaWQ9ImMxLXRvLWMyIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMTIuNSwxNDUuODEsMTE2LjUsMTM2LjgxLDExMi41LDE0MC44MSwxMDguNSwxMzYuODEsMTEyLjUsMTQ1LjgxIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjYiIHg9IjExMy41IiB5PSIxMTIuMzU2OSI+JiMyNDQ1MzsmIzI3MjMxOzwvdGV4dD48L2c+PCEtLWxpbmsgYzIgdG8gYzMtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iYzIiIGRhdGEtZW50aXR5LTI9ImMzIiBkYXRhLXNvdXJjZS1saW5lPSIxMCIgZGF0YS11aWQ9ImxuazgiIGlkPSJsaW5rX2MyX2MzIj48cGF0aCBkPSJNMTEyLjUsMTY4Ljg1IEMxMTIuNSwxODcuNDggMTEyLjUsMjIwLjMyIDExMi41LDIzOS4xMSIgZmlsbD0ibm9uZSIgaWQ9ImMyLXRvLWMzIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMTIuNSwyNDUuMTEsMTE2LjUsMjM2LjExLDExMi41LDI0MC4xMSwxMDguNSwyMzYuMTEsMTEyLjUsMjQ1LjExIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjYiIHg9IjExMy41IiB5PSIyMTEuNjU2OSI+JiMyNDQ1MzsmIzI3MjMxOzwvdGV4dD48L2c+PCEtLWxpbmsgYzMgdG8gZG90cy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJjMyIgZGF0YS1lbnRpdHktMj0iZG90cyIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJsbms5IiBpZD0ibGlua19jM19kb3RzIj48cGF0aCBkPSJNMTEyLjUsMjY4LjE1IEMxMTIuNSwyODYuNzggMTEyLjUsMzE5LjYyIDExMi41LDMzOC40IiBmaWxsPSJub25lIiBpZD0iYzMtdG8tZG90cyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTEyLjUsMzQ0LjQsMTE2LjUsMzM1LjQsMTEyLjUsMzM5LjQsMTA4LjUsMzM1LjQsMTEyLjUsMzQ0LjQiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNiIgeD0iMTEzLjUiIHk9IjMxMC45NTY5Ij4mIzI0NDUzOyYjMjcyMzE7PC90ZXh0PjwvZz48IS0tU1JDPVtUUDJuMmk5MDM4UnRGNE5pUmc3anZrMnhyRlBHR0xsSHNxSm1oYktIMnRQblMxOTFCOGhldUVSV295SEpWMGxSQVlYOGpfM2JJcUItNGMtbURpREVvc3Z3MDV0Y1NEa2hqblhncHM1eUZ3cExQRms4bm9JRVFaNV9oWUNELSAtM09OSFNyMldKOVg4QTB2OGRhWGVBcGVRN1RHeVNlNUNvdE8xT0FyYmttRmVBa3dwYm1WVHUzUzBtaWJ3bGZFNVBHTktWdHRHaElFYVZNM3g5b2I4cnl1RzMweXBkM2NpLXZ0bU9MWF8tdElLSmc2RHFrd1F6QmFaQ0lMbjg5ZjBiYWx0ejJZNUlJRC1JS245djQyQ25wQ1RseTBXMDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="104-ref-">10.4 Ref - アトミックな共有状態<a class="headerlink" href="#104-ref-" title="Permanent link">&para;</a></h3>
<p><strong>ソースファイル</strong>: <code>app/java/src/main/java/ch10/Ref.java</code></p>
<p><strong>Ref</strong> は、複数の並行処理から安全にアクセスできるアトミックな参照です。Java の <code>AtomicReference</code> をラップし、IO モナドと統合しています。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Ref</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="nf">Ref</span><span class="p">(</span><span class="n">A</span><span class="w"> </span><span class="n">initial</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicReference</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">initial</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 初期値で Ref を作成（IO でラップ）</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Ref</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">of</span><span class="p">(</span><span class="n">A</span><span class="w"> </span><span class="n">initial</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">delay</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Ref</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">initial</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 現在の値を取得</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="n">value</span><span class="p">::</span><span class="n">get</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 値を設定</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="n">A</span><span class="w"> </span><span class="n">newValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">effect</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">newValue</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// アトミックに値を更新</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">UnaryOperator</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">effect</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="na">updateAndGet</span><span class="p">(</span><span class="n">f</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="ref">Ref の使用例<a class="headerlink" href="#ref" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// Ref の作成と使用</span>
<span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ref</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">counter</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w">    </span><span class="c1">// アトミックに更新</span>
<span class="w">                        </span><span class="p">.</span><span class="na">andThen</span><span class="p">(</span><span class="n">counter</span><span class="p">.</span><span class="na">get</span><span class="p">())</span><span class="w"> </span><span class="c1">// 現在の値を取得</span>
<span class="w">        </span><span class="p">);</span>

<span class="n">program</span><span class="p">.</span><span class="na">unsafeRun</span><span class="p">();</span><span class="w">  </span><span class="c1">// 3</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI5OHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NDI4cHg7aGVpZ2h0OjI5OHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDQyOCAyOTgiIHdpZHRoPSI0MjhweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIFJlZiA/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9IlJlZiAuLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl9SZWYgLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI4MC44OCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjI0MiIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjczLjI0MDEiIHg9Ijk2LjM4IiB5PSIyNi45OTUxIj5SZWYgJiMxMjM5ODsmIzI1ODA1OyYjMjAzMTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IGNyZWF0ZS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJjcmVhdGUiIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X2NyZWF0ZSI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iODEuMDQ0OSIgeD0iOTIuNDgiIHk9IjQ3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjEuMDQ0OSIgeD0iMTAyLjQ4IiB5PSI2Mi45OTUxIj5SZWYub2YoMCk8L3RleHQ+PC9nPjwhLS1lbnRpdHkgdXBkYXRlLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9InVwZGF0ZSIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDQiIGlkPSJlbnRpdHlfdXBkYXRlIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyMTAuMzYwNCIgeD0iMjcuODIiIHk9IjE0Ni4zIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTkwLjM2MDQiIHg9IjM3LjgyIiB5PSIxNjIuMjk1MSI+Y291bnRlci51cGRhdGUoeCAtJmd0OyB4ICsgMyk8L3RleHQ+PC9nPjwhLS1lbnRpdHkgZ2V0LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImdldCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfZ2V0Ij48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMTIuMjMwNSIgeD0iNzYuODgiIHk9IjI1NC41OCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkyLjIzMDUiIHg9Ijg2Ljg4IiB5PSIyNzAuNTc1MSI+Y291bnRlci5nZXQoKTwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjgiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImVudGl0eV9HTU44Ij48cGF0aCBkPSJNMjcwLjUsMjQ1LjYgTDI3MC41LDI4NS44NjU2IEEwLDAgMCAwIDAgMjcwLjUsMjg1Ljg2NTYgTDQyMS41MDAyLDI4NS44NjU2IEEwLDAgMCAwIDAgNDIxLjUwMDIsMjg1Ljg2NTYgTDQyMS41MDAyLDI1NS42IEw0MTEuNTAwMiwyNDUuNiBMMzEwLjkyLDI0NS42IEwxNTQuMiwxNjkuMDMgTDMwMi45MiwyNDUuNiBMMjcwLjUsMjQ1LjYgQTAsMCAwIDAgMCAyNzAuNSwyNDUuNiIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik00MTEuNTAwMiwyNDUuNiBMNDExLjUwMDIsMjU1LjYgTDQyMS41MDAyLDI1NS42IEw0MTEuNTAwMiwyNDUuNiIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNy45MzcxIiB4PSIyNzYuNSIgeT0iMjYyLjY2NjkiPnVwZGF0ZSAmIzEyMzk5OyYjMTI0NTA7JiMxMjQ4ODsmIzEyNTExOyYjMTI0ODM7JiMxMjQ2Mzs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMwLjAwMDIiIHg9IjI3Ni41IiB5PSIyNzcuNzk5NyI+JiMyMDE4MjsmIzEyMzk4OyYjMjA5NjY7JiMyOTcwMjsmIzEyMzkyOyYjMzE0Nzg7JiMyMTUxMjsmIzEyMzc1OyYjMTIzOTQ7JiMxMjM1Njs8L3RleHQ+PC9nPjwhLS1saW5rIGNyZWF0ZSB0byB1cGRhdGUtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iY3JlYXRlIiBkYXRhLWVudGl0eS0yPSJ1cGRhdGUiIGRhdGEtc291cmNlLWxpbmU9IjgiIGRhdGEtdWlkPSJsbms2IiBpZD0ibGlua19jcmVhdGVfdXBkYXRlIj48cGF0aCBkPSJNMTMzLDY5LjU3IEMxMzMsODguMTkgMTMzLDEyMS4wMyAxMzMsMTM5LjgyIiBmaWxsPSJub25lIiBpZD0iY3JlYXRlLXRvLXVwZGF0ZSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTMzLDE0NS44MiwxMzcsMTM2LjgyLDEzMywxNDAuODIsMTI5LDEzNi44MiwxMzMsMTQ1LjgyIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjYiIHg9IjEzNCIgeT0iMTEyLjM2NjkiPiYjMjAzMTY7JiMyNTEwNDs8L3RleHQ+PC9nPjwhLS1saW5rIHVwZGF0ZSB0byBnZXQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0idXBkYXRlIiBkYXRhLWVudGl0eS0yPSJnZXQiIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJsbms3IiBpZD0ibGlua191cGRhdGVfZ2V0Ij48cGF0aCBkPSJNMTMzLDE2OS4wMyBDMTMzLDE4OS40IDEzMywyMjcuODYgMTMzLDI0OC4yIiBmaWxsPSJub25lIiBpZD0idXBkYXRlLXRvLWdldCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTMzLDI1NC4yLDEzNywyNDUuMiwxMzMsMjQ5LjIsMTI5LDI0NS4yLDEzMywyNTQuMiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI2IiB4PSIxMzQiIHk9IjIxMS42NjY5Ij4mIzI2MzU2OyYjMjYwMzI7PC90ZXh0PjwvZz48IS0tU1JDPVtLb3A5SUNyRExJWjhJU3BDdS04Z0lhcWtJU25CcHFiTEswZkFKTER1dEJaa3NVSlU5dGxkQTJiS1NvS2Q1Z00wWFZOb3FwR0NEOUtLNGVpTGFlakk0cWpJZUxCOS1RTHY5UWI1VWdLNUFLMTFaR2U1TkprNTJXTGoxTUU4TWVXbWNqaHFyMThEWTNJR25TSzVDS3oxNXdXSmVicDFJVzVlX1JFRTJMbkdGYVdBZzFHZV9jcHNiY1ZKRGQzTFNkN2J2R0NiYWw5QklsOXA1VkJKTzFQMURKbmtORi11UVQ3WnZleDdwVkNWRHBTX1JiaEZ6TUp0REEzRmRoT2xVcHdYeE43WllrVWhqcHNUcUY2dVNWaFpuYk1GNnJrdUtsREk1NDE2MFcwMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h4 id="ref_1">Ref の主要メソッド<a class="headerlink" href="#ref_1" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>メソッド</th>
<th>説明</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ref.of(initial)</code></td>
<td>初期値で Ref を作成</td>
<td><code>Ref.of(0)</code></td>
</tr>
<tr>
<td><code>ref.get()</code></td>
<td>現在の値を取得</td>
<td><code>counter.get()</code></td>
</tr>
<tr>
<td><code>ref.set(value)</code></td>
<td>値を設定</td>
<td><code>counter.set(10)</code></td>
</tr>
<tr>
<td><code>ref.update(f)</code></td>
<td>アトミックに更新</td>
<td><code>counter.update(x -&gt; x + 1)</code></td>
</tr>
<tr>
<td><code>ref.modify(f)</code></td>
<td>更新して結果を返す</td>
<td><code>counter.modify(n -&gt; ModifyResult.of(n + 1, n))</code></td>
</tr>
<tr>
<td><code>ref.getAndUpdate(f)</code></td>
<td>古い値を返して更新</td>
<td><code>counter.getAndUpdate(x -&gt; x * 2)</code></td>
</tr>
<tr>
<td><code>ref.updateAndGet(f)</code></td>
<td>更新して新しい値を返す</td>
<td><code>counter.updateAndGet(x -&gt; x * 2)</code></td>
</tr>
</tbody>
</table>
<h4 id="modify">modify の使用例<a class="headerlink" href="#modify" title="Permanent link">&para;</a></h4>
<p><code>modify</code> は値を更新しつつ、何か別の値を返したい場合に便利です。</p>
<div class="highlight"><pre><span></span><code><span class="n">Ref</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ref</span><span class="p">.</span><span class="na">unsafe</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ref</span><span class="p">.</span><span class="na">modify</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">Ref</span><span class="p">.</span><span class="na">ModifyResult</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;was &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span>

<span class="c1">// result: &quot;was 10&quot;</span>
<span class="c1">// ref の値: 11</span>
</code></pre></div>
<h3 id="105-parallelio-">10.5 ParallelIO - 並列実行<a class="headerlink" href="#105-parallelio-" title="Permanent link">&para;</a></h3>
<p><strong>ソースファイル</strong>: <code>app/java/src/main/java/ch10/ParallelIO.java</code></p>
<p><code>IO.sequence</code> は IO を順番に実行しますが、<code>ParallelIO.parSequence</code> は並列に実行します。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ParallelIO</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">Executors</span><span class="p">.</span><span class="na">newVirtualThreadPerTaskExecutor</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// IO のリストを並列に実行</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">parSequence</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ios</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">delay</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 各 IO を CompletableFuture として非同期実行</span>
<span class="w">            </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">List</span><span class="o">&lt;</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">futures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ios</span>
<span class="w">                    </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">io</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(</span><span class="n">io</span><span class="p">::</span><span class="n">unsafeRun</span><span class="p">,</span><span class="w"> </span><span class="n">executor</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">toJavaList</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// すべての完了を待機</span>
<span class="w">            </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">allOf</span><span class="p">(</span><span class="n">futures</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)).</span><span class="na">join</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// 結果を収集</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">ofAll</span><span class="p">(</span><span class="n">futures</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">CompletableFuture</span><span class="p">::</span><span class="n">join</span><span class="p">).</span><span class="na">toList</span><span class="p">());</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjM1N3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6OTIzcHg7aGVpZ2h0OjM1N3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDkyMyAzNTciIHdpZHRoPSI5MjNweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIHNlcXVlbmNlIHZzIHBhclNlcXVlbmNlLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJzZXF1ZW5jZSB2cyBwYXJTZXF1ZW5jZSIgZGF0YS1zb3VyY2UtbGluZT0iMyIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJjbHVzdGVyX3NlcXVlbmNlIHZzIHBhclNlcXVlbmNlIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjMzOS43MyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjQ0MSIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIwNS40NzQ2IiB4PSIxMjkuNzYyNyIgeT0iMjYuOTk1MSI+c2VxdWVuY2UgdnMgcGFyU2VxdWVuY2U8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHNlcS0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0ic2VxIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImNsdXN0ZXJfc2VxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI1Ni43MyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE0NyIgeD0iNDQiIHk9IjYzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzMS4wNzIiIHg9IjUxLjk2NCIgeT0iNzcuOTk1MSI+c2VxdWVuY2UmIzY1Mjg4OyYjMzg5MTg7JiMyNzQyNTsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgcGFyLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwYXIiIGRhdGEtc291cmNlLWxpbmU9IjEyIiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImNsdXN0ZXJfcGFyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE3My4wMiIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE5MCIgeD0iMjMxIiB5PSI2MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTkuMTk1MSIgeD0iMjQ2LjQwMjUiIHk9Ijc3Ljk5NTEiPnBhclNlcXVlbmNlJiM2NTI4ODsmIzIwMDA2OyYjMjEwMTU7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgczEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iczEiIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X3MxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI0NC4wNTU3IiB4PSI4NS45NyIgeT0iMTA2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjQuMDU1NyIgeD0iOTUuOTciIHk9IjEyMS45OTUxIj5JTzE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgczItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iczIiIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5X3MyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI0NC4wNTU3IiB4PSI4NS45NyIgeT0iMTg5LjcyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjQuMDU1NyIgeD0iOTUuOTciIHk9IjIwNS43MTUxIj5JTzI8L3RleHQ+PC9nPjwhLS1lbnRpdHkgczMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iczMiIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5X3MzIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI0NC4wNTU3IiB4PSI4NS45NyIgeT0iMjczLjQzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjQuMDU1NyIgeD0iOTUuOTciIHk9IjI4OS40MjUxIj5JTzM8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcDEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icDEiIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV9wMSI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNDQuMDU1NyIgeD0iMjU0Ljk3IiB5PSIxMDYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNC4wNTU3IiB4PSIyNjQuOTciIHk9IjEyMS45OTUxIj5JTzE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcDItLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icDIiIGRhdGEtc291cmNlLWxpbmU9IjE0IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9wMiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNDQuMDU1NyIgeD0iMzMzLjk3IiB5PSIxMDYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNC4wNTU3IiB4PSIzNDMuOTciIHk9IjEyMS45OTUxIj5JTzI8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcDMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icDMiIGRhdGEtc291cmNlLWxpbmU9IjE1IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9wMyI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNDQuMDU1NyIgeD0iMjU0Ljk3IiB5PSIxODkuNzIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNC4wNTU3IiB4PSIyNjQuOTciIHk9IjIwNS43MTUxIj5JTzM8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHTU4xMyIgZGF0YS1zb3VyY2UtbGluZT0iMjAiIGRhdGEtdWlkPSJlbnQwMDE0IiBpZD0iZW50aXR5X0dNTjEzIj48cGF0aCBkPSJNNDY5LjI2LDE4OC4zIEw0NjkuMjYsMjEzLjQzMjggTDY2Ni43NDM5LDIxMy40MzI4IEw2NjYuNzQzOSwxOTguMyBMNjU2Ljc0MzksMTg4LjMgTDQ2OS4yNiwxODguMyIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik02NTYuNzQzOSwxODguMyBMNjU2Ljc0MzksMTk4LjMgTDY2Ni43NDM5LDE5OC4zIEw2NTYuNzQzOSwxODguMyIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE3Ni40ODM5IiB4PSI0NzUuMjYiIHk9IjIwNS4zNjY5Ij4mIzIxNTEyOyYjMzUzMzY7JiMyNjE3ODsmIzM4MjkxOyA9IElPMSArIElPMiArIElPMzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjE2IiBkYXRhLXNvdXJjZS1saW5lPSIyNCIgZGF0YS11aWQ9ImVudDAwMTciIGlkPSJlbnRpdHlfR01OMTYiPjxwYXRoIGQ9Ik03MDEuOTIsMTg4LjMgTDcwMS45MiwyMTMuNDMyOCBMOTE2LjA4NTYsMjEzLjQzMjggTDkxNi4wODU2LDE5OC4zIEw5MDYuMDg1NiwxODguMyBMNzAxLjkyLDE4OC4zIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTkwNi4wODU2LDE4OC4zIEw5MDYuMDg1NiwxOTguMyBMOTE2LjA4NTYsMTk4LjMgTDkwNi4wODU2LDE4OC4zIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTkzLjE2NTYiIHg9IjcwNy45MiIgeT0iMjA1LjM2NjkiPiYjMjE1MTI7JiMzNTMzNjsmIzI2MTc4OyYjMzgyOTE7ICYjODc3NjsgbWF4KElPMSwgSU8yLCBJTzMpPC90ZXh0PjwvZz48IS0tbGluayBzMSB0byBzMi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJzMSIgZGF0YS1lbnRpdHktMj0iczIiIGRhdGEtc291cmNlLWxpbmU9IjgiIGRhdGEtdWlkPSJsbms3IiBpZD0ibGlua19zMV9zMiI+PHBhdGggZD0iTTEwOCwxMjguNSBDMTA4LDE0NC4xMyAxMDgsMTY3LjYxIDEwOCwxODMuMzQiIGZpbGw9Im5vbmUiIGlkPSJzMS10by1zMiIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTA4LDE4OS4zNCwxMTIsMTgwLjM0LDEwOCwxODQuMzQsMTA0LDE4MC4zNCwxMDgsMTg5LjM0IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIHMyIHRvIHMzLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InMyIiBkYXRhLWVudGl0eS0yPSJzMyIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImxuazgiIGlkPSJsaW5rX3MyX3MzIj48cGF0aCBkPSJNMTA4LDIxMi4yMiBDMTA4LDIyNy44NSAxMDgsMjUxLjMyIDEwOCwyNjcuMDYiIGZpbGw9Im5vbmUiIGlkPSJzMi10by1zMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTA4LDI3My4wNiwxMTIsMjY0LjA2LDEwOCwyNjguMDYsMTA0LDI2NC4wNiwxMDgsMjczLjA2IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIHNlcSB0byBHTU4xMy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJzZXEiIGRhdGEtZW50aXR5LTI9IkdNTjEzIiBkYXRhLXNvdXJjZS1saW5lPSIyMCIgZGF0YS11aWQ9ImxuazE1IiBpZD0ibGlua19zZXFfR01OMTMiPjxwYXRoIGQ9Ik0xOTEuMjE5NSwxMTkuODk5NCBDMTkxLjM5ODUsMTE5LjkzNzQgMTkxLjU4MDIsMTE5Ljk3NiAxOTEuNzY0NywxMjAuMDE1MSBDMTkyLjUwMjUsMTIwLjE3MTcgMTkzLjI4MzcsMTIwLjMzNzUgMTk0LjEwNzEsMTIwLjUxMjIgQzIwMC42OTM2LDEyMS45MTAxIDIwOS45NzYzLDEyMy44ODAyIDIyMS4zMjA4LDEyNi4yODggQzI0NC4wMDk3LDEzMS4xMDM0IDI3NC45NDU2LDEzNy42Njk0IDMwOS4wNTM4LDE0NC45MDg4IEMzNzcuMjcsMTU5LjM4NzUgNDU4LjE3NSwxNzYuNTYgNTExLjE3LDE4Ny44MSIgZmlsbD0ibm9uZSIgaWQ9InNlcS1HTU4xMyIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjwvZz48IS0tbGluayBwYXIgdG8gR01OMTYtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0icGFyIiBkYXRhLWVudGl0eS0yPSJHTU4xNiIgZGF0YS1zb3VyY2UtbGluZT0iMjQiIGRhdGEtdWlkPSJsbmsxOCIgaWQ9ImxpbmtfcGFyX0dNTjE2Ij48cGF0aCBkPSJNNDIxLjQ1MjcsMTE5Ljg5OTQgQzQyMS42MzY4LDExOS45Mzc0IDQyMS44MjM3LDExOS45NzYgNDIyLjAxMzUsMTIwLjAxNTEgQzQyMi43NzI0LDEyMC4xNzE3IDQyMy41NzU5LDEyMC4zMzc1IDQyNC40MjI3LDEyMC41MTIyIEM0MzEuMTk3NSwxMjEuOTEwMSA0NDAuNzQ1MywxMjMuODgwMiA0NTIuNDEzOCwxMjYuMjg4IEM0NzUuNzUwNiwxMzEuMTAzNCA1MDcuNTcsMTM3LjY2OTQgNTQyLjY1MjUsMTQ0LjkwODggQzYxMi44MTc1LDE1OS4zODc1IDY5Ni4wMzUsMTc2LjU2IDc1MC41NSwxODcuODEiIGZpbGw9Im5vbmUiIGlkPSJwYXItR01OMTYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48L2c+PCEtLVNSQz1bS29wOUlDckRMSVo4SVNwQ3UtOGdJYXFrSVNuQnBxYkxLMmZFQkluRHBLakVMSVdoTFlYOEIwZzZTZktLZ2g2ZlVoLWR1LU0yamNUaDVoeFZxd2NhYTVZaTA5RzBnYW5FQjRmSEtGQnFEdUk4NlM4NVoyMDJIZDAxT3VZMENMVW5lT0FraFhyOGdqVzhtWkJjZ2FMbjZQOWhXRE8tc1I3aVFTVHFjQkwwRUduaDJ6MmpCSzJ0alcxYTFUMklsRm9JTDhNYV85QUlfNW81XzNJRzd4WVVKa1h1aVFCWnNTb2NiekNjQXpXZzBDcktxMFFJSGMzSWMyaXJCcUsxZjBqM0J6MFhnN2VWVE5PZXYyUE1RMDFEcTA0UDAyQUNEVTQ2MDAwMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h4 id="_1">並列実行の効果<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">List</span><span class="o">&lt;</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<span class="w">        </span><span class="n">Fiber</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="na">andThen</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
<span class="w">        </span><span class="n">Fiber</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="na">andThen</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
<span class="w">        </span><span class="n">Fiber</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="na">andThen</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="p">);</span>

<span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
<span class="n">ParallelIO</span><span class="p">.</span><span class="na">parSequence</span><span class="p">(</span><span class="n">ios</span><span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span>
<span class="kt">long</span><span class="w"> </span><span class="n">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>

<span class="c1">// 並列なので約100ms（順次なら約300ms）</span>
<span class="n">assertThat</span><span class="p">(</span><span class="n">elapsed</span><span class="p">).</span><span class="na">isLessThan</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</code></pre></div>
<h4 id="partraverse">parTraverse<a class="headerlink" href="#partraverse" title="Permanent link">&para;</a></h4>
<p><code>parTraverse</code> は、リストの各要素に IO を返す関数を適用し、並列に実行します。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">parTraverse</span><span class="p">(</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="p">,</span>
<span class="w">        </span><span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">parSequence</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">f</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// 使用例</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">parTraverse</span><span class="p">(</span>
<span class="w">        </span><span class="n">numbers</span><span class="p">,</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span><span class="w">  </span><span class="c1">// List(2, 4, 6, 8, 10)</span>
</code></pre></div>
<h3 id="106">10.6 チェックイン処理の並行版<a class="headerlink" href="#106" title="Permanent link">&para;</a></h3>
<p>Ref と ParallelIO を組み合わせて、チェックインを並行処理します。</p>
<h4 id="_2">チェックインの保存<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">storeCheckIn</span><span class="p">(</span>
<span class="w">        </span><span class="n">Ref</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">storedCheckIns</span><span class="p">,</span>
<span class="w">        </span><span class="n">City</span><span class="w"> </span><span class="n">city</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">storedCheckIns</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">updateCheckIns</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_3">並行処理版<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">CityStats</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">processCheckInsConcurrent</span><span class="p">(</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">City</span><span class="o">&gt;</span><span class="w"> </span><span class="n">checkIns</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">topN</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Ref</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="n">of</span><span class="p">(</span><span class="n">HashMap</span><span class="p">.</span><span class="na">empty</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">storedCheckIns</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="c1">// すべてのチェックインを並列に処理</span>
<span class="w">                    </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">parTraverse</span><span class="p">(</span><span class="n">checkIns</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                            </span><span class="n">storeCheckIn</span><span class="p">(</span><span class="n">storedCheckIns</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">))</span>
<span class="w">                            </span><span class="p">.</span><span class="na">andThen</span><span class="p">(</span><span class="n">storedCheckIns</span><span class="p">.</span><span class="na">get</span><span class="p">())</span>
<span class="w">                            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">cityCheckIns</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">topCities</span><span class="p">(</span><span class="n">cityCheckIns</span><span class="p">,</span><span class="w"> </span><span class="n">topN</span><span class="p">))</span>
<span class="w">            </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjM3NnB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NjM1cHg7aGVpZ2h0OjM3NnB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDYzNSAzNzYiIHdpZHRoPSI2MzVweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iY2x1c3Rlcl8uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjMwMS41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYxNyIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjI3MS41MDAyIiB5PSIyNi45OTUxIj4mIzIwMDA2OyYjMzQ4OTI7JiMyMDk2NjsmIzI5NzAyOyYjMTIzOTg7JiMyNzA4MzsmIzM2ODk2OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgY2hlY2tpbi0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iY2hlY2tpbiIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX2NoZWNraW4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iODkuMyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjU1MyIgeD0iNDQiIHk9IjYzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIyNjQuNTAwMiIgeT0iNzcuOTk1MSI+JiMxMjQ4MTsmIzEyNDU1OyYjMTI0ODM7JiMxMjQ2MzsmIzEyNDUyOyYjMTI1MzE7JiMyMDk2NjsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgcmVzdWx0LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJyZXN1bHQiIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iY2x1c3Rlcl9yZXN1bHQiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iODkuMjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI0MjIiIHg9IjE3NSIgeT0iMTkyLjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMzU4LjAwMDEiIHk9IjIwNy4yOTUxIj4mIzMyMDgwOyYjMjY1MjQ7JiMyMTQ2MjsmIzI0NDcxOzwvdGV4dD48L2c+PCEtLWVudGl0eSBwYXJUcmF2ZXJzZSA/Pz8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icGFyVHJhdmVyc2UgLi4uLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0iZW50MDAwNCIgaWQ9ImVudGl0eV9wYXJUcmF2ZXJzZSAuLi4uLi4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjI3Ny4xMTk0IiB4PSI2OC40NCIgeT0iMTA2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjU3LjExOTQiIHg9Ijc4LjQ0IiB5PSIxMjEuOTk1MSI+cGFyVHJhdmVyc2UgJiMxMjM5MTsmIzEyNDgxOyYjMTI0NTU7JiMxMjQ4MzsmIzEyNDYzOyYjMTI0NTI7JiMxMjUzMTsmIzEyNDM0OyYjMjAwMDY7JiMyMTAxNTsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tZW50aXR5IFJlZiA/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUmVmIC4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfUmVmIC4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTczLjcxOTIiIHg9IjM4MC4xNCIgeT0iMTA2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTUzLjcxOTIiIHg9IjM5MC4xNCIgeT0iMTIxLjk5NTEiPlJlZiAmIzEyMzk1OyYjMTI0NTA7JiMxMjQ4ODsmIzEyNTExOyYjMTI0ODM7JiMxMjQ2MzsmIzEyMzk1OyYjMjA0NDU7JiMyMzM4NDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVmID8/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iUmVmIC4uLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEwIiBkYXRhLXVpZD0iZW50MDAwNyIgaWQ9ImVudGl0eV9SZWYgLi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTg3LjcxOTEiIHg9IjE5OS4xNCIgeT0iMjM1LjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNjcuNzE5MSIgeD0iMjA5LjE0IiB5PSIyNTEuMjk1MSI+UmVmICYjMTIzNjM7JiMxMjQyNTsmIzEyNDg3OyYjMTI1NDA7JiMxMjQ3OTsmIzEyNDM0OyYjMzU1MDE7JiMxMjQxNTsmIzIxNDYyOyYjMTI0MjY7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfLi4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEzMS45OTk1IiB4PSI0MjIiIHk9IjIzNS4zIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjQzMiIgeT0iMjUxLjI5NTEiPiYjMTI1MjE7JiMxMjUzMTsmIzEyNDYxOyYjMTI1MzE7JiMxMjQ2NDsmIzEyNDM0OyYjMzUzMzY7JiMzMTYzOTs8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHTU4xMCIgZGF0YS1zb3VyY2UtbGluZT0iMTgiIGRhdGEtdWlkPSJlbnQwMDExIiBpZD0iZW50aXR5X0dNTjEwIj48cGF0aCBkPSJNNDEyLjUsMzI5LjU5IEw0MTIuNSwzNjkuODU1NiBBMCwwIDAgMCAwIDQxMi41LDM2OS44NTU2IEw1NjMuNTAwMiwzNjkuODU1NiBBMCwwIDAgMCAwIDU2My41MDAyLDM2OS44NTU2IEw1NjMuNTAwMiwzMzkuNTkgTDU1My41MDAyLDMyOS41OSBMNDkyLDMyOS41OSBMNDg4LDI1Ny45IEw0ODQsMzI5LjU5IEw0MTIuNSwzMjkuNTkgQTAsMCAwIDAgMCA0MTIuNSwzMjkuNTkiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNNTUzLjUwMDIsMzI5LjU5IEw1NTMuNTAwMiwzMzkuNTkgTDU2My41MDAyLDMzOS41OSBMNTUzLjUwMDIsMzI5LjU5IiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMwLjAwMDIiIHg9IjQxOC41IiB5PSIzNDYuNjU2OSI+JiMzNTA3OTsmIzI1OTY4OyYjMTIzOTg7JiMxMjQ4MTsmIzEyNDU1OyYjMTI0ODM7JiMxMjQ2MzsmIzEyNDUyOyYjMTI1MzE7JiMxMjM2NDs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjAwMDEiIHg9IjQxOC41IiB5PSIzNjEuNzg5NyI+JiMyMDAwNjsmIzIxMDE1OyYjMTIzOTU7JiMyMDk2NjsmIzI5NzAyOyYjMTIzNzM7JiMxMjQyODsmIzEyNDI3OzwvdGV4dD48L2c+PCEtLWxpbmsgY2hlY2tpbiB0byByZXN1bHQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iY2hlY2tpbiIgZGF0YS1lbnRpdHktMj0icmVzdWx0IiBkYXRhLXNvdXJjZS1saW5lPSIxNSIgZGF0YS11aWQ9ImxuazkiIGlkPSJsaW5rX2NoZWNraW5fcmVzdWx0Ij48cGF0aCBkPSJNNTg5LDE1Mi40ODcyIEM1ODksMTUyLjkyMDUgNTg5LDE1My4zNTYgNTg5LDE1My43OTM3IEM1ODksMTU1LjU0NDYgNTg5LDE1Ny4zMzA5IDU4OSwxNTkuMTQ1NCBDNTg5LDE2Ni40MDMzIDU4OSwxNzQuMTEzMSA1ODksMTgxLjgyMjUgQzU4OSwxODMuNzQ5OCA1ODksMTg1LjY3NzIgNTg5LDE4Ny41OTc0IEM1ODksMTg4LjU1NzUgNTg5LDE4OS41MTU4IDU4OSwxOTAuNDcxNSBDNTg5LDE5MC45NDkzIDU4OSwxOTEuNDI2NSA1ODksMTkxLjkwMjkgQzU4OSwxOTIuMDIyIDU4OSwxODYuMTQxMSA1ODksMTg2LjI2MDEiIGZpbGw9Im5vbmUiIGlkPSJjaGVja2luLXRvLXJlc3VsdCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iNTg5LDE5Mi4yNjAxLDU5MywxODMuMjYwMSw1ODksMTg3LjI2MDEsNTg1LDE4My4yNjAxLDU4OSwxOTIuMjYwMSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtSUDNCSWlEMDY4TnR5bkhaemRxNTdxOXlXUFlFamZXY1BKQXc0UzZQMEhERG0yQktrRjFFUVRJSWpZMjIycDRGeXBTTnR5QjlKSEpUX0FqcHBkVkVseVB3UDQzbXFESng1YUFLNjRvdFRhbzJqVE5SakJXRktkVVFadXcxcHhGOF9wb3dxXzMxSm1yODNZODJBSzRpRzRuMGxqSHczVWlFRGRoNHNFclJvYzdlajhrcmVLdXRnUnZGZzRDbXlFWWw1eUl2V2dQVXM4R3FsV3NvaFZHcDQweVdGUDJ0Wk9ORkxpYnI2Ynpnd0YxTnhfbnJiRHJTZk1TTndLVE96UTM0c0pGUFR1cXdwV1RuMGo4NS1HdVlLVTNZRUdRVUExVThxbk9DeWdiZzVMVHRNUWVVbE5tVWJhSjVSRlRyRWtpRDBvN0JQV0hsc09wUDBySEN0Nm95TEFfeFBvYUZLM3JMcE1YVkYwT0hXRjBIaVJndXBGYTJdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="107-partuple-parmap">10.7 parTuple と parMap<a class="headerlink" href="#107-partuple-parmap" title="Permanent link">&para;</a></h3>
<p>複数の IO を並列に実行して結果を組み合わせる便利なメソッドです。</p>
<h4 id="partuple2-partuple3">parTuple2 / parTuple3<a class="headerlink" href="#partuple2-partuple3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// 2つの IO を並列実行し、タプルで返す</span>
<span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">parTuple2</span><span class="p">(</span>
<span class="w">        </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span>
<span class="w">        </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">)</span>
<span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span>

<span class="c1">// result._1(): 42</span>
<span class="c1">// result._2(): &quot;hello&quot;</span>

<span class="c1">// 3つの IO も同様</span>
<span class="kd">var</span><span class="w"> </span><span class="n">result3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">parTuple3</span><span class="p">(</span>
<span class="w">        </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="w">        </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="s">&quot;two&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>
<span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span>
</code></pre></div>
<h4 id="parmap2">parMap2<a class="headerlink" href="#parmap2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// 2つの IO を並列実行して結果を結合</span>
<span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">parMap2</span><span class="p">(</span>
<span class="w">        </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
<span class="w">        </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<span class="w">        </span><span class="n">Integer</span><span class="p">::</span><span class="n">sum</span>
<span class="p">);</span>

<span class="n">result</span><span class="p">.</span><span class="na">unsafeRun</span><span class="p">();</span><span class="w">  </span><span class="c1">// 30</span>
</code></pre></div>
<h3 id="108-race-timeout">10.8 race と timeout<a class="headerlink" href="#108-race-timeout" title="Permanent link">&para;</a></h3>
<h4 id="race-">race - 競争<a class="headerlink" href="#race-" title="Permanent link">&para;</a></h4>
<p>2つの IO を並列に実行し、最初に完了した方の結果を返します。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">race</span><span class="p">(</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">delay</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(</span><span class="n">io1</span><span class="p">::</span><span class="n">unsafeRun</span><span class="p">,</span><span class="w"> </span><span class="n">executor</span><span class="p">);</span>
<span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(</span><span class="n">io2</span><span class="p">::</span><span class="n">unsafeRun</span><span class="p">,</span><span class="w"> </span><span class="n">executor</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">anyOf</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="n">f2</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">thenApply</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">f1</span><span class="p">.</span><span class="na">cancel</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">                    </span><span class="n">f2</span><span class="p">.</span><span class="na">cancel</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">                    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="n">A</span><span class="w"> </span><span class="n">typedResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">typedResult</span><span class="p">;</span>
<span class="w">                </span><span class="p">})</span>
<span class="w">                </span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// 使用例</span>
<span class="n">IO</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">slow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fiber</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="na">andThen</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="s">&quot;slow&quot;</span><span class="p">));</span>
<span class="n">IO</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fiber</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">50</span><span class="p">).</span><span class="na">andThen</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="s">&quot;fast&quot;</span><span class="p">));</span>

<span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">race</span><span class="p">(</span><span class="n">slow</span><span class="p">,</span><span class="w"> </span><span class="n">fast</span><span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span>
<span class="c1">// result: &quot;fast&quot;</span>
</code></pre></div>
<h4 id="timeout-">timeout - タイムアウト<a class="headerlink" href="#timeout-" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Option</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">timeout</span><span class="p">(</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">millis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">delay</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(</span><span class="n">action</span><span class="p">::</span><span class="n">unsafeRun</span><span class="p">,</span><span class="w"> </span><span class="n">executor</span><span class="p">);</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">A</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">future</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">millis</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Option</span><span class="p">.</span><span class="na">some</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">TimeoutException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">future</span><span class="p">.</span><span class="na">cancel</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Option</span><span class="p">.</span><span class="na">none</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// 使用例</span>
<span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fiber</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">50</span><span class="p">).</span><span class="na">andThen</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">42</span><span class="p">));</span>
<span class="n">Option</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">timeout</span><span class="p">(</span><span class="n">fast</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span>
<span class="c1">// result1: Some(42)</span>

<span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">slow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fiber</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="na">andThen</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">42</span><span class="p">));</span>
<span class="n">Option</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">timeout</span><span class="p">(</span><span class="n">slow</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span>
<span class="c1">// result2: None</span>
</code></pre></div>
<h3 id="109-fiber-">10.9 Fiber - 軽量スレッド<a class="headerlink" href="#109-fiber-" title="Permanent link">&para;</a></h3>
<p><strong>ソースファイル</strong>: <code>app/java/src/main/java/ch10/Fiber.java</code></p>
<p><strong>Fiber</strong> は、IO の実行をバックグラウンドで行う軽量な実行単位です。Java 21 の仮想スレッド（Virtual Thread）を活用しています。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI0MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzYzcHg7aGVpZ2h0OjI0MHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc2MyAyNDAiIHdpZHRoPSI3NjNweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIFRocmVhZCB2cyBGaWJlci0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iVGhyZWFkIHZzIEZpYmVyIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfVGhyZWFkIHZzIEZpYmVyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyMi41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijc0NSIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyMy4zNzUiIHg9IjMyMi44MTI1IiB5PSIyNi45OTUxIj5UaHJlYWQgdnMgRmliZXI8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHRocmVhZC0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0idGhyZWFkIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImNsdXN0ZXJfdGhyZWFkIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE1NS41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjMzNSIgeD0iMzYiIHk9IjU1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgyLjI0MzIiIHg9IjE2Mi4zNzg0IiB5PSI2OS45OTUxIj5PUyBUaHJlYWQ8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIGZpYmVyLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJmaWJlciIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJlbnQwMDA3IiBpZD0iY2x1c3Rlcl9maWJlciI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIxNTUuNTkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIzMzgiIHg9IjM5NSIgeT0iNTUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTcyLjE1NjMiIHg9IjQ3Ny45MjE5IiB5PSI2OS45OTUxIj5GaWJlciAoVmlydHVhbCBUaHJlYWQpPC90ZXh0PjwvZz48IS0tZW50aXR5ID8/P01CPz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi5NQi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5Xy4uLk1CLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTgxLjY4MyIgeD0iNTIuMTYiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTYxLjY4MyIgeD0iNjIuMTYiIHk9IjEwNS45OTUxIj4mIzM3MzI1OyYjMTIzNTY7JiM2NTI4ODtNQiYjMjEzMzY7JiMyMDMwMTsmIzEyMzk4OyYjMTI1MTM7JiMxMjUxNDsmIzEyNTIyOyYjNjUyODk7PC90ZXh0PjwvZz48IS0tZW50aXR5IE9TID8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJPUyAuLi4iIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDA1IiBpZD0iZW50aXR5X09TIC4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iODYuMzU2MyIgeD0iMjY4LjgyIiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY2LjM1NjMiIHg9IjI3OC44MiIgeT0iMTA1Ljk5NTEiPk9TICYjMTIzNjQ7JiMzMTY0OTsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5Xy4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExNy45OTk2IiB4PSI4NCIgeT0iMTcyLjI5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iOTQiIHk9IjE4OC4yODUxIj4mIzI1OTY4OyYjMjEzMTU7JiMzMTI0MzsmIzI0MjMwOyYjMTIzNjQ7JiMzODQ4MDsmIzMwMDI4OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz9LQj8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uS0IuLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfLi4uS0IuLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNzguNzg0NSIgeD0iNDEwLjYxIiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1OC43ODQ1IiB4PSI0MjAuNjEiIHk9IjEwNS45OTUxIj4mIzM2NjA1OyYjMTIzNTY7JiM2NTI4ODtLQiYjMjEzMzY7JiMyMDMwMTsmIzEyMzk4OyYjMTI1MTM7JiMxMjUxNDsmIzEyNTIyOyYjNjUyODk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEpWTSA/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iSlZNIC4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTIiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iZW50aXR5X0pWTSAuLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjkyLjIzNTIiIHg9IjYyNC44OCIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Mi4yMzUyIiB4PSI2MzQuODgiIHk9IjEwNS45OTUxIj5KVk0gJiMxMjM2NDsmIzMxNjQ5OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV8uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEwMy45OTk2IiB4PSI0NDgiIHk9IjE3Mi4yOSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjk5OTYiIHg9IjQ1OCIgeT0iMTg4LjI4NTEiPiYjMjU5Njg7JiMzMDMzNDsmIzE5OTc1OyYjMTI0MTg7JiMyMTQ4NzsmIzMzMDIxOzwvdGV4dD48L2c+PCEtLVNSQz1bS29wOUlDckRMSVo4SVNwQ3UtOGdJYXFrSVNuQnBxYkxLMGg5QTRmREo1NGVBclBtb3FuQUJMOUlnNFFNekd6TVcyWEdLYVdpTFlZMWdBdGNJYXVpSWI1R1VqZFUteFludlZzVTNiLWRmeHFwZGttNXlqT3pSYnh1azdkSHUtUEx4X1RxQWE3TDBHcnZ0RFpwVkR0MnZuRlFPNkJGZmN2dXNqbHlWNE50cXJ0Qlc5OGxQcXZ1RmhMN1lRaU1uTXJXNW9iZVg2S01iUEdjdmExVGVXYnNJWGZPMmtRSTV4bHRHYnBZWlR5Yk5jNi1NOXRvVkVRLTlwbFE3cFNyRlVyVl93OXZCeVdUakcwMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h4 id="fiber">Fiber の実装<a class="headerlink" href="#fiber" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Fiber</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">Executors</span><span class="p">.</span><span class="na">newVirtualThreadPerTaskExecutor</span><span class="p">();</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicBoolean</span><span class="w"> </span><span class="n">cancelled</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">task</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// IO をバックグラウンドで起動し、Fiber を返す</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Fiber</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">delay</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">            </span><span class="n">AtomicBoolean</span><span class="w"> </span><span class="n">cancelled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicBoolean</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="w">            </span><span class="n">Future</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cancelled</span><span class="p">.</span><span class="na">get</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">A</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="na">unsafeRun</span><span class="p">();</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cancelled</span><span class="p">.</span><span class="na">get</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">future</span><span class="p">.</span><span class="na">complete</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cancelled</span><span class="p">.</span><span class="na">get</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">future</span><span class="p">.</span><span class="na">completeExceptionally</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">});</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Fiber</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">future</span><span class="p">,</span><span class="w"> </span><span class="n">cancelled</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="fiber_1">Fiber の起動とキャンセル<a class="headerlink" href="#fiber_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// 無限ループする IO をバックグラウンドで起動</span>
<span class="n">Fiber</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fiber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fiber</span><span class="p">.</span><span class="na">startForever</span><span class="p">(</span>
<span class="w">        </span><span class="n">Fiber</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="na">andThen</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="na">effect</span><span class="p">(</span><span class="n">counter</span><span class="p">::</span><span class="n">incrementAndGet</span><span class="p">))</span>
<span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span>

<span class="c1">// しばらく実行</span>
<span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="n">countBefore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="n">assertThat</span><span class="p">(</span><span class="n">countBefore</span><span class="p">).</span><span class="na">isGreaterThan</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// キャンセル</span>
<span class="n">fiber</span><span class="p">.</span><span class="na">cancel</span><span class="p">().</span><span class="na">unsafeRun</span><span class="p">();</span>
<span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="n">countAfter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="c1">// キャンセル後は増加しない</span>
<span class="n">assertThat</span><span class="p">(</span><span class="n">fiber</span><span class="p">.</span><span class="na">isCancelled</span><span class="p">()).</span><span class="na">isTrue</span><span class="p">();</span>
</code></pre></div>
<h4 id="fiber_2">Fiber の主要メソッド<a class="headerlink" href="#fiber_2" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>メソッド</th>
<th>説明</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Fiber.start(io)</code></td>
<td>IO をバックグラウンドで起動</td>
<td><code>Fiber.start(IO.pure(42))</code></td>
</tr>
<tr>
<td><code>Fiber.startForever(io)</code></td>
<td>無限ループで起動</td>
<td><code>Fiber.startForever(process)</code></td>
</tr>
<tr>
<td><code>fiber.join()</code></td>
<td>完了を待機し結果を取得</td>
<td><code>fiber.join().unsafeRun()</code></td>
</tr>
<tr>
<td><code>fiber.cancel()</code></td>
<td>Fiber をキャンセル</td>
<td><code>fiber.cancel().unsafeRun()</code></td>
</tr>
<tr>
<td><code>fiber.isDone()</code></td>
<td>完了したか</td>
<td><code>fiber.isDone()</code></td>
</tr>
<tr>
<td><code>fiber.isCancelled()</code></td>
<td>キャンセルされたか</td>
<td><code>fiber.isCancelled()</code></td>
</tr>
<tr>
<td><code>Fiber.sleep(millis)</code></td>
<td>指定時間スリープ</td>
<td><code>Fiber.sleep(100)</code></td>
</tr>
<tr>
<td><code>Fiber.delay(millis, io)</code></td>
<td>遅延実行</td>
<td><code>Fiber.delay(100, IO.pure(42))</code></td>
</tr>
</tbody>
</table>
<h3 id="1010">10.10 呼び出し元に制御を返す<a class="headerlink" href="#1010" title="Permanent link">&para;</a></h3>
<p>Fiber を使って、呼び出し元にすぐ制御を返しつつバックグラウンドで処理を続ける設計ができます。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">record</span> <span class="nc">ProcessingCheckIns</span><span class="p">(</span>
<span class="w">        </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">CityStats</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">currentRanking</span><span class="p">,</span><span class="w">  </span><span class="c1">// 現在のランキングを取得</span>
<span class="w">        </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stop</span><span class="w">                         </span><span class="c1">// 処理を停止</span>
<span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">ProcessingCheckIns</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">processCheckInsBackground</span><span class="p">(</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">City</span><span class="o">&gt;</span><span class="w"> </span><span class="n">checkIns</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">topN</span><span class="p">,</span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">updateIntervalMillis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Ref</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">City</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="n">of</span><span class="p">(</span><span class="n">HashMap</span><span class="p">.</span><span class="na">empty</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">storedCheckIns</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">Ref</span><span class="p">.</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">CityStats</span><span class="o">&gt;&gt;</span><span class="n">of</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">empty</span><span class="p">())</span>
<span class="w">                            </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">storedRanking</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="c1">// チェックイン処理プログラム</span>
<span class="w">                                </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">checkInsProgram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">traverse</span><span class="p">(</span>
<span class="w">                                        </span><span class="n">checkIns</span><span class="p">,</span>
<span class="w">                                        </span><span class="n">city</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">storeCheckIn</span><span class="p">(</span><span class="n">storedCheckIns</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">)</span>
<span class="w">                                </span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">ignored</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>

<span class="w">                                </span><span class="c1">// ランキング更新プログラム（定期的に実行）</span>
<span class="w">                                </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rankingProgram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">delay</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                    </span><span class="n">updateRanking</span><span class="p">(</span><span class="n">storedCheckIns</span><span class="p">,</span><span class="w"> </span><span class="n">storedRanking</span><span class="p">,</span><span class="w"> </span><span class="n">topN</span><span class="p">)</span>
<span class="w">                                        </span><span class="p">.</span><span class="na">unsafeRun</span><span class="p">();</span>
<span class="w">                                    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">                                </span><span class="p">});</span>

<span class="w">                                </span><span class="c1">// Fiber として起動し、すぐに戻る</span>
<span class="w">                                </span><span class="k">return</span><span class="w"> </span><span class="n">Fiber</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">checkInsProgram</span><span class="p">)</span>
<span class="w">                                        </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">checkInsFiber</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                                </span><span class="n">Fiber</span><span class="p">.</span><span class="na">startForever</span><span class="p">(</span>
<span class="w">                                                        </span><span class="n">Fiber</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">updateIntervalMillis</span><span class="p">)</span>
<span class="w">                                                                </span><span class="p">.</span><span class="na">andThen</span><span class="p">(</span><span class="n">rankingProgram</span><span class="p">)</span>
<span class="w">                                                </span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">rankingFiber</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                                        </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessingCheckIns</span><span class="p">(</span>
<span class="w">                                                                </span><span class="n">storedRanking</span><span class="p">.</span><span class="na">get</span><span class="p">(),</span>
<span class="w">                                                                </span><span class="n">checkInsFiber</span><span class="p">.</span><span class="na">cancel</span><span class="p">()</span>
<span class="w">                                                                        </span><span class="p">.</span><span class="na">andThen</span><span class="p">(</span><span class="n">rankingFiber</span><span class="p">.</span><span class="na">cancel</span><span class="p">())</span>
<span class="w">                                                        </span><span class="p">)</span>
<span class="w">                                                </span><span class="p">)</span>
<span class="w">                                        </span><span class="p">);</span>
<span class="w">                            </span><span class="p">})</span>
<span class="w">            </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQzNHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NjQ4cHg7aGVpZ2h0OjQzNHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDY0OCA0MzQiIHdpZHRoPSI2NDhweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMyIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJjbHVzdGVyXy4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjQxNi4xOSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYzMCIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjI5Mi4wMDAyIiB5PSIyNi45OTUxIj4mIzIxMDQ2OyYjMjQ0ODE7JiMxMjM5ODsmIzI3OTY5OyYjMTI0Mjg7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBiZy0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iYmciIGRhdGEtc291cmNlLWxpbmU9IjEzIiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImNsdXN0ZXJfYmciPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iODkuMyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM1MiIgeD0iMjU4IiB5PSIzMDYuODkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExLjk5OTUiIHg9IjM3OC4wMDAyIiB5PSIzMjEuODg1MSI+JiMxMjQ5NjsmIzEyNDgzOyYjMTI0NjM7JiMxMjQ2NDsmIzEyNTIxOyYjMTI0NTQ7JiMxMjUzMTsmIzEyNDg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSBjYWxsLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImNhbGwiIGRhdGEtc291cmNlLWxpbmU9IjQiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iZW50aXR5X2NhbGwiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjI4MS43NDc4IiB4PSI2Mi4xMyIgeT0iNDciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNjEuNzQ3OCIgeD0iNzIuMTMiIHk9IjYyLjk5NTEiPnByb2Nlc3NDaGVja0luc0JhY2tncm91bmQgJiMyMTYyODsmIzEyNDAzOyYjMjA5ODY7JiMxMjM3NTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgaW5pdC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJpbml0IiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0iZW50MDAwNCIgaWQ9ImVudGl0eV9pbml0Ij48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxMDMuNzE5NSIgeD0iMTUxLjE0IiB5PSIxMzAuMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjcxOTUiIHg9IjE2MS4xNCIgeT0iMTQ2LjI5NTEiPlJlZiAmIzEyMzk4OyYjMjEwMjE7JiMyNjM5OTsmIzIxMjcwOzwvdGV4dD48L2c+PCEtLWVudGl0eSBzdGFydC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJzdGFydCIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfc3RhcnQiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEwMS42NDgzIiB4PSIxNTIuMTgiIHk9IjIxMy42Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODEuNjQ4MyIgeD0iMTYyLjE4IiB5PSIyMjkuNTk1MSI+RmliZXIgJiMxMjM5ODsmIzM2MjE1OyYjMjEyMDU7PC90ZXh0PjwvZz48IS0tZW50aXR5IHJldHVybi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJyZXR1cm4iIGRhdGEtc291cmNlLWxpbmU9IjciIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5X3JldHVybiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMjA1LjEyMzgiIHg9IjI4LjQ0IiB5PSIzNDkuODkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxODUuMTIzOCIgeD0iMzguNDQiIHk9IjM2NS44ODUxIj5Qcm9jZXNzaW5nQ2hlY2tJbnMgJiMxMjQzNDsmIzM2ODIwOyYjMTIzNzc7PC90ZXh0PjwvZz48IS0tZW50aXR5IGNoZWNraW4tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iY2hlY2tpbiIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGRhdGEtdWlkPSJlbnQwMDExIiBpZD0iZW50aXR5X2NoZWNraW4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEzMS45OTk1IiB4PSIyODIiIHk9IjM0OS44OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSIyOTIiIHk9IjM2NS44ODUxIj4mIzEyNDgxOyYjMTI0NTU7JiMxMjQ4MzsmIzEyNDYzOyYjMTI0NTI7JiMxMjUzMTsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tZW50aXR5IHJhbmtpbmctLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icmFua2luZyIgZGF0YS1zb3VyY2UtbGluZT0iMTUiIGRhdGEtdWlkPSJlbnQwMDEyIiBpZD0iZW50aXR5X3JhbmtpbmciPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExNy45OTk2IiB4PSI0NDkiIHk9IjM0OS44OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3Ljk5OTYiIHg9IjQ1OSIgeT0iMzY1Ljg4NTEiPiYjMTI1MjE7JiMxMjUzMTsmIzEyNDYxOyYjMTI1MzE7JiMxMjQ2NDsmIzI2MzU2OyYjMjYwMzI7PC90ZXh0PjwvZz48IS0tbGluayBjYWxsIHRvIGluaXQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iY2FsbCIgZGF0YS1lbnRpdHktMj0iaW5pdCIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImxuazciIGlkPSJsaW5rX2NhbGxfaW5pdCI+PHBhdGggZD0iTTIwMyw2OS43OCBDMjAzLDg1LjM2IDIwMywxMDguMjQgMjAzLDEyMy44MiIgZmlsbD0ibm9uZSIgaWQ9ImNhbGwtdG8taW5pdCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMjAzLDEyOS44MiwyMDcsMTIwLjgyLDIwMywxMjQuODIsMTk5LDEyMC44MiwyMDMsMTI5LjgyIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIGluaXQgdG8gc3RhcnQtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iaW5pdCIgZGF0YS1lbnRpdHktMj0ic3RhcnQiIGRhdGEtc291cmNlLWxpbmU9IjEwIiBkYXRhLXVpZD0ibG5rOCIgaWQ9ImxpbmtfaW5pdF9zdGFydCI+PHBhdGggZD0iTTIwMywxNTMuMDggQzIwMywxNjguNjYgMjAzLDE5MS41MyAyMDMsMjA3LjExIiBmaWxsPSJub25lIiBpZD0iaW5pdC10by1zdGFydCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMjAzLDIxMy4xMSwyMDcsMjA0LjExLDIwMywyMDguMTEsMTk5LDIwNC4xMSwyMDMsMjEzLjExIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIHN0YXJ0IHRvIHJldHVybi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJzdGFydCIgZGF0YS1lbnRpdHktMj0icmV0dXJuIiBkYXRhLXNvdXJjZS1saW5lPSIxMSIgZGF0YS11aWQ9ImxuazkiIGlkPSJsaW5rX3N0YXJ0X3JldHVybiI+PHBhdGggZD0iTTE5Ny4zNSwyMzYuMjggQzE4My44OSwyNjEuMzkgMTUyLjg5NjcsMzE5LjIxMjkgMTM5LjQ1NjcsMzQ0LjI2MjkiIGZpbGw9Im5vbmUiIGlkPSJzdGFydC10by1yZXR1cm4iIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjEzNi42MiwzNDkuNTUsMTQ0LjM5OTcsMzQzLjUxMDUsMTM4Ljk4MzksMzQ1LjE0NDEsMTM3LjM1MDMsMzM5LjcyODMsMTM2LjYyLDM0OS41NSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY1LjAwMDEiIHg9IjE4MC43MSIgeT0iMjc4Ljk1NjkiPiYjMTIzNzc7JiMxMjM2ODsmIzEyMzk1OyYjMjUxNDc7JiMxMjQyNzs8L3RleHQ+PC9nPjwhLS1saW5rIHN0YXJ0IHRvIGJnLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InN0YXJ0IiBkYXRhLWVudGl0eS0yPSJiZyIgZGF0YS1zb3VyY2UtbGluZT0iMTgiIGRhdGEtdWlkPSJsbmsxMyIgaWQ9Imxpbmtfc3RhcnRfYmciPjxwYXRoIGQ9Ik0yNTQuMjIsMjMzLjA0IEMzNTUuMTEsMjQ3LjYyIDU3MC44NiwyNzkuOSA1ODMsMjkwLjg5IEM1ODUuODYsMjkzLjQ4MjUgNTg4LjMwNTksMjk2LjQ2MTEgNTkwLjM5NjIsMjk5LjY5NDMgQzU5MS40NDEzLDMwMS4zMTA4IDU5Mi4zOTc0LDMwMi45OTExIDU5My4yNzIsMzA0LjcxODUgQzU5My40OTA2LDMwNS4xNTAzIDU5My43MDQxLDMwNS41ODUyIDU5My45MTI3LDMwNi4wMjI3IEM1OTQuMDE3LDMwNi4yNDE0IDU5MS42MDExLDMwMS4wMTUyIDU5MS43MDI5LDMwMS4yMzUyIiBmaWxsPSJub25lIiBpZD0ic3RhcnQtdG8tYmciIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjU5NC4yMjE4LDMwNi42ODA5LDU5NC4wNzM4LDI5Ni44MzMxLDU5Mi4xMjI3LDMwMi4xNDI5LDU4Ni44MTMsMzAwLjE5MTcsNTk0LjIyMTgsMzA2LjY4MDkiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1Mi4wMDAxIiB4PSI1NTIuNTUiIHk9IjI3OC45NTY5Ij4mIzIwMDA2OyYjMzQ4OTI7JiMyMzQ1NTsmIzM0ODkyOzwvdGV4dD48L2c+PCEtLVNSQz1bTEwzMUlpRDA1QnBkQXpSUy1tQ3pVNTBHbDhiX2lEc2tRTVpTYmFyd2FYdnM1c29hRkxKSEliNGYxUWFLaUd0S2dnWmVucG10elpGU1IxaEhveTFadmlzeURuakhaSHZJcjBvbXBubzdLbjlYdldLS2tKZi1xWHpaNEJEcUFLM3NON0phNENvaG82dG8xZzVYazVzWmZCeEJtWXJDd1h2bGo1V0x3VER0NDBsVFVHTG53SThTOGVBM09Cc3JKbS1HQ1RGbkpOZXpxaHMxdk50Y0hzai1ud3pHZFliTW9zVlRsUjFxNjY1VXk3anZnaS15OFhZMUY1anpkZUNPTVo2ZEtPa1I1eDlDTDJmanZrT1BzMmR0aWNaZE44eEE5ZDg4ZVdfWUZldFZHN1JfVEcyZzNxZzFkOERDRzRyMUphMGpHOXRPbThodE1tYWVLejVUOFJxcjhqc1BWRlVGeW5Bb1Vxc3ZYTklRVVNXN1lxYnd6UFdFYWxtMXA4cENTemhFZHBEREkxYnpsS25NdXZ3VVpHbXd4SHkwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="1011-parfold-">10.11 parFold - 並列実行して集約<a class="headerlink" href="#1011-parfold-" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">parFold</span><span class="p">(</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ios</span><span class="p">,</span>
<span class="w">        </span><span class="n">B</span><span class="w"> </span><span class="n">initial</span><span class="p">,</span>
<span class="w">        </span><span class="n">BiFunction</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">parSequence</span><span class="p">(</span><span class="n">ios</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">results</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">results</span><span class="p">.</span><span class="na">foldLeft</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// 使用例</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<span class="w">        </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="w">        </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
<span class="w">        </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
<span class="w">        </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="p">);</span>

<span class="n">Integer</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">parFold</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="p">::</span><span class="n">sum</span><span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span>
<span class="c1">// sum: 10</span>
</code></pre></div>
<h3 id="1012-java-21-virtual-thread">10.12 Java 21 Virtual Thread の活用<a class="headerlink" href="#1012-java-21-virtual-thread" title="Permanent link">&para;</a></h3>
<p>この実装では Java 21 の仮想スレッド（Virtual Thread）を活用しています。</p>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">Executors</span><span class="p">.</span><span class="na">newVirtualThreadPerTaskExecutor</span><span class="p">();</span>
</code></pre></div>
<p>仮想スレッドの利点:</p>
<ul>
<li><strong>軽量</strong>: 従来のプラットフォームスレッドより遥かに軽量</li>
<li><strong>スケーラブル</strong>: 数百万の同時実行が可能</li>
<li><strong>ブロッキング OK</strong>: ブロッキング操作でもスレッドプールを枯渇させない</li>
<li><strong>既存コードと互換</strong>: 既存の Java コードをそのまま使用可能</li>
</ul>
<hr />
<h2 id="_4">まとめ<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="part-v_1">Part V で学んだこと<a class="headerlink" href="#part-v_1" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI0MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6Njc2cHg7aGVpZ2h0OjI0MHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDY3NiAyNDAiIHdpZHRoPSI2NzZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIFBhcnQgVjogPz8/Py0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iUGFydCBWLiAuLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfUGFydCBWLiAuLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyMi41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjY1OCIgeD0iMTIiIHk9IjEyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNS40ODYxIiB4PSIyODMuMjU3IiB5PSIyNi45OTUxIj5QYXJ0IFY6ICYjMjAwMDY7JiMzNDg5MjsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBjaDEwLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJjaDEwIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImNsdXN0ZXJfY2gxMCI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIxNTUuNTkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI2MTAiIHg9IjM2IiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0Ny40ODIzIiB4PSIzMTcuMjU4OSIgeT0iNjkuOTk1MSI+JiMzMTUzMjsxMCYjMzE0NTY7PC90ZXh0PjwvZz48IS0tZW50aXR5IFJlZj8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSZWYuLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5X1JlZi4uLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTY5LjI2OSIgeD0iNTIuMzciIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQ5LjI2OSIgeD0iNjIuMzciIHk9IjEwNS45OTUxIj5SZWYmIzY1Mjg4OyYjMTI0NTA7JiMxMjQ4ODsmIzEyNTExOyYjMTI0ODM7JiMxMjQ2MzsmIzIxNDQyOyYjMjkwMzE7JiM2NTI4OTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUGFyYWxsZWxJTz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJQYXJhbGxlbElPLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwNSIgaWQ9ImVudGl0eV9QYXJhbGxlbElPLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxNzAuNzg2NyIgeD0iMjU2LjYxIiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1MC43ODY3IiB4PSIyNjYuNjEiIHk9IjEwNS45OTUxIj5QYXJhbGxlbElPJiM2NTI4ODsmIzIwMDA2OyYjMjEwMTU7JiMyMzQ1NTsmIzM0ODkyOyYjNjUyODk7PC90ZXh0PjwvZz48IS0tZW50aXR5IEZpYmVyPz8/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iRmliZXIuLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNyIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJlbnRpdHlfRmliZXIuLi4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTY3LjE5NzgiIHg9IjQ2Mi40IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0Ny4xOTc4IiB4PSI0NzIuNCIgeT0iMTA1Ljk5NTEiPkZpYmVyJiM2NTI4ODsmIzM2NjA1OyYjMzczMjc7JiMxMjQ3MzsmIzEyNTI0OyYjMTI0ODM7JiMxMjQ4OTsmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSByYWNlIC8gdGltZW91dC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJyYWNlIC4gdGltZW91dCIgZGF0YS1zb3VyY2UtbGluZT0iOCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJlbnRpdHlfcmFjZSAuIHRpbWVvdXQiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExOC44MjAzIiB4PSI3Ny41OSIgeT0iMTcyLjI5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTguODIwMyIgeD0iODcuNTkiIHk9IjE4OC4yODUxIj5yYWNlIC8gdGltZW91dDwvdGV4dD48L2c+PCEtLWVudGl0eSBWaXJ0dWFsIFRocmVhZC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJWaXJ0dWFsIFRocmVhZCIgZGF0YS1zb3VyY2UtbGluZT0iOSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfVmlydHVhbCBUaHJlYWQiPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjExOS43NjM3IiB4PSIyMzEuMTIiIHk9IjE3Mi4yOSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk5Ljc2MzciIHg9IjI0MS4xMiIgeT0iMTg4LjI4NTEiPlZpcnR1YWwgVGhyZWFkPC90ZXh0PjwvZz48IS0tU1JDPVtKU3N6M1c1MTU4UlhWZ19ZYzFqMHdtOGFBWUFZRnpQWERuYV82UUNJcEt4T3RLSDJmX0hKS0RaRzRicERzMm9MTXAwSWFjdEZ6LUl5NlViR1h3M0ZxVXJRYlkxUk9oVkQyTFc1WE9IdzBIeGR0TkNwWV9yVGlmV282QUw5NGFOdk43OU9DeTAxczR1LVBzT1JISERPYkxobE13MnpoTFExTFlramJGUEV5VG5COWxsdEJNR19QSEI4RVY1SXNNM0pZT0RiVjVvUE1pZUt0R085Q3AtbHp2U19yenY1Zy1aeEplS2Y5RDBjbzg5cUV6R1JvbC1yeFdldkgwdXJIbjBzY0pNc25YeTBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_5">主要コンポーネント<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ref&lt;A&gt;</code></td>
<td>スレッドセーフな共有状態</td>
</tr>
<tr>
<td><code>ParallelIO.parSequence</code></td>
<td>IO のリストを並列実行</td>
</tr>
<tr>
<td><code>ParallelIO.parTraverse</code></td>
<td>リストに関数を適用して並列実行</td>
</tr>
<tr>
<td><code>ParallelIO.race</code></td>
<td>最初に完了した方を返す</td>
</tr>
<tr>
<td><code>ParallelIO.timeout</code></td>
<td>タイムアウト付き実行</td>
</tr>
<tr>
<td><code>Fiber</code></td>
<td>軽量な実行単位</td>
</tr>
<tr>
<td><code>fiber.start</code></td>
<td>Fiber をバックグラウンドで起動</td>
</tr>
<tr>
<td><code>fiber.cancel</code></td>
<td>Fiber をキャンセル</td>
</tr>
</tbody>
</table>
<h3 id="_6">キーポイント<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Ref</strong>: <code>AtomicReference</code> をラップし、IO モナドと統合したアトミックな参照</li>
<li><strong>parSequence</strong>: IO のリストを並列実行して結果を集約</li>
<li><strong>Fiber</strong>: Java 21 の仮想スレッドを活用した軽量な実行単位</li>
<li><strong>start</strong>: Fiber をバックグラウンドで起動し、すぐに制御を返す</li>
<li><strong>race</strong>: 2つの IO を競争させ、最初に完了した方を採用</li>
<li><strong>timeout</strong>: 指定時間内に完了しなければ None を返す</li>
</ol>
<h3 id="_7">設計パターン<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjI0MHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTYzN3B4O2hlaWdodDoyNDBweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxNjM3IDI0MCIgd2lkdGg9IjE2MzdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMyIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJjbHVzdGVyXy4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyMi41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE2MTkiIHg9IjEyIiB5PSIxMiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNzQ0LjUwMDMiIHk9IjI2Ljk5NTEiPiYjMjAwMDY7JiMzNDg5MjsmIzIwOTY2OyYjMjk3MDI7JiMxMjM5ODsmIzM1MzczOyYjMzUzMzY7JiMxMjQ5NzsmIzEyNDc5OyYjMTI1NDA7JiMxMjUzMTs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHAxLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJwMSIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJjbHVzdGVyX3AxIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE1NS41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjQzMyIgeD0iMzYiIHk9IjU1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzMi4yMTM0IiB4PSIxODYuMzkzMyIgeT0iNjkuOTk1MSI+JiMxMjQ5NzsmIzEyNDc5OyYjMTI1NDA7JiMxMjUzMTsxOiAmIzIwMDA2OyYjMjEwMTU7JiMzODU5ODsmIzMyMDA0OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgcDItLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InAyIiBkYXRhLXNvdXJjZS1saW5lPSIxMCIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJjbHVzdGVyX3AyIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjczLjI5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNDE1IiB4PSI0OTMiIHk9IjU1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzMi4yMTM0IiB4PSI2MzQuMzkzMyIgeT0iNjkuOTk1MSI+JiMxMjQ5NzsmIzEyNDc5OyYjMTI1NDA7JiMxMjUzMTsyOiAmIzIwODQ5OyYjMjYzNzc7JiMyOTM2NjsmIzI0OTA3OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgcDMtLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InAzIiBkYXRhLXNvdXJjZS1saW5lPSIxNSIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJjbHVzdGVyX3AzIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjE1NS41OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjI5NSIgeD0iOTMyIiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMTYuMjEzIiB4PSI5NzEuMzkzNSIgeT0iNjkuOTk1MSI+JiMxMjQ5NzsmIzEyNDc5OyYjMTI1NDA7JiMxMjUzMTszOiAmIzEyNDk2OyYjMTI0ODM7JiMxMjQ2MzsmIzEyNDY0OyYjMTI1MjE7JiMxMjQ1NDsmIzEyNTMxOyYjMTI0ODk7JiMyMDk2NjsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgcDQtLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InA0IiBkYXRhLXNvdXJjZS1saW5lPSIyMSIgZGF0YS11aWQ9ImVudDAwMTQiIGlkPSJjbHVzdGVyX3A0Ij48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjczLjI5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMzU2IiB4PSIxMjUxIiB5PSI1NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOTMuMzI2NCIgeD0iMTMzMi4zMzY4IiB5PSI2OS45OTUxIj4mIzEyNDk3OyYjMTI0Nzk7JiMxMjU0MDsmIzEyNTMxOzQ6ICYjMzE0Nzg7JiMyMDEwNTsvJiMxMjQ3OTsmIzEyNDUyOyYjMTI1MTI7JiMxMjQ1MDsmIzEyNDU0OyYjMTI0ODg7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/PyBJTyA/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4gSU8gLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5Xy4uLiBJTyAuLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTU2LjA0ODMiIHg9IjUxLjk4IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzNi4wNDgzIiB4PSI2MS45OCIgeT0iMTA1Ljk5NTEiPiYjMzUwNzk7JiMyNTk2ODsmIzEyMzk4OyBJTyAmIzEyNDM0OyYjMjAwMDY7JiMyMTAxNTsmIzIzNDU1OyYjMzQ4OTI7PC90ZXh0PjwvZz48IS0tZW50aXR5IHBhclNlcXVlbmNlIC8gcGFyVHJhdmVyc2UtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icGFyU2VxdWVuY2UgLiBwYXJUcmF2ZXJzZSIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfcGFyU2VxdWVuY2UgLiBwYXJUcmF2ZXJzZSI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMjEwLjU2NTQiIHg9IjI0Mi43MiIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOTAuNTY1NCIgeD0iMjUyLjcyIiB5PSIxMDUuOTk1MSI+cGFyU2VxdWVuY2UgLyBwYXJUcmF2ZXJzZTwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNyIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJlbnRpdHlfLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijg5Ljk5OTciIHg9Ijg1IiB5PSIxNzIuMjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSI5NSIgeT0iMTg4LjI4NTEiPiYjMzIwODA7JiMyNjUyNDsmIzEyNDM0OyYjMzg1OTg7JiMzMjAwNDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgUmVmID8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJSZWYgLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMSIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfUmVmIC4uLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTMxLjcxOTQiIHg9IjUwOS4xNCIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEuNzE5NCIgeD0iNTE5LjE0IiB5PSIxMDUuOTk1MSI+UmVmICYjMTIzOTE7JiMyOTM2NjsmIzI0OTA3OyYjMTI0MzQ7JiMyMDg0OTsmIzI2Mzc3OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTIiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iZW50aXR5Xy4uLi4uLi4uLi4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIyMTUuOTk5MSIgeD0iNjc2IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE5NS45OTkxIiB4PSI2ODYiIHk9IjEwNS45OTUxIj4mIzM1MDc5OyYjMjU5Njg7JiMxMjM5ODsmIzIwOTY2OyYjMjk3MDI7JiMxMjM2NDsmIzEyNDUwOyYjMTI0ODg7JiMxMjUxMTsmIzEyNDgzOyYjMTI0NjM7JiMxMjM5NTsmIzI2MzU2OyYjMjYwMzI7PC90ZXh0PjwvZz48IS0tZW50aXR5IEZpYmVyLnN0YXJ0ID8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJGaWJlci5zdGFydCAuLi4iIGRhdGEtc291cmNlLWxpbmU9IjE2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9GaWJlci5zdGFydCAuLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEzOC43MDU5IiB4PSI5NDcuNjUiIHk9IjkwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IlZlcmRhbmEiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTE4LjcwNTkiIHg9Ijk1Ny42NSIgeT0iMTA1Ljk5NTEiPkZpYmVyLnN0YXJ0ICYjMTIzOTE7JiMzNjIxNTsmIzIxMjA1OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTciIGRhdGEtdWlkPSJlbnQwMDEyIiBpZD0iZW50aXR5Xy4uLi4uIj48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjIyLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI4OS45OTk3IiB4PSIxMTIxIiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjExMzEiIHk9IjEwNS45OTUxIj4mIzIxMDQ2OyYjMjQ0ODE7JiMxMjQzNDsmIzM2ODIwOyYjMTIzNzc7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/Pz8vPz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTgiIGRhdGEtdWlkPSJlbnQwMDEzIiBpZD0iZW50aXR5Xy4uLi4uLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjE1MC43MTYyIiB4PSI5NDcuNjQiIHk9IjE3Mi4yOSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzMC43MTYyIiB4PSI5NTcuNjQiIHk9IjE4OC4yODUxIj4mIzI0NDYwOyYjMTIzOTE7JiMzMjA4MDsmIzI2NTI0OyYjMTI0MzQ7JiMyMTQ2MjsmIzI0NDcxOy8mIzIwNTcyOyYjMjc0OTA7PC90ZXh0PjwvZz48IS0tZW50aXR5IHJhY2UgPz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9InJhY2UgLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIyMiIgZGF0YS11aWQ9ImVudDAwMTUiIGlkPSJlbnRpdHlfcmFjZSAuLi4uLi4iPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjIuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjEzOS4wOTUzIiB4PSIxMjY3LjQ1IiB5PSI5MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJWZXJkYW5hIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExOS4wOTUzIiB4PSIxMjc3LjQ1IiB5PSIxMDUuOTk1MSI+cmFjZSAmIzEyMzkxOyYjMjYzNjg7JiMzNjg5NTsmIzEyNDM0OyYjMjU1MDU7JiMyOTk5Mjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgdGltZW91dCA/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJ0aW1lb3V0IC4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIyMyIgZGF0YS11aWQ9ImVudDAwMTYiIGlkPSJlbnRpdHlfdGltZW91dCAuLi4uLiI+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyMi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTQ5LjAwNzUiIHg9IjE0NDEuNSIgeT0iOTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iVmVyZGFuYSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjkuMDA3NSIgeD0iMTQ1MS41IiB5PSIxMDUuOTk1MSI+dGltZW91dCAmIzEyMzkxOyYjMjYxNzg7JiMzODI5MTsmIzIxMDQ2OyYjMzg0ODA7PC90ZXh0PjwvZz48IS0tU1JDPVtWUDdWSVc5MTVDUmxWT2ZmN28zbnB6Sy1HRDFMS0J0MFBiQzlRaFFrdE9KV3hnSWtBTU1iWFlZUDhjUThQZ0dNNFZlbW52YlR0d0JQclhLOXlkQkUtUnhwX1N3UDNVSzRYcDZBWGdIV25FTUlTSzJIOGlTWFo4SlBQemppdjZjY1JISkllRlJESmlfaXc0MWtHUGkyLUdSb0JnMkJMVnJnb29DWVJnVndteG9RRGVRTjBmOVlBRWhYLWUwYTdvQjFSNkxPUVMyN2VrcVQxRGdUaFFOekVXeUs1ZmdlOUVfWGlwWUUxMzFvOF94UWJ3THBCQ1VtOHAxNjFWUE91LXY1WFlsWC1XXzdBb0FRVWNFcmg3NHJQZ2NTWlVEVHVrcFk4bUpnaXp0YTBzc2p5MVZNRUtLVWoyT0dWZWV3NDBCUUF3WFRMWHNveWMwVFdhejRHMGVCV3BPMHlXOVFjelUxUEVzdkRmSGwyUktMRkMzb1Bhb0hQQ00yQ3FTVkQ1VG9jQVctZmZDNkhwTWRITDBob184YVItdFg3OFJVYkVkYW1LdEw2a2lycnk3dkhNSHFueEVsaERpZ1FJcVdKelFFNWcxa1NfY05OQkI0RnVJZGk1Zm9kZ3BwNTdSVEM4ZVQxcTQ5WGw1Zl8xVVBMUkh2LVB3WnBZaTVBcHRuMG0wMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h3 id="scala">Scala との比較<a class="headerlink" href="#scala" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>概念</th>
<th>Scala (cats-effect)</th>
<th>Java + Vavr</th>
</tr>
</thead>
<tbody>
<tr>
<td>アトミック参照</td>
<td><code>Ref[IO, A]</code></td>
<td><code>Ref&lt;A&gt;</code> (独自実装)</td>
</tr>
<tr>
<td>並列実行</td>
<td><code>parSequence</code></td>
<td><code>ParallelIO.parSequence</code></td>
</tr>
<tr>
<td>軽量スレッド</td>
<td><code>Fiber[IO, A]</code></td>
<td><code>Fiber&lt;A&gt;</code> (Virtual Thread)</td>
</tr>
<tr>
<td>Fiber 起動</td>
<td><code>io.start</code></td>
<td><code>Fiber.start(io)</code></td>
</tr>
<tr>
<td>キャンセル</td>
<td><code>fiber.cancel</code></td>
<td><code>fiber.cancel()</code></td>
</tr>
<tr>
<td>競争</td>
<td><code>IO.race(io1, io2)</code></td>
<td><code>ParallelIO.race(io1, io2)</code></td>
</tr>
<tr>
<td>タイムアウト</td>
<td><code>io.timeout(duration)</code></td>
<td><code>ParallelIO.timeout(io, millis)</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_8">演習問題<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<h3 id="1-ref">問題 1: Ref の基本<a class="headerlink" href="#1-ref" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。カウンターを 0 から始めて、3回インクリメントした結果を返します。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">incrementThreeTimes</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ???</span>
<span class="p">}</span>

<span class="c1">// 期待される動作</span>
<span class="n">incrementThreeTimes</span><span class="p">().</span><span class="na">unsafeRun</span><span class="p">();</span><span class="w">  </span><span class="c1">// 3</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">incrementThreeTimes</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Ref</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">counter</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                            </span><span class="p">.</span><span class="na">andThen</span><span class="p">(</span><span class="n">counter</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">                            </span><span class="p">.</span><span class="na">andThen</span><span class="p">(</span><span class="n">counter</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">                            </span><span class="p">.</span><span class="na">andThen</span><span class="p">(</span><span class="n">counter</span><span class="p">.</span><span class="na">get</span><span class="p">())</span>
<span class="w">            </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="2">問題 2: 並列実行<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。3つの IO を並列実行し、結果の合計を返します。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">sumParallel</span><span class="p">(</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io2</span><span class="p">,</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ???</span>
<span class="p">}</span>

<span class="c1">// 期待される動作</span>
<span class="n">sumParallel</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">pure</span><span class="p">(</span><span class="mi">3</span><span class="p">)).</span><span class="na">unsafeRun</span><span class="p">();</span><span class="w">  </span><span class="c1">// 6</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">sumParallel</span><span class="p">(</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io2</span><span class="p">,</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">parSequence</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">io2</span><span class="p">,</span><span class="w"> </span><span class="n">io3</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">foldLeft</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="p">::</span><span class="n">sum</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// または parFold を使用</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">sumParallel</span><span class="p">(</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io2</span><span class="p">,</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">io3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">parFold</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">io1</span><span class="p">,</span><span class="w"> </span><span class="n">io2</span><span class="p">,</span><span class="w"> </span><span class="n">io3</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="p">::</span><span class="n">sum</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="3">問題 3: 並行カウント<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。IO のリストを並行実行し、そのうち偶数を返した回数をカウントします。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">countEvens</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ios</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ???</span>
<span class="p">}</span>

<span class="c1">// 使用例</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">IO</span><span class="p">::</span><span class="n">pure</span><span class="p">);</span>
<span class="n">countEvens</span><span class="p">(</span><span class="n">ios</span><span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span><span class="w">  </span><span class="c1">// 50</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">countEvens</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ios</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Ref</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">parTraverse</span><span class="p">(</span><span class="n">ios</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                            </span><span class="n">io</span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                    </span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                                            </span><span class="o">?</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                                            </span><span class="p">:</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="na">unit</span><span class="p">()</span>
<span class="w">                            </span><span class="p">)</span>
<span class="w">                    </span><span class="p">).</span><span class="na">andThen</span><span class="p">(</span><span class="n">counter</span><span class="p">.</span><span class="na">get</span><span class="p">())</span>
<span class="w">            </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="4">問題 4: タイムアウト付き実行<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。指定時間後に Fiber をキャンセルし、それまでに蓄積された結果を返します。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">collectFor</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">durationMillis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 100msごとに乱数を生成してリストに追加</span>
<span class="w">    </span><span class="c1">// 指定時間後に停止して結果を返す</span>
<span class="w">    </span><span class="c1">// ???</span>
<span class="p">}</span>

<span class="c1">// 期待される動作</span>
<span class="c1">// 1秒間実行すると約10個の要素が返される</span>
<span class="n">collectFor</span><span class="p">(</span><span class="mi">1000</span><span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">collectFor</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">durationMillis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Ref</span><span class="p">.</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="n">of</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">empty</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">collected</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>

<span class="w">                </span><span class="c1">// 100msごとに乱数を追加するプログラム</span>
<span class="w">                </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fiber</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">andThen</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="na">delay</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>
<span class="w">                        </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">collected</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">n</span><span class="p">)));</span>

<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">Fiber</span><span class="p">.</span><span class="na">startForever</span><span class="p">(</span><span class="n">producer</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">fiber</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                </span><span class="n">Fiber</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">durationMillis</span><span class="p">)</span>
<span class="w">                                        </span><span class="p">.</span><span class="na">andThen</span><span class="p">(</span><span class="n">fiber</span><span class="p">.</span><span class="na">cancel</span><span class="p">())</span>
<span class="w">                                        </span><span class="p">.</span><span class="na">andThen</span><span class="p">(</span><span class="n">collected</span><span class="p">.</span><span class="na">get</span><span class="p">())</span>
<span class="w">                        </span><span class="p">);</span>
<span class="w">            </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h3 id="5">問題 5: 並行マップ更新<a class="headerlink" href="#5" title="Permanent link">&para;</a></h3>
<p>以下のプログラムを実装してください。複数の更新を並行して Map に適用し、最終的な Map を返します。</p>
<div class="highlight"><pre><span></span><code><span class="kd">record</span> <span class="nc">Update</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">applyUpdates</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Update</span><span class="o">&gt;</span><span class="w"> </span><span class="n">updates</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ???</span>
<span class="p">}</span>

<span class="c1">// 期待される動作</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Update</span><span class="o">&gt;</span><span class="w"> </span><span class="n">updates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Update</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Update</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Update</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w">  </span><span class="c1">// &quot;a&quot; を上書き</span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Update</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="p">);</span>
<span class="n">applyUpdates</span><span class="p">(</span><span class="n">updates</span><span class="p">).</span><span class="na">unsafeRun</span><span class="p">();</span><span class="w">  </span><span class="c1">// HashMap(a -&gt; 3, b -&gt; 2, c -&gt; 4)</span>
</code></pre></div>
<details>
<summary>解答</summary>

<div class="highlight"><pre><span></span><code><span class="kd">record</span> <span class="nc">Update</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IO</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">applyUpdates</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Update</span><span class="o">&gt;</span><span class="w"> </span><span class="n">updates</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Ref</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="n">of</span><span class="p">(</span><span class="n">HashMap</span><span class="p">.</span><span class="na">empty</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">mapRef</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">ParallelIO</span><span class="p">.</span><span class="na">parTraverse</span><span class="p">(</span><span class="n">updates</span><span class="p">,</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                            </span><span class="n">mapRef</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">update</span><span class="p">.</span><span class="na">key</span><span class="p">(),</span><span class="w"> </span><span class="n">update</span><span class="p">.</span><span class="na">value</span><span class="p">()))</span>
<span class="w">                    </span><span class="p">).</span><span class="na">andThen</span><span class="p">(</span><span class="n">mapRef</span><span class="p">.</span><span class="na">get</span><span class="p">())</span>
<span class="w">            </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

注意: 並行実行なので、同じキーへの複数の更新がある場合、最終的な値は実行順序に依存します。

</details>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>